# 프로젝트 5: 통합 센서 모니터링 시스템

## 프로젝트 개요

이 프로젝트는 Phase 1~5에서 학습한 모든 지식을 종합하여 **실용적인 환경 모니터링 시스템**을
구축합니다. SHT30 온습도 센서, MQ-2 가스 센서, 릴레이를 ESP32에 연결하고,
WiFi 웹서버를 통해 센서 데이터를 실시간으로 모니터링할 수 있습니다.

가스 농도가 임계값을 초과하면 릴레이가 자동으로 동작하여 환기 팬을 가동하는
**자동 제어 기능**도 포함되어 있습니다.

**난이도:** ★★★★★ (고급)
**예상 소요 시간:** 6~8시간
**선수 지식:** 프로젝트 1~4 완료, WiFi 기초, HTML 기초

---

## 학습 목표

### Phase 1~2 기초 지식 활용
1. **옴의 법칙** - LED 전류 제한 저항 계산
2. **전압 분배** - ADC 입력 범위 매칭
3. **전력 계산** - 시스템 전류 예산 설계

### Phase 3 반도체 지식 활용
4. **트랜지스터 스위칭** - 릴레이 구동 회로
5. **ADC 변환** - 아날로그 센서값 디지털 변환
6. **I2C 통신** - SHT30 센서 데이터 읽기

### Phase 4~5 회로 설계 활용
7. **디커플링 커패시터** - 센서 안정화
8. **풀업/풀다운 저항** - I2C 버스, 버튼 입력
9. **노이즈 필터링** - 이동 평균 필터 적용

### Phase 6 실전 기술
10. **WiFi 네트워크 연결** - STA 모드 또는 AP 모드
11. **웹서버 구현** - HTTP 요청 처리, HTML 응답
12. **JSON API** - 센서 데이터 API 엔드포인트
13. **시스템 통합** - 다중 센서 + 액추에이터 + 통신

---

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                    통합 센서 모니터링 시스템                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐    I2C     ┌──────────────────┐     WiFi         │
│  │  SHT30   │──────────→│                  │←──────────────┐  │
│  │ 온습도    │  SDA/SCL   │                  │               │  │
│  └──────────┘            │                  │     HTTP       │  │
│                          │     ESP32        │  ┌──────────┐  │  │
│  ┌──────────┐    ADC     │   메인 컨트롤러    │  │ 웹브라우저 │  │  │
│  │  MQ-2    │──────────→│                  │→│ (PC/모바일)│  │  │
│  │ 가스센서  │  GPIO34    │                  │  └──────────┘  │  │
│  └──────────┘            │                  │               │  │
│                          │                  │  ┌──────────┐  │  │
│  ┌──────────┐   GPIO     │                  │  │  JSON    │  │  │
│  │  릴레이   │←──────────│                  │→│  API     │  │  │
│  │ (환기팬)  │  GPIO26    │                  │  │ /api/data│  │  │
│  └──────────┘            └──────────────────┘  └──────────┘  │  │
│                                │                              │  │
│                          ┌─────┴─────┐                       │  │
│                          │  내장 LED  │                       │  │
│                          │  GPIO2    │                       │  │
│                          └───────────┘                       │  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  데이터 흐름:                                                    │
│  센서 → ADC/I2C → ESP32 → 판단(임계값 비교) → 릴레이 제어       │
│                         → WiFi → 웹페이지/JSON 응답              │
│                         → 시리얼 → 디버깅 출력                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 필요 부품 목록

| 부품 | 수량 | 규격 | 비고 |
|------|------|------|------|
| ESP32 DevKit V1 | 1 | 30핀 또는 38핀 | WiFi 내장 |
| SHT30 온습도 센서 모듈 | 1 | I2C, 3.3V | 또는 SHT31 |
| MQ-2 가스 센서 모듈 | 1 | 아날로그 출력 | 예열 필요 (24시간 권장) |
| 5V 릴레이 모듈 | 1 | 1채널 | Active LOW 또는 HIGH |
| LED (빨강) | 1 | 5mm | 가스 경고 표시 (선택) |
| 저항 220Ω | 1 | 1/4W | LED 전류 제한 |
| 브레드보드 | 1 | 830홀 | |
| 점퍼 와이어 | 약 20개 | M-M, M-F | |
| USB 케이블 | 1 | Micro-USB | ESP32 전원 및 프로그래밍 |
| DC 12V 팬 (선택) | 1 | 소형 | 릴레이로 제어할 부하 |
| DC 12V 어댑터 (선택) | 1 | 1A 이상 | 팬 전원용 |

---

## 전원 설계

### 전류 예산 계산

시스템의 안정적인 동작을 위해 전류 예산(Current Budget)을 계산합니다.
USB 전원(500mA)으로 동작할 수 있는지 확인합니다.

| 부품 | 전압 | 소비 전류 | 비고 |
|------|------|-----------|------|
| ESP32 (WiFi 활성) | 3.3V | 약 150mA (평균) | 피크 시 300mA 이상 |
| SHT30 센서 | 3.3V | 약 1.5mA (측정 시) | 대기 시 0.2μA |
| MQ-2 센서 히터 | 5V | 약 150mA | 히터 상시 가동 |
| MQ-2 센서 회로 | 5V | 약 5mA | 부하 저항 포함 |
| 릴레이 코일 | 5V | 약 70mA (ON 시) | OFF 시 0mA |
| LED (표시용) | 3.3V | 약 10mA | 220Ω 저항 사용 시 |
| **합계 (최대)** | | **약 387mA** | USB 500mA 이내 |

```
전류 예산 분석:

USB 공급 가능 전류:  500mA
시스템 최대 소비:    387mA
여유 전류:           113mA (22.6%)

→ USB 전원으로 동작 가능하나, 여유가 적음
→ WiFi 전송 피크 시 전류가 순간적으로 증가할 수 있음
→ 안정적인 운용을 위해 5V 2A 어댑터 권장

※ MQ-2 센서의 히터가 전류를 많이 소비합니다.
   센서 예열이 끝난 후에도 히터는 계속 동작합니다.
```

---

## 전체 회로 연결도

```
                         ESP32 DevKit V1
                     ┌─────────────────────┐
                     │                     │
     5V 전원 ────────┤ VIN          GND   ├──── GND 공통
                     │ 3V3          D23   │
                     │ EN           D22   ├──── SHT30 SCL (I2C 클록)
                     │ VP(D36)      TX0   │
                     │ VN(D39)      RX0   │
     MQ-2 AOUT ─────┤ D34          D21   ├──── SHT30 SDA (I2C 데이터)
                     │ D35          D19   │
                     │ D32          D18   │
                     │ D33          D5    │
                     │ D25          D17   │
     릴레이 IN ──────┤ D26          D16   │
                     │ D27          D4    │
                     │ D14          D2    ├──── 내장 LED (상태 표시)
                     │ D12          D15   │
                     │ D13          GND   │
                     │ GND          3V3   │
                     └─────────────────────┘

  [SHT30 온습도 센서]                  [MQ-2 가스 센서]
  ┌──────────────┐                    ┌──────────────┐
  │ VCC ── 3.3V  │                    │ VCC ── 5V    │
  │ GND ── GND   │                    │ GND ── GND   │
  │ SDA ── D21   │                    │ AOUT ── D34  │
  │ SCL ── D22   │                    │ DOUT ── (미사용) │
  │ ADDR ── GND  │ (I2C주소: 0x44)    └──────────────┘
  └──────────────┘

  [릴레이 모듈]                        [부하 연결 (DC 팬 예시)]
  ┌──────────────┐                    ┌──────────────────┐
  │ VCC ── 5V    │                    │ 릴레이 COM ── 12V(+)  │
  │ GND ── GND   │                    │ 릴레이 NO  ── 팬(+)   │
  │ IN  ── D26   │                    │ 팬(-)     ── 12V(-)  │
  └──────────────┘                    └──────────────────────┘

  [I2C 풀업 저항] (센서 모듈에 내장된 경우 생략 가능)
  SDA(D21) ── 4.7KΩ ── 3.3V
  SCL(D22) ── 4.7KΩ ── 3.3V
```

---

## 단계별 구현 가이드

### 단계 1: SHT30 온습도 센서 연결 및 테스트
```
목표: I2C 통신으로 SHT30에서 온도/습도 읽기
핵심: Wire 라이브러리, I2C 주소 확인, 데이터 유효성 검증
```
1. SHT30 모듈의 VCC, GND, SDA, SCL 연결
2. I2C 스캔으로 센서 주소(0x44) 확인
3. 온도/습도 데이터 읽기 테스트
4. 시리얼 모니터에서 측정값 확인

### 단계 2: MQ-2 가스 센서 연결 및 테스트
```
목표: ADC로 MQ-2 아날로그 출력 읽기
핵심: analogRead(), ADC 해상도(12비트), 이동 평균 필터
```
1. MQ-2 모듈의 VCC, GND, AOUT 연결
2. 센서 예열 대기 (최소 2분, 정확도를 위해 24시간 권장)
3. ADC 값 읽기 및 시리얼 출력
4. 이동 평균 필터 적용으로 노이즈 감소 확인
5. 가스(라이터 등) 접근 시 값 변화 관찰

### 단계 3: 릴레이 제어 연결
```
목표: 가스 감지 시 릴레이 자동 동작
핵심: 임계값 설정, 히스테리시스, 안전 타임아웃
```
1. 릴레이 모듈의 VCC, GND, IN 연결
2. 수동 ON/OFF 테스트
3. 가스 농도 임계값 설정 및 자동 제어 구현
4. 히스테리시스(이력) 적용으로 릴레이 떨림 방지

### 단계 4: WiFi 연결
```
목표: ESP32를 WiFi 네트워크에 연결 (또는 AP 모드로 동작)
핵심: WiFi.begin(), WiFi.softAP(), IP 주소 확인
```
1. WiFi SSID와 비밀번호 설정
2. STA 모드(기존 공유기에 연결) 또는 AP 모드(ESP32가 핫스팟) 선택
3. IP 주소 시리얼 출력으로 확인
4. 연결 상태 모니터링 및 재연결 로직

### 단계 5: 웹서버 구현
```
목표: 웹페이지로 센서 데이터 표시 및 릴레이 제어
핵심: WebServer, HTML 내장, JSON API
```
1. 메인 웹페이지 구현 (센서 값 표시, 릴레이 제어 버튼)
2. JSON API 엔드포인트 (`/api/data`) 구현
3. 릴레이 제어 API (`/api/relay?state=on`) 구현
4. 자동 새로고침 (JavaScript fetch 사용)

### 단계 6: 시스템 통합 및 최적화
```
목표: 전체 시스템 안정성 확보 및 최적화
핵심: millis() 기반 타이밍, 에러 핸들링, 상태 머신
```
1. 모든 센서 동시 읽기 테스트
2. 웹서버 + 센서 읽기 동시 동작 확인
3. 장시간 동작 안정성 테스트 (24시간)
4. 에러 처리 및 자동 복구 로직 추가

---

## 웹 인터페이스 설명

### 메인 페이지 (`/`)

웹 브라우저에서 ESP32의 IP 주소로 접속하면 다음 정보를 볼 수 있습니다:

```
┌────────────────────────────────────────────────┐
│           환경 모니터링 시스템                    │
├────────────────────────────────────────────────┤
│                                                │
│  [온도]        25.3 °C                         │
│  [습도]        48.2 %                          │
│  [가스 농도]    312 (ADC 원시값)                  │
│  [가스 상태]    정상                             │
│                                                │
│  [릴레이 상태]  OFF                              │
│  [ ON 버튼 ]  [ OFF 버튼 ]  [ 자동 모드 ]       │
│                                                │
│  마지막 업데이트: 2초 전                          │
│  시스템 가동 시간: 01:23:45                      │
│                                                │
└────────────────────────────────────────────────┘
```

### JSON API 엔드포인트

**GET /api/data**
```json
{
  "temperature": 25.3,
  "humidity": 48.2,
  "gas_raw": 312,
  "gas_alert": false,
  "relay_state": false,
  "relay_mode": "auto",
  "uptime_sec": 5025,
  "wifi_rssi": -45
}
```

**GET /api/relay?state=on**
```json
{
  "success": true,
  "relay_state": true,
  "message": "릴레이가 켜졌습니다"
}
```

**GET /api/relay?state=off**
```json
{
  "success": true,
  "relay_state": false,
  "message": "릴레이가 꺼졌습니다"
}
```

---

## 소프트웨어 동작 흐름

```
┌─────────────┐
│   setup()   │
│  초기화     │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────────────┐
│                    loop() 반복                        │
│                                                      │
│  ┌────────────────────┐     ┌───────────────────┐   │
│  │ 센서 읽기 (2초마다)  │     │  WiFi 상태 확인   │   │
│  │  - SHT30 온/습도    │     │  - 연결 끊김 시   │   │
│  │  - MQ-2 가스 농도   │     │    자동 재연결    │   │
│  └──────────┬─────────┘     └───────────────────┘   │
│             │                                        │
│             ▼                                        │
│  ┌────────────────────┐                              │
│  │ 임계값 비교         │                              │
│  │  가스 > 임계값?     │                              │
│  │  온도 > 임계값?     │                              │
│  └──────────┬─────────┘                              │
│             │                                        │
│        ┌────┴────┐                                   │
│        │         │                                   │
│        ▼         ▼                                   │
│  ┌──────────┐ ┌──────────┐                           │
│  │ 릴레이   │ │ 릴레이   │                           │
│  │ ON (자동)│ │ 유지     │                           │
│  └──────────┘ └──────────┘                           │
│                                                      │
│  ┌────────────────────┐                              │
│  │ 웹 클라이언트 처리   │                              │
│  │  - HTTP 요청 수신   │                              │
│  │  - HTML/JSON 응답   │                              │
│  └────────────────────┘                              │
│                                                      │
│  ┌────────────────────┐                              │
│  │ 시리얼 출력 (디버그) │                              │
│  │  - 센서값 테이블    │                              │
│  └────────────────────┘                              │
│                                                      │
└─────────────────────────────────────────────────────┘
```

---

## 트러블슈팅 가이드

### 문제 1: WiFi에 연결되지 않음
```
증상: 시리얼 모니터에 "WiFi 연결 중..." 메시지가 계속 반복됨

확인 사항:
□ SSID와 비밀번호가 정확한가? (대소문자 구분)
□ 2.4GHz WiFi인가? (ESP32는 5GHz 미지원)
□ 공유기가 켜져 있고 범위 내에 있는가?
□ 공유기의 MAC 필터링이 활성화되어 있지 않은가?

해결 방법:
1. AP 모드로 먼저 테스트 (공유기 불필요)
2. 스마트폰 핫스팟으로 테스트 (2.4GHz 확인)
3. WiFi.disconnect(true) 후 재연결 시도
4. ESP32 리셋 후 재시도
```

### 문제 2: SHT30 센서를 찾을 수 없음
```
증상: "SHT30 초기화 실패" 메시지

확인 사항:
□ SDA(GPIO21)와 SCL(GPIO22) 연결이 올바른가?
□ 3.3V 전원이 공급되고 있는가?
□ ADDR 핀이 GND에 연결되어 있는가? (주소: 0x44)
□ I2C 풀업 저항이 있는가? (모듈 내장 확인)

해결 방법:
1. I2C 스캔 코드로 연결된 장치 확인
2. 멀티미터로 SDA/SCL 전압 확인 (풀업 시 약 3.3V)
3. 점퍼 와이어 교체 (접촉 불량 가능)
4. 4.7KΩ 외부 풀업 저항 추가
```

### 문제 3: MQ-2 센서값이 항상 최대(4095)
```
증상: 가스가 없는데도 ADC 값이 4095로 고정

확인 사항:
□ 센서가 충분히 예열되었는가? (최소 2분, 권장 24시간)
□ AOUT 핀을 올바른 ADC 핀(GPIO34)에 연결했는가?
□ 센서 모듈의 가변 저항(감도 조절)이 적절한가?

해결 방법:
1. 센서 예열 시간 충분히 부여
2. 모듈의 감도 조절 가변저항 반시계 방향으로 회전 (감도 낮춤)
3. 환기가 잘 되는 환경에서 테스트
4. ADC 감쇠(attenuation) 설정 확인
```

### 문제 4: 릴레이가 동작하지 않음
```
증상: 릴레이에서 "딸깍" 소리가 나지 않음

확인 사항:
□ 릴레이 모듈에 5V 전원이 공급되고 있는가?
□ IN 핀이 올바른 GPIO(GPIO26)에 연결되어 있는가?
□ 릴레이 모듈이 Active LOW인지 Active HIGH인지 확인했는가?
□ ESP32 GPIO 출력 전압이 릴레이 트리거에 충분한가?

해결 방법:
1. 릴레이 IN 핀을 직접 GND(Active LOW) 또는 3.3V(Active HIGH)에 연결하여 테스트
2. 코드의 RELAY_ACTIVE_LOW 설정 확인 및 변경
3. 릴레이 VCC를 외부 5V 전원으로 분리 공급
4. GPIO 출력을 LED로 먼저 확인
```

### 문제 5: 웹페이지가 느리거나 응답 없음
```
증상: 브라우저에서 로딩이 매우 느리거나 타임아웃 발생

확인 사항:
□ PC/스마트폰이 ESP32와 같은 네트워크에 있는가?
□ IP 주소가 올바른가? (시리얼 모니터에서 확인)
□ 방화벽이 포트 80을 차단하고 있지 않은가?

해결 방법:
1. AP 모드로 직접 연결하여 테스트
2. ping 명령으로 ESP32 응답 확인
3. HTML 크기 줄이기 (불필요한 내용 제거)
4. 센서 읽기 주기를 늘려 CPU 부하 감소
```

### 문제 6: ESP32가 갑자기 리셋됨
```
증상: 시리얼 모니터에 부팅 메시지가 반복적으로 표시됨

확인 사항:
□ USB 케이블의 전류 공급 능력이 충분한가?
□ 릴레이 동작 시 리셋이 발생하는가? (전원 노이즈)
□ 메모리 부족(스택 오버플로우)이 발생하는가?

해결 방법:
1. 5V 2A 이상의 외부 어댑터 사용
2. 릴레이 전원을 ESP32와 별도로 분리
3. ESP32 VIN에 100μF + 100nF 디커플링 커패시터 추가
4. String 사용을 최소화하고 char 배열 사용
```

---

## 확장 아이디어

### 1. MQTT 프로토콜 연동

```
현재: ESP32 ←→ 웹브라우저 (HTTP, 로컬 네트워크만)
확장: ESP32 → MQTT 브로커 → 클라우드 대시보드

장점:
- 인터넷 어디서든 모니터링 가능
- 여러 ESP32 장치를 하나의 대시보드로 관리
- 실시간 알림 (이메일, 푸시 알림)

필요 라이브러리: PubSubClient
무료 MQTT 브로커: HiveMQ, Mosquitto, EMQX

예시 토픽:
  home/sensor/temperature  → 25.3
  home/sensor/humidity     → 48.2
  home/sensor/gas          → 312
  home/relay/state         → ON/OFF
  home/relay/command       → ON/OFF (수신)
```

### 2. 데이터 로깅 (SD 카드 또는 SPIFFS)

```
현재: 데이터가 메모리에만 존재 (전원 끄면 소실)
확장: SD 카드 또는 SPIFFS에 CSV 형식으로 저장

활용:
- 일/주/월 단위 트렌드 분석
- Python/Excel로 데이터 시각화
- 이상 패턴 감지

저장 형식 예시:
  timestamp,temperature,humidity,gas_raw,relay_state
  1700000000,25.3,48.2,312,0
  1700000002,25.4,48.1,315,0
```

### 3. OTA (Over-The-Air) 업데이트

```
현재: 코드 수정 시 USB 케이블로 업로드 필요
확장: WiFi를 통해 무선으로 펌웨어 업데이트

장점:
- 설치된 장치를 분해하지 않고 업데이트 가능
- 원격지 장치 관리 용이

필요 라이브러리: ArduinoOTA (ESP32 내장)
보안: 비밀번호 설정으로 무단 업데이트 방지
```

### 4. 디스플레이 추가 (OLED/LCD)

```
현재: 센서 데이터를 웹이나 시리얼로만 확인
확장: OLED 디스플레이에 실시간 표시

권장 디스플레이: SSD1306 0.96인치 OLED (I2C)
주의: SHT30과 I2C 버스 공유 (주소 충돌 없음, 0x3C)

표시 내용:
  ┌──────────────┐
  │ 온도: 25.3°C  │
  │ 습도: 48.2%   │
  │ 가스: 312     │
  │ 릴레이: OFF   │
  │ WiFi: -45dBm  │
  └──────────────┘
```

### 5. 다중 센서 노드 (메시 네트워크)

```
현재: ESP32 1대로 1개 지점 모니터링
확장: 여러 ESP32가 메시 네트워크로 연결

구성 예:
  거실 노드 ─┐
  침실 노드 ─┼── 게이트웨이 노드 ── 인터넷 ── 클라우드
  주방 노드 ─┘

필요 라이브러리: painlessMesh
```

### 6. 알림 기능 (이메일/텔레그램)

```
현재: 가스 감지 시 릴레이만 동작
확장: 동시에 이메일이나 텔레그램으로 경고 알림 전송

필요 라이브러리:
- 이메일: ESP_Mail_Client
- 텔레그램: UniversalTelegramBot

알림 조건 예:
- 가스 농도 임계값 초과 시
- 온도/습도 이상 범위 시
- 시스템 오류 발생 시
```

---

## 핵심 정리

```
┌─────────────────────────────────────────────────────────────┐
│                       핵심 정리                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 시스템 통합 설계:                                         │
│     - 전류 예산 계산으로 전원 안정성 확보                       │
│     - 센서, 액추에이터, 통신을 하나의 시스템으로 통합            │
│     - millis() 기반 비차단(non-blocking) 설계로 동시 동작       │
│                                                             │
│  2. 센서 데이터 처리:                                         │
│     - SHT30: I2C 통신, 온도/습도 동시 측정                     │
│     - MQ-2: ADC 읽기, 이동 평균 필터로 노이즈 제거             │
│     - 데이터 유효성 검증 (NaN 체크, 범위 확인)                  │
│                                                             │
│  3. 자동 제어 로직:                                           │
│     - 임계값 기반 릴레이 자동 ON/OFF                           │
│     - 히스테리시스로 릴레이 떨림(채터링) 방지                    │
│     - 안전 타임아웃으로 과동작 방지                             │
│                                                             │
│  4. WiFi 웹서버:                                              │
│     - STA 모드: 기존 네트워크에 연결                           │
│     - AP 모드: ESP32가 직접 핫스팟 생성                        │
│     - HTML 웹페이지: 센서 데이터 표시 + 릴레이 제어             │
│     - JSON API: 외부 프로그램/앱에서 데이터 접근                │
│                                                             │
│  5. 안정성 확보:                                              │
│     - WiFi 자동 재연결                                        │
│     - 센서 에러 처리 (통신 실패 시 기본값 유지)                 │
│     - 디커플링 커패시터로 전원 안정화                           │
│     - Watchdog Timer로 시스템 행 방지 (ESP32 내장)             │
│                                                             │
│  6. Phase 1~5 지식 종합:                                      │
│     - 옴의 법칙 → 저항값 계산 (LED, 풀업)                     │
│     - 커패시터 → 디커플링, 필터링                              │
│     - 트랜지스터 → 릴레이 구동                                │
│     - ADC/DAC → 아날로그 센서 읽기                            │
│     - I2C 통신 → 디지털 센서 읽기                             │
│     - 전원 설계 → 전류 예산, 전압 레벨 매칭                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

*이전 프로젝트: [프로젝트 4 - 릴레이 제어](../project4-relay-control/README.md)*
*Phase 6 개요: [Phase 6 README](../README.md)*
