# 프로젝트 3: I2C 센서 연결 (SHT30 + BMP280)

## 프로젝트 개요

이 프로젝트에서는 I2C(Inter-Integrated Circuit) 프로토콜을 사용하여
SHT30 온습도 센서와 BMP280 기압 센서를 동시에 연결합니다. 하나의 I2C 버스에
두 센서를 병렬로 연결하여 환경 데이터(온도, 습도, 기압, 고도)를 수집합니다.

Adafruit 라이브러리를 활용하여 센서 통신을 간편하게 처리하고,
I2C 주소 스캐닝으로 연결된 장치를 확인하는 방법도 학습합니다.

**난이도:** ★★★☆☆ (중급)
**예상 소요 시간:** 3~4시간
**선수 지식:** 프로젝트 1, 2 완료, I2C 기초 개념

---

## 학습 목표

1. **I2C 프로토콜 이해** - SDA, SCL 신호의 역할과 통신 과정
2. **I2C 주소 개념** - 각 장치의 고유 주소와 주소 스캐닝
3. **풀업 저항 설계** - I2C 버스에 필요한 풀업 저항의 역할과 값 결정
4. **다중 센서 통신** - 같은 I2C 버스에 여러 센서 연결
5. **라이브러리 활용** - Adafruit 센서 라이브러리 설치 및 사용법
6. **환경 데이터 해석** - 온도, 습도, 기압, 고도 데이터의 의미

---

## I2C 프로토콜 설명

### I2C 기본 구조

```
    I2C 버스 구조:

    VCC (3.3V)
     │          │
    R_PU       R_PU      R_PU = 풀업 저항 (4.7KΩ)
     │          │
     ├──────────┼──── SDA (데이터 라인) ────────────────
     │          │          │          │          │
     │          │     ┌────┴───┐ ┌────┴───┐ ┌───┴────┐
     │          │     │ Master │ │ Slave1 │ │ Slave2 │
     │          │     │ (ESP32)│ │ (SHT30)│ │(BMP280)│
     │          │     │        │ │0x44    │ │0x76    │
     │          │     └────┬───┘ └────┬───┘ └───┬────┘
     │          │          │          │          │
     └──────────┼──── SCL (클록 라인) ──────────────────
                │
               GND

    - SDA: Serial Data (양방향 데이터)
    - SCL: Serial Clock (마스터가 생성)
    - 오픈 드레인 구조 → 풀업 저항 필수
```

### I2C 통신 과정

```
    SCL ──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──
          └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘

    SDA ─┐                                                        ┌──
         └─ A6  A5  A4  A3  A2  A1  A0  R/W ACK  D7 D6 ... D0  ─┘

         ↑                              ↑   ↑                    ↑
       START                           R/W  ACK                 STOP
       조건                           비트  비트                 조건

    1. START 조건: SCL=HIGH 상태에서 SDA가 HIGH→LOW
    2. 주소 전송: 7비트 슬레이브 주소 + 1비트 R/W
    3. ACK: 슬레이브가 응답 (SDA를 LOW로 풀다운)
    4. 데이터 전송: 8비트씩 데이터 송수신
    5. STOP 조건: SCL=HIGH 상태에서 SDA가 LOW→HIGH
```

### I2C 주소

```
    SHT30 센서 주소:
    ┌────────────────────────────────────┐
    │  ADDR 핀   │  I2C 주소             │
    │────────────│───────────────────────│
    │  VSS (GND) │  0x44 (기본값)         │
    │  VDD (3.3V)│  0x45                 │
    └────────────────────────────────────┘

    BMP280 센서 주소:
    ┌────────────────────────────────────┐
    │  SDO 핀    │  I2C 주소             │
    │────────────│───────────────────────│
    │  GND       │  0x76 (기본값)         │
    │  VDD (3.3V)│  0x77                 │
    └────────────────────────────────────┘

    두 센서의 기본 주소가 다르므로 (0x44, 0x76)
    하나의 I2C 버스에 동시 연결 가능!
```

---

## 풀업 저항 구성

### 풀업 저항의 역할

```
    풀업 저항이 없는 경우:          풀업 저항이 있는 경우:

    VCC                            VCC
     │                              │
     ×  (연결 안 됨)               R_PU (4.7KΩ)
     │                              │
    ─┼─── SDA                      ─┼─── SDA
     │                              │
    [장치]                         [장치]
     │                              │
    GND                            GND

    I2C는 오픈 드레인 구조:
    - 장치가 LOW를 출력할 수 있음 (GND로 끌어내림)
    - 장치가 HIGH를 출력할 수 없음 (풀업 저항이 필요)
    - 풀업 저항이 SDA/SCL을 기본 HIGH 상태로 유지
```

### 풀업 저항 값 선택

```
    저항값이 너무 작으면 (1KΩ 이하):
    - 전류 소모 증가
    - LOW 출력 시 전류 흡수 능력 초과 가능

    저항값이 너무 크면 (10KΩ 이상):
    - 신호 상승 시간 증가 → 통신 속도 제한
    - 노이즈에 취약

    권장 값:
    ┌──────────────────────────────┐
    │  통신 속도   │  권장 저항값   │
    │──────────────│──────────────│
    │  100kHz      │  4.7KΩ       │
    │  400kHz      │  2.2KΩ       │
    │  1MHz        │  1KΩ         │
    └──────────────────────────────┘

    ※ 대부분의 모듈에 풀업 저항이 내장되어 있습니다.
       두 모듈 모두 내장 풀업이 있으면 외부 풀업은 생략 가능합니다.
       단, 배선이 길거나 통신이 불안정하면 외부 풀업을 추가하세요.
```

---

## 필요 부품 목록

| 부품 | 수량 | 규격 | 비고 |
|------|------|------|------|
| ESP32 DevKit V1 | 1 | | |
| SHT30 센서 모듈 | 1 | I2C 인터페이스 | 주소: 0x44 (기본) |
| BMP280 센서 모듈 | 1 | I2C 인터페이스 | 주소: 0x76 (기본) |
| 저항 4.7KΩ | 2 | 1/4W | I2C 풀업 저항 (모듈에 내장 시 생략 가능) |
| 브레드보드 | 1 | 830홀 | |
| 점퍼 와이어 | 약 10개 | M-M, M-F | |

---

## 회로 연결도

### 전체 회로

```
                        ESP32 DevKit V1
                    ┌─────────────────────┐
                    │                     │
              3.3V ─┤ 3V3          GND   ├──── GND 공통
                    │ EN           D23   │
                    │ VP(D36)      D22   ├──── SCL (I2C 클록)
                    │ VN(D39)      TX0   │
                    │ D34          RX0   │
                    │ D35          D21   ├──── SDA (I2C 데이터)
                    │ D32          D19   │
                    │ D33          D18   │
                    │ D25          D5    │
                    │ D26          D17   │
                    │ D27          D16   │
                    │ D14          D4    │
                    │ D12          D2    │
                    │ D13          D15   │
                    │ GND          GND   │
                    │ VIN          3V3   │
                    └─────────────────────┘
```

### I2C 버스 상세 연결

```
    ESP32                  SHT30 모듈            BMP280 모듈
    ┌──────┐              ┌──────────┐          ┌──────────┐
    │      │              │          │          │          │
    │ 3V3 ─┼──────────┬──┤ VCC      │     ┌────┤ VCC      │
    │      │          │  │          │     │    │          │
    │ GND ─┼──────┬───┼──┤ GND      │  ┌──┼────┤ GND      │
    │      │      │   │  │          │  │  │    │          │
    │ D21 ─┼──┬───┼───┼──┤ SDA      │  │  │ ┌──┤ SDA/SDI  │
    │(SDA) │  │   │   │  │          │  │  │ │  │          │
    │ D22 ─┼──┼─┬─┼───┼──┤ SCL      │  │  │ │──┤ SCL/SCK  │
    │(SCL) │  │ │ │   │  │          │  │  │ │  │          │
    │      │  │ │ │   │  │ ADDR─GND │  │  │ │  │ SDO─GND  │
    └──────┘  │ │ │   │  └──────────┘  │  │ │  └──────────┘
              │ │ │   │                │  │ │
              │ │ │   └────────────────┘  │ │
              │ │ │                        │ │
              │ │ └────────────────────────┘ │
              │ │                              │
              │ └──────────────────────────────┘
              │
              │
    VCC(3.3V)─┤
              │
    풀업 저항  ├─── R1 (4.7KΩ) ── SDA 라인
    (옵션)    │
              └─── R2 (4.7KΩ) ── SCL 라인
```

### 간단한 연결 요약표

```
    ┌─────────────┬──────────────┬──────────────┐
    │   ESP32     │   SHT30      │   BMP280     │
    ├─────────────┼──────────────┼──────────────┤
    │   3.3V      │   VCC        │   VCC        │
    │   GND       │   GND        │   GND        │
    │   GPIO21    │   SDA        │   SDA/SDI    │
    │   GPIO22    │   SCL        │   SCL/SCK    │
    │             │   ADDR→GND   │   SDO→GND    │
    │             │   (0x44)     │   (0x76)     │
    └─────────────┴──────────────┴──────────────┘

    ※ 두 센서 모두 같은 SDA, SCL 라인에 병렬 연결!
    ※ 전원(VCC, GND)도 공유!
```

### 브레드보드 배치도

```
    3.3V 레일(+) ─────────────────────────────────
    GND  레일(-) ─────────────────────────────────

    ESP32 DevKit (브레드보드 중앙에 배치)

    [SHT30 모듈]                [BMP280 모듈]
    VCC ── 3.3V 레일            VCC ── 3.3V 레일
    GND ── GND 레일             GND ── GND 레일
    SDA ── GPIO21 행            SDA ── GPIO21 행  (같은 행!)
    SCL ── GPIO22 행            SCL ── GPIO22 행  (같은 행!)

    풀업 저항 (옵션):
    R1(4.7K): 3.3V 레일 ── SDA 행 (GPIO21 행)
    R2(4.7K): 3.3V 레일 ── SCL 행 (GPIO22 행)

    GND  레일(-) ─────────────────────────────────
```

---

## 센서 상세 정보

### SHT30 온습도 센서

```
    ┌────────────────────────────────────┐
    │  항목         │  사양              │
    ├────────────────────────────────────┤
    │  측정 범위    │  온도: -40~125°C   │
    │              │  습도: 0~100% RH   │
    │  정확도      │  온도: ±0.3°C      │
    │              │  습도: ±2% RH      │
    │  해상도      │  0.01°C / 0.01%    │
    │  인터페이스  │  I2C (최대 1MHz)    │
    │  전원        │  2.4V ~ 5.5V       │
    │  소비 전류   │  측정 시: ~1.5mA    │
    │              │  대기 시: ~0.2μA    │
    └────────────────────────────────────┘
```

### BMP280 기압 센서

```
    ┌────────────────────────────────────┐
    │  항목         │  사양              │
    ├────────────────────────────────────┤
    │  측정 범위    │  기압: 300~1100hPa │
    │              │  온도: -40~85°C    │
    │  정확도      │  기압: ±1hPa       │
    │              │  온도: ±1°C        │
    │  해상도      │  0.18Pa            │
    │  인터페이스  │  I2C / SPI          │
    │  전원        │  1.71V ~ 3.6V      │
    │  소비 전류   │  측정 시: ~2.7μA   │
    └────────────────────────────────────┘
```

### 고도 계산 원리

```
    기압과 고도의 관계 (국제 표준 대기):

    고도(m) = 44330 × (1 - (P / P0)^(1/5.255))

    여기서:
    P  = 현재 기압 (hPa)
    P0 = 해수면 기압 (1013.25 hPa, 표준)

    ※ 해수면 기압은 날씨에 따라 변하므로
       정확한 고도를 위해서는 해당 지역의
       현재 해수면 기압을 입력해야 합니다.

    예시:
    기압 1013.25 hPa → 고도 0m (해수면)
    기압  898.76 hPa → 고도 1000m
    기압  795.01 hPa → 고도 2000m
    기압  540.48 hPa → 고도 5000m
```

---

## 라이브러리 설치

### Arduino IDE에서 라이브러리 설치

```
1. Arduino IDE 메뉴: 스케치 > 라이브러리 포함하기 > 라이브러리 관리...
2. 검색창에 아래 라이브러리를 검색하여 설치:

   ┌────────────────────────────────────────────────┐
   │  라이브러리 이름           │  용도              │
   ├────────────────────────────────────────────────┤
   │  Adafruit SHT31 Library   │  SHT30/31 센서     │
   │  Adafruit BMP280 Library  │  BMP280 센서       │
   │  Adafruit Unified Sensor  │  공통 센서 프레임워크│
   │  Adafruit BusIO           │  I2C/SPI 통신      │
   └────────────────────────────────────────────────┘

   ※ 의존성 라이브러리 설치 확인 창이 나오면 "모두 설치"를 선택하세요.
```

---

## 단계별 구현 가이드

### 단계 1: I2C 스캐너
```
목표: I2C 버스에 연결된 장치 주소 확인
핵심: Wire.begin(), Wire.beginTransmission(), Wire.endTransmission()
```
1. Wire 라이브러리 포함 (`#include <Wire.h>`)
2. 0x01 ~ 0x7F까지 모든 주소에 통신 시도
3. 응답하는 주소를 시리얼 모니터에 출력
4. SHT30(0x44)과 BMP280(0x76)이 검출되는지 확인

### 단계 2: SHT30 단독 테스트
```
목표: SHT30에서 온도와 습도 읽기
핵심: Adafruit_SHT31 라이브러리 사용
```
1. `Adafruit_SHT31` 객체 생성
2. `sht.begin(0x44)` 초기화
3. `sht.readTemperature()`, `sht.readHumidity()` 호출
4. 시리얼 모니터에 온도/습도 출력

### 단계 3: BMP280 단독 테스트
```
목표: BMP280에서 기압과 온도 읽기
핵심: Adafruit_BMP280 라이브러리 사용
```
1. `Adafruit_BMP280` 객체 생성
2. `bmp.begin(0x76)` 초기화
3. `bmp.readTemperature()`, `bmp.readPressure()`, `bmp.readAltitude()` 호출

### 단계 4: 두 센서 통합
```
목표: 같은 I2C 버스에서 두 센서 동시 데이터 수집
핵심: 서로 다른 I2C 주소 활용
```

### 단계 5: 데이터 포맷팅
```
목표: 수집된 데이터를 보기 좋게 출력
핵심: 테이블 형식, 단위 표시, 이상값 검출
```

---

## 트러블슈팅 가이드

### 문제 1: I2C 스캐너에서 장치가 검출되지 않음
```
확인 사항:
□ SDA, SCL 배선이 올바른가? (GPIO21=SDA, GPIO22=SCL)
□ 전원(VCC, GND)이 올바르게 연결되었는가?
□ 센서 모듈의 전원 LED가 켜져 있는가?
□ I2C 풀업 저항이 연결되었는가? (모듈 내장 확인)
□ 배선 접촉 불량은 없는가?

테스트:
1. 멀티미터로 SDA, SCL 라인의 전압 확인 (풀업 시 ~3.3V)
2. 센서 모듈을 하나씩 연결하여 개별 테스트
3. 다른 I2C 핀 조합 시도 (Wire.begin(SDA, SCL))
```

### 문제 2: SHT30 초기화 실패
```
확인 사항:
□ ADDR 핀 연결 확인 (GND=0x44, VDD=0x45)
□ I2C 스캐너에서 0x44 (또는 0x45) 검출 확인
□ Adafruit SHT31 라이브러리 최신 버전인지 확인
□ Wire.begin()이 호출되었는가?

해결: sht.begin(0x45)로 변경하여 시도
```

### 문제 3: BMP280 초기화 실패
```
확인 사항:
□ SDO 핀 연결 확인 (GND=0x76, VDD=0x77)
□ BMP280인지 BME280인지 확인 (모듈 마킹 확인)
□ SPI 모드가 아닌 I2C 모드인지 확인 (CSB=VDD)

해결:
1. bmp.begin(0x77)로 변경하여 시도
2. BME280 모듈인 경우 Adafruit BME280 라이브러리 사용
```

### 문제 4: 두 센서 중 하나만 동작
```
원인: I2C 주소 충돌 또는 배선 문제
확인:
□ 두 센서의 I2C 주소가 다른지 확인
□ I2C 스캐너로 두 주소 모두 검출되는지 확인
□ 전원 공급이 충분한지 확인 (두 센서 합산 전류)
□ 풀업 저항이 적절한지 확인 (중복 풀업 주의)
```

### 문제 5: 값이 NaN이나 이상한 수치
```
원인: 센서 통신 오류
확인:
□ NaN 체크: isnan(value) 함수 사용
□ 배선 길이가 너무 긴 것은 아닌지 (30cm 이하 권장)
□ 주변 전자기 간섭 요소 확인

해결:
1. 측정 주기를 늘려보기 (500ms → 1000ms)
2. Wire.setClock(100000)으로 I2C 속도 낮추기
3. 풀업 저항 값 조정 (4.7KΩ → 2.2KΩ)
```

---

## 핵심 정리

```
┌─────────────────────────────────────────────────────────┐
│                    핵심 정리                              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. I2C 프로토콜:                                        │
│     - 2선식: SDA(데이터) + SCL(클록)                      │
│     - 마스터-슬레이브 구조                                │
│     - 7비트 주소로 최대 128개 장치 연결 가능                │
│     - ESP32 기본 핀: SDA=GPIO21, SCL=GPIO22              │
│                                                         │
│  2. 풀업 저항:                                           │
│     - I2C는 오픈 드레인 → 풀업 저항 필수                   │
│     - 100kHz: 4.7KΩ 권장                                 │
│     - 모듈에 내장된 경우 외부 풀업 생략 가능                 │
│                                                         │
│  3. SHT30 (온습도):                                      │
│     - 기본 주소: 0x44                                    │
│     - 정확도: ±0.3°C, ±2% RH                            │
│     - Adafruit_SHT31 라이브러리 사용                      │
│                                                         │
│  4. BMP280 (기압):                                       │
│     - 기본 주소: 0x76                                    │
│     - 정확도: ±1hPa, ±1°C                               │
│     - 고도 계산 가능 (해수면 기압 기준)                     │
│     - Adafruit_BMP280 라이브러리 사용                     │
│                                                         │
│  5. 다중 센서 연결:                                       │
│     - 같은 I2C 버스에 병렬 연결                           │
│     - 서로 다른 I2C 주소 필수                             │
│     - I2C 스캐너로 연결 상태 확인                          │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

*이전 프로젝트: [프로젝트 2 - 아날로그 센서 읽기](../project2-analog-sensor/README.md)*
*다음 프로젝트: [프로젝트 4 - 릴레이로 외부 장치 제어](../project4-relay-control/README.md)*
