# 프로젝트 4: 릴레이로 외부 장치 제어

## 프로젝트 개요

이 프로젝트에서는 트랜지스터 스위칭 회로와 릴레이를 사용하여 ESP32로 외부 장치
(팬, 조명, 펌프 등)를 제어합니다. ESP32의 GPIO 출력(3.3V, 최대 12mA)만으로는
직접 구동할 수 없는 고전력 장치를 트랜지스터와 릴레이를 통해 안전하게 제어합니다.

플라이백 다이오드의 필요성, 릴레이 접점의 종류(NO, NC, COM), 시리얼 명령 기반
원격 제어, 타이머 기반 자동 제어 등을 학습합니다.

> **경고: 이 프로젝트는 AC 220V 고전압을 다룰 수 있습니다.**
> **감전 및 화재 위험이 있으니 반드시 안전 수칙을 준수하세요!**
> **초보자는 반드시 DC 12V 이하의 저전압 장치로 먼저 연습하세요.**

**난이도:** ★★★☆☆ (중급)
**예상 소요 시간:** 3~4시간
**선수 지식:** 프로젝트 1~3 완료, 트랜지스터 기초, 옴의 법칙

---

## 학습 목표

1. **릴레이 동작 원리** - 전자석으로 스위치를 동작시키는 원리
2. **릴레이 접점 이해** - NO(Normally Open), NC(Normally Closed), COM
3. **트랜지스터 스위칭 회로** - NPN 트랜지스터로 릴레이 구동
4. **플라이백 다이오드** - 역기전력 보호의 필요성과 구현
5. **시리얼 명령 제어** - 시리얼 모니터에서 명령어로 장치 제어
6. **타이머 기반 자동 제어** - millis()를 활용한 주기적 ON/OFF 제어
7. **안전 설계** - 고전압 회로의 안전 설계 원칙

---

## 릴레이 동작 원리

### 릴레이 내부 구조

```
    릴레이 내부 구조:

    제어 측 (저전압, DC 5V)         부하 측 (고전압, AC 220V)
    ┌─────────────────────┐        ┌─────────────────────┐
    │                     │        │                     │
    │   코일(전자석)       │        │    COM (공통)        │
    │   ┌─────────────┐   │        │      │               │
    │   │ ╔═══════╗   │   │        │      ○ ← 가동 접점   │
    │   │ ║ 코일  ║   │   │        │     ╱               │
    │   │ ║       ║   │   │        │    ╱  ← 스프링      │
    │   │ ╚═══════╝   │   │        │   ╱                 │
    │   │    ↕ 철심    │   │        │  ○ NC  ○ NO        │
    │   └─────────────┘   │        │                     │
    │   (+)          (-)  │        │  NC=평상시닫힘       │
    │                     │        │  NO=평상시열림       │
    └─────────────────────┘        └─────────────────────┘

    릴레이 OFF (코일 비통전):         릴레이 ON (코일 통전):
    COM ──── NC (연결됨)             COM ──── NO (연결됨)
    COM ──×─ NO (끊어짐)             COM ──×─ NC (끊어짐)
```

### 릴레이 접점 종류

```
    ┌─────────────────────────────────────────────────┐
    │  접점    │  의미              │  용도             │
    ├─────────────────────────────────────────────────┤
    │  COM    │  Common (공통)     │  항상 연결         │
    │  NO     │  Normally Open     │  평상시 열림       │
    │         │  (평상시 열림)      │  릴레이 ON시 닫힘  │
    │  NC     │  Normally Closed   │  평상시 닫힘       │
    │         │  (평상시 닫힘)      │  릴레이 ON시 열림  │
    └─────────────────────────────────────────────────┘

    일반적 사용: COM과 NO 사이에 부하 연결
    → 릴레이 ON 시 부하에 전원 공급
    → 릴레이 OFF 시 부하 전원 차단

    안전 장치: COM과 NC 사이에 부하 연결
    → 평상시 부하 동작, 비상 시 릴레이 ON으로 차단
```

---

## 트랜지스터 구동 회로

### 왜 트랜지스터가 필요한가?

```
    ESP32 GPIO 출력 능력:
    - 출력 전압: 3.3V
    - 최대 출력 전류: 12mA (권장), 40mA (절대 최대)

    5V 릴레이 코일 요구사
    - 동작 전압: 5V
    - 코일 전류: 약 70~80mA

    문제: ESP32 GPIO로 릴레이를 직접 구동할 수 없음!
          전압 부족 (3.3V < 5V) + 전류 부족 (12mA < 70mA)

    해결: NPN 트랜지스터를 스위치로 사용
          ESP32 → 트랜지스터 베이스 (소전류)
          5V 전원 → 릴레이 코일 → 트랜지스터 (대전류)
```

### NPN 트랜지스터 스위칭 회로

```
                    5V (VIN)
                     │
                     │
               ┌─────┴─────┐
               │            │
               │  릴레이    │
               │  코일      │
               │  (~70mA)   │
               │            │
               └─────┬─────┘
                     │
            ┌────────┤ ← 1N4007 플라이백 다이오드
            │        │    (역방향 연결: 캐소드→5V, 애노드→콜렉터)
            │        │
    5V ←────┘        │
                     │
                  C (콜렉터)
                  │
             ┌────┤ 2N2222
             │    │ NPN 트랜지스터
             │    ├
             │  B (베이스)
             │    │
             │  R_B (1KΩ)  ← 베이스 전류 제한 저항
             │    │
             │    │
    GND ─────┤   ESP32 GPIO
             │
          E (에미터)
             │
            GND

    동작 원리:
    1. GPIO HIGH (3.3V) → 베이스 전류 흐름
       I_B = (3.3V - 0.7V) / 1KΩ ≈ 2.6mA
    2. 트랜지스터 ON (포화) → 콜렉터-에미터 도통
    3. 릴레이 코일에 전류 흐름 → 릴레이 동작
    4. GPIO LOW → 트랜지스터 OFF → 릴레이 해제
```

---

## 플라이백 다이오드

### 왜 플라이백 다이오드가 필요한가?

```
    릴레이 코일 = 인덕터(코일)

    릴레이 OFF 순간:

    코일에 저장된 에너지가 역기전력(Back-EMF)을 생성
    → 순간적으로 수십~수백 볼트의 전압 스파이크 발생!
    → 트랜지스터 파괴 가능!

    전압 스파이크 없이:        플라이백 다이오드 적용:

    전압                       전압
     │  ╱╲                     │
     │ ╱  ╲  ← 수십~수백V      │──── ← 5V + 0.7V로 제한
     │╱    ╲  (위험!)          │    ╲
    ─┴──────┴── 시간           ─┴─────┴── 시간
     ↑                         ↑
     OFF 순간                  OFF 순간

    플라이백 다이오드:
    - 정상 동작 시: 역방향이므로 전류 차단 (영향 없음)
    - OFF 순간: 역기전력으로 순방향 → 전류 순환 경로 제공
    - 에너지를 안전하게 소진시켜 전압 스파이크 방지
```

### 다이오드 연결 방향

```
    릴레이 코일
    ┌──────────┐
    │          │
    │          │
    └────┬─────┘
         │
    ┌────┴────┐
    │         │
    │ 1N4007  │      다이오드 방향:
    │  ┌──┐   │      ─│►─
    │  │  │   │      캐소드(K) │► 애노드(A)
    │  │◄─┤   │
    │  └──┘   │      캐소드(밴드 표시)가 있는 쪽 → 5V(+) 쪽
    │         │      애노드 → 콜렉터 쪽
    └────┬────┘
         │
         C (콜렉터)

    ※ 릴레이 모듈을 사용하는 경우 대부분 다이오드가 내장되어 있습니다.
       모듈 회로도를 확인하세요.
```

---

## 안전 주의사항

### AC 220V 취급 시 반드시 지킬 사항

```
    ╔══════════════════════════════════════════════════════╗
    ║                                                      ║
    ║     ⚠  고전압 경고 (AC 220V)  ⚠                      ║
    ║                                                      ║
    ║  1. 회로 작업 전 반드시 전원 플러그를 뽑으세요           ║
    ║  2. 한 손으로만 작업하세요 (양손 감전 방지)             ║
    ║  3. 맨발로 작업하지 마세요 (접지 방지)                  ║
    ║  4. 젖은 손으로 절대 만지지 마세요                     ║
    ║  5. AC 배선은 절연 처리를 완벽하게 하세요               ║
    ║  6. AC 회로와 DC 회로를 물리적으로 분리하세요           ║
    ║  7. 퓨즈를 반드시 사용하세요                           ║
    ║  8. 작업 전 멀티미터로 전압 부재를 확인하세요            ║
    ║  9. 혼자 작업하지 마세요 (비상 시 도움 필요)            ║
    ║ 10. 확신이 없으면 절대 작업하지 마세요!                 ║
    ║                                                      ║
    ║  초보자는 DC 12V 이하 장치로만 실습하세요!              ║
    ║                                                      ║
    ╚══════════════════════════════════════════════════════╝
```

### 안전한 실습 방법

```
    권장: DC 12V 팬/LED 스트립으로 실습

    DC 12V 전원    릴레이 COM ─── DC 12V (+)
    어댑터          릴레이 NO  ─── 팬/LED (+)
                   팬/LED (-) ─── DC 12V (-)

    ※ DC 12V는 인체에 안전한 전압입니다 (36V 미만)
    ※ AC 220V 실습은 충분한 경험을 쌓은 후에만 시도하세요
```

---

## 필요 부품 목록

| 부품 | 수량 | 규격 | 비고 |
|------|------|------|------|
| ESP32 DevKit V1 | 1 | | |
| 5V 릴레이 모듈 | 1 | 1채널, SRD-05VDC | 다이오드 내장 확인 |
| 2N2222 NPN 트랜지스터 | 1 | TO-92 | 또는 BC547 |
| 1N4007 다이오드 | 1 | DO-41 | 플라이백 보호용 |
| 저항 1KΩ | 1 | 1/4W | 베이스 전류 제한 |
| LED (빨강) | 1 | 5mm | 릴레이 ON 상태 표시 |
| LED (초록) | 1 | 5mm | 릴레이 OFF 상태 표시 |
| 저항 220Ω | 2 | 1/4W | LED 전류 제한 |
| DC 12V 팬 또는 LED 스트립 | 1 | | 테스트 부하용 |
| DC 12V 전원 어댑터 | 1 | 1A 이상 | 부하 전원용 |
| 브레드보드 | 1 | 830홀 | |
| 점퍼 와이어 | 약 15개 | M-M, M-F | |

---

## 회로 연결도

### 전체 회로

```
                        ESP32 DevKit V1
                    ┌─────────────────────┐
                    │                     │
              5V ───┤ VIN          GND   ├──── GND 공통
                    │ 3V3          D23   │
                    │ EN           D22   │
                    │ VP(D36)      TX0   │
                    │ VN(D39)      RX0   │
                    │ D34          D21   │
                    │ D35          D19   │──── LED_ON(빨강) ── R(220Ω) ── GND
                    │ D32          D18   │──── LED_OFF(초록) ── R(220Ω) ── GND
                    │ D33          D5    │
                    │ D25          D17   │
                    │ D26          D16   │──── R(1KΩ) ── 2N2222 베이스
                    │ D27          D4    │
                    │ D14          D2    │
                    │ D12          D15   │
                    │ D13          GND   │
                    │ GND          3V3   │
                    └─────────────────────┘
```

### 트랜지스터 + 릴레이 상세 연결

```
    ESP32 VIN (5V) ─────────────────────┐
                                         │
                                    ┌────┴────┐
                                    │  릴레이  │
                                    │  코일    │
                                    │  (5V)   │
                                    └────┬────┘
                                         │
                    1N4007          ┌─────┤
                    ┌──┤►──┐       │     │
                    │      │       │     │
    5V ─────────────┘      └───────┘     │
                                         │
                                     C (콜렉터)
                                     │
                                ┌────┤
                                │    │ 2N2222
                                │    │ (NPN)
                                │    ├
                                │  B (베이스)
                                │    │
                                │  R (1KΩ)
                                │    │
                                │    │
                                │   GPIO16 (ESP32)
                                │
                             E (에미터)
                                │
                               GND
```

### 릴레이 부하 측 연결 (DC 12V 팬 예시)

```
    릴레이 접점                      외부 부하

    ┌──────────┐
    │ COM ─────┼──── DC 12V 전원 (+)
    │          │
    │ NO  ─────┼──── DC 팬 (+)
    │          │         │
    │ NC       │     DC 팬 (-)
    └──────────┘         │
                    DC 12V 전원 (-)

    릴레이 OFF → COM-NO 끊어짐 → 팬 정지
    릴레이 ON  → COM-NO 연결   → 팬 동작
```

### 릴레이 모듈 사용 시 연결 (간편 버전)

```
    릴레이 모듈 (트랜지스터, 다이오드 내장):

    ┌─────────────────────────┐
    │                         │
    │  VCC ── ESP32 VIN (5V)  │
    │  GND ── ESP32 GND       │
    │  IN  ── ESP32 GPIO16    │  ← 제어 신호
    │                         │
    │  COM ── 전원 (+)        │
    │  NO  ── 부하 (+)        │  ← 부하 연결
    │  NC  ── (미사용)        │
    │                         │
    └─────────────────────────┘

    ※ 릴레이 모듈은 LOW 활성(Active Low)인 경우가 많습니다!
       IN=LOW → 릴레이 ON
       IN=HIGH → 릴레이 OFF
       모듈 사양을 반드시 확인하세요.
```

---

## 동작 설명

### 제어 모드

1. **수동 제어** - 시리얼 모니터에서 명령어 입력으로 ON/OFF
2. **타이머 제어** - 설정된 시간 간격으로 자동 ON/OFF
3. **카운트다운 제어** - 지정 시간 후 자동 OFF

### 시리얼 명령어

```
    ┌──────────────────────────────────────────────┐
    │  명령어     │  동작                          │
    ├──────────────────────────────────────────────┤
    │  ON        │  릴레이 켜기                    │
    │  OFF       │  릴레이 끄기                    │
    │  TOGGLE    │  현재 상태 반전                 │
    │  STATUS    │  현재 상태 확인                 │
    │  TIMER     │  타이머 모드 ON/OFF             │
    │  SET xx    │  타이머 간격 설정 (초)           │
    │  COUNT xx  │  xx초 후 자동 OFF               │
    │  HELP      │  도움말 표시                    │
    └──────────────────────────────────────────────┘
```

---

## 단계별 구현 가이드

### 단계 1: 릴레이 모듈 기본 테스트
```
목표: GPIO 출력으로 릴레이 ON/OFF
핵심: digitalWrite(), 릴레이 동작음 확인
```
1. 릴레이 모듈의 VCC, GND, IN을 ESP32에 연결
2. GPIO16을 OUTPUT으로 설정
3. 1초 간격으로 HIGH/LOW 반복
4. "딸깍" 소리가 나면 릴레이 정상 동작

### 단계 2: 트랜지스터 구동 회로 구성
```
목표: 트랜지스터로 릴레이 코일 구동
핵심: NPN 트랜지스터 스위칭, 플라이백 다이오드
```
1. 2N2222 트랜지스터의 B, C, E 핀 확인
2. 베이스에 1KΩ 저항을 통해 GPIO 연결
3. 콜렉터에 릴레이 코일 연결
4. 에미터를 GND에 연결
5. 플라이백 다이오드 연결

### 단계 3: 상태 LED 추가
```
목표: 릴레이 상태를 LED로 시각적 표시
핵심: 릴레이 ON→빨간LED, OFF→초록LED
```

### 단계 4: 시리얼 명령 제어
```
목표: 시리얼 모니터에서 문자열 명령으로 제어
핵심: Serial.readStringUntil(), String 비교
```

### 단계 5: 타이머 기반 자동 제어
```
목표: 설정된 간격으로 자동 ON/OFF 반복
핵심: millis() 기반 타이밍, 상태 변수
```

---

## 트러블슈팅 가이드

### 문제 1: 릴레이가 동작하지 않음 (딸깍 소리 없음)
```
확인 사항:
□ 릴레이 코일에 5V가 공급되고 있는가?
□ 트랜지스터의 B, C, E 핀이 올바르게 연결되었는가?
□ 베이스 저항이 올바른 값인가? (1KΩ)
□ ESP32 GPIO가 HIGH를 출력하고 있는가?
□ 릴레이 모듈의 동작 방식 확인 (Active High/Low)

테스트:
1. 멀티미터로 트랜지스터 베이스 전압 확인 (~2.6V)
2. 릴레이 코일을 5V에 직접 연결하여 릴레이 자체 테스트
3. LED를 릴레이 대신 연결하여 트랜지스터 동작 확인
```

### 문제 2: 릴레이가 불안정하게 동작 (떨림)
```
원인:
- 전원 부족 (릴레이 코일 전류가 클 때)
- ESP32 VIN 전압 강하
- 노이즈

해결:
1. 릴레이 전원을 별도 5V 어댑터로 분리
2. 릴레이 코일에 100μF 전해 커패시터 추가
3. 베이스 저항 값 줄이기 (1KΩ → 470Ω)
```

### 문제 3: ESP32가 리셋됨
```
원인: 릴레이 동작 시 전원 순간 강하 또는 노이즈
해결:
1. 릴레이 전원을 별도로 분리
2. ESP32 VIN에 100μF + 100nF 커패시터 추가
3. 플라이백 다이오드 연결 확인
```

### 문제 4: 트랜지스터가 뜨거워짐
```
원인: 트랜지스터가 포화 영역이 아닌 활성 영역에서 동작
해결:
1. 베이스 저항 확인 (너무 크면 포화되지 않음)
2. 트랜지스터 규격 확인 (Ic_max > 릴레이 코일 전류)
3. 2N2222 대신 더 큰 트랜지스터 사용 (TIP120 달링턴 등)
```

---

## 핵심 정리

```
┌─────────────────────────────────────────────────────────┐
│                    핵심 정리                              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. 릴레이 = 전자석 스위치                                │
│     - COM: 공통 접점                                     │
│     - NO: 평상시 열림 (릴레이 ON 시 닫힘)                  │
│     - NC: 평상시 닫힘 (릴레이 ON 시 열림)                  │
│                                                         │
│  2. 트랜지스터 스위칭:                                    │
│     - ESP32 GPIO → 1KΩ → 베이스                         │
│     - 5V → 릴레이 코일 → 콜렉터                          │
│     - 에미터 → GND                                       │
│     - GPIO HIGH → 트랜지스터 ON → 릴레이 ON              │
│                                                         │
│  3. 플라이백 다이오드 = 역기전력 보호                       │
│     - 릴레이 코일에 역방향 병렬 연결                       │
│     - 1N4007 사용 (캐소드→5V 쪽)                         │
│     - 없으면 트랜지스터 파괴 위험!                         │
│                                                         │
│  4. 릴레이 모듈 사용 시:                                  │
│     - 트랜지스터, 다이오드가 이미 내장                     │
│     - Active High/Low 확인 필수                          │
│     - VCC, GND, IN만 연결하면 동작                       │
│                                                         │
│  5. 안전 수칙:                                           │
│     - AC 220V는 생명 위험! 초보자는 DC 12V로 실습         │
│     - 회로 작업 전 반드시 전원 차단                        │
│     - 릴레이 전원은 ESP32와 분리 권장                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

*이전 프로젝트: [프로젝트 3 - I2C 센서 연결](../project3-i2c-sensor/README.md)*
*다음 프로젝트: [프로젝트 5 - 통합 센서 시스템](../project5-integrated-system/README.md)*
