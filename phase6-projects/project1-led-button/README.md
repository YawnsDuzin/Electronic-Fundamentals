# 프로젝트 1: LED + 버튼 제어

## 프로젝트 개요

이 프로젝트는 ESP32의 가장 기본적인 디지털 입출력(GPIO)을 학습하는 첫 번째 실전
프로젝트입니다. 택트 스위치(버튼)를 사용하여 LED를 제어하면서, 소프트웨어 디바운싱,
하드웨어 인터럽트, 상태 머신 등 임베디드 프로그래밍의 핵심 개념을 익힙니다.

**난이도:** ★☆☆☆☆ (입문)
**예상 소요 시간:** 2~3시간
**선수 지식:** C/C++ 기초, Arduino IDE 사용법

---

## 학습 목표

1. **GPIO 디지털 출력** - `pinMode()`, `digitalWrite()`로 LED 제어
2. **GPIO 디지털 입력** - `digitalRead()`로 버튼 상태 읽기
3. **풀업/풀다운 저항** - 내부 풀업 저항 활용 및 외부 풀다운 저항 연결
4. **소프트웨어 디바운싱** - 채터링 방지를 위한 시간 기반 디바운싱
5. **하드웨어 인터럽트** - `attachInterrupt()`를 사용한 즉각적 버튼 응답
6. **토글 로직** - 버튼을 누를 때마다 LED 상태 전환
7. **다중 LED 순차 제어** - 배열과 반복문을 활용한 LED 시퀀스

---

## 필요 부품 목록

| 부품 | 수량 | 규격 | 비고 |
|------|------|------|------|
| ESP32 DevKit V1 | 1 | 30핀/38핀 | |
| 브레드보드 | 1 | 830홀 | |
| LED (빨강) | 2 | 5mm | 순방향 전압 ~2V |
| LED (초록) | 1 | 5mm | 순방향 전압 ~2.2V |
| LED (노랑) | 1 | 5mm | 순방향 전압 ~2.1V |
| 택트 스위치 | 2 | 6x6mm 4핀 | |
| 저항 220옴 | 4 | 1/4W | LED 전류 제한용 |
| 저항 10K옴 | 2 | 1/4W | 풀다운 저항용 |
| 점퍼 와이어 | 약 15개 | M-M | |
| USB 케이블 | 1 | Micro-B | 데이터 전송 가능 |

---

## 회로 연결도

### 기본 회로 (LED 4개 + 버튼 2개)

```
                        ESP32 DevKit V1
                    ┌─────────────────────┐
                    │                     │
                    │  3V3          GND   │
                    │  EN           D23   │
                    │  VP(D36)      D22   │
                    │  VN(D39)      TX0   │
                    │  D34          RX0   │
                    │  D35          D21   │
                    │  D32          D19   │──── LED4(노랑) ──── R4(220Ω) ──── GND
                    │  D33          D18   │──── LED3(초록) ──── R3(220Ω) ──── GND
                    │  D25          D5    │
                    │  D26          D17   │──── LED2(빨강) ──── R2(220Ω) ──── GND
                    │  D27          D16   │──── LED1(빨강) ──── R1(220Ω) ──── GND
                    │  D14          D4    │
                    │  D12          D2    │──── (내장 LED)
                    │  D13          D15   │
                    │  GND          GND   │
                    │  VIN          3V3   │
                    └─────────────────────┘
                         │          │
                         │          │
                        D13        D14
                         │          │
                    ┌────┴────┐ ┌───┴────┐
                    │  BTN1   │ │  BTN2  │
                    │  (토글) │ │ (모드) │
                    └────┬────┘ └───┬────┘
                         │          │
                    R5(10K)    R6(10K)
                         │          │
                        GND        GND
```

### 버튼 상세 연결도

```
     ESP32 GPIO13
          │
          │
    ┌─────┴─────┐
    │           │
    │   [BTN]   │     택트 스위치 내부 구조:
    │   ┌───┐   │     ┌──────────────┐
    │   │   │   │     │  1 ──── 2    │
    ├───┤   ├───┤     │  │      │    │
    │   │   │   │     │  │ ████ │    │  ← 버튼을 누르면
    │   └───┘   │     │  │      │    │    1-2, 3-4 연결
    │           │     │  3 ──── 4    │
    └─────┬─────┘     └──────────────┘
          │
          │
     R (10KΩ) ← 풀다운 저항
          │
          │
         GND
```

### LED 상세 연결도

```
     ESP32 GPIO16
          │
          │
          ▼
    ┌─────────┐
    │   LED   │     LED 극성:
    │  ┌───┐  │     - 긴 다리 = 양극(+, Anode)
    │  │ ▲ │  │     - 짧은 다리 = 음극(-, Cathode)
    │  │ │ │  │     - 납작한 면 = 음극 쪽
    │  └─┤─┘  │
    │    │    │     전류 제한 저항 계산:
    └────┤────┘     R = (3.3V - 2.0V) / 0.005A
         │          R = 260Ω → 220Ω 사용 (안전 마진)
         │
    R (220Ω) ← 전류 제한 저항
         │
         │
        GND
```

### 브레드보드 배치도

```
    전원 레일(+)  ─────────────────────────────────────────────
    전원 레일(-)  ─────────────────────────────────────────────

    열:  a  b  c  d  e     f  g  h  i  j

    01: [          ESP32 DevKit              ]
    02: [          (왼쪽 핀들)  (오른쪽 핀들)  ]
    ...
    15: [                                    ]

    20:  ○  ○  ○  ○  ○     ○  ○  ○  ○  ○   ← BTN1 영역
    21:  ●  ●  ○  ○  ○     ○  ○  ○  ○  ○   ← BTN1 (a,b = 한쪽)
    22:  ○  ○  ○  ○  ○     ○  ○  ○  ○  ○
    23:  ○  R(10K)  ○  ○     ○  ○  ○  ○  ○  ← 풀다운 저항 → GND

    25:  ○  LED1  ○  ○     ○  ○  ○  ○  ○   ← LED1 양극
    26:  ○  R(220Ω)  ○     ○  ○  ○  ○  ○   ← LED1 음극 → 저항 → GND

    27:  ○  LED2  ○  ○     ○  ○  ○  ○  ○   ← LED2
    28:  ○  R(220Ω)  ○     ○  ○  ○  ○  ○

    전원 레일(+)  ─────────────────────────────────────────────
    전원 레일(-)  ── GND 연결 ─────────────────────────────────
```

---

## 동작 설명

### 모드 1: 기본 토글
- **BTN1**을 누르면 LED1이 켜지고, 다시 누르면 꺼집니다
- 소프트웨어 디바운싱으로 채터링을 방지합니다

### 모드 2: 순차 제어
- **BTN2**를 누르면 동작 모드가 변경됩니다
  - 모드 0: 단일 LED 토글
  - 모드 1: LED 순차 점등 (LED1 → LED2 → LED3 → LED4)
  - 모드 2: LED 전체 점멸 (깜빡임)
  - 모드 3: LED 핑퐁 (왕복 패턴)

### 채터링(바운싱)이란?

```
    이상적인 버튼 입력:          실제 버튼 입력 (채터링 발생):

    HIGH ─────┐     ┌─────     HIGH ─────┐ ┌┐ ┌┐  ┌─────
              │     │                    │ ││ ││  │
    LOW       └─────┘          LOW       └─┘└─┘└──┘

              ← 1회 누름 →               ← 1회 누름이지만
                                           여러 번으로 인식 →
```

기계식 스위치는 접점이 닿을 때 수 밀리초 동안 불안정하게 ON/OFF를
반복합니다. 이것을 **채터링(chattering)** 또는 **바운싱(bouncing)**이라고
합니다. 소프트웨어 디바운싱은 일정 시간(보통 50ms) 동안의 변화를
무시하여 이 문제를 해결합니다.

---

## 단계별 구현 가이드

### 단계 1: LED 한 개 켜기 (Hello World)
```
목표: GPIO 출력으로 LED 하나를 켜고 끄기
핵심: pinMode(OUTPUT), digitalWrite(HIGH/LOW)
```
1. LED와 220옴 저항을 브레드보드에 연결
2. ESP32 GPIO16 → LED 양극 → LED 음극 → 저항 → GND
3. `setup()`에서 `pinMode(16, OUTPUT)` 설정
4. `loop()`에서 `digitalWrite(16, HIGH)` → `delay(1000)` → `LOW` 반복

### 단계 2: 버튼 입력 읽기
```
목표: 버튼 상태를 시리얼 모니터에 출력
핵심: pinMode(INPUT), digitalRead()
```
1. 버튼과 10K 풀다운 저항을 연결
2. `digitalRead()`로 버튼 상태를 읽어 시리얼 모니터에 출력
3. 버튼을 누르면 HIGH, 떼면 LOW가 출력되는지 확인

### 단계 3: 버튼으로 LED 직접 제어
```
목표: 버튼을 누르고 있는 동안 LED가 켜짐
핵심: digitalRead()의 반환값을 digitalWrite()에 전달
```

### 단계 4: 토글 기능 + 디바운싱
```
목표: 버튼을 한 번 누르면 ON, 다시 누르면 OFF
핵심: 상태 변수, millis() 기반 디바운싱
```
1. `ledState` 변수로 현재 LED 상태 추적
2. `lastDebounceTime` 변수로 디바운싱 구현
3. 버튼이 눌릴 때만 `ledState` 토글

### 단계 5: 인터럽트 적용
```
목표: 폴링 대신 인터럽트로 버튼 감지
핵심: attachInterrupt(), FALLING 트리거
```
1. `attachInterrupt()`로 GPIO에 인터럽트 등록
2. ISR(인터럽트 서비스 루틴) 함수 작성
3. ISR 내에서는 최소한의 작업만 수행 (`volatile` 변수 사용)

### 단계 6: 다중 LED 순차 제어
```
목표: 4개 LED를 다양한 패턴으로 제어
핵심: 배열, 상태 머신, millis() 기반 타이밍
```

---

## 핵심 개념 정리

### GPIO 디지털 입출력

| 함수 | 설명 | 예시 |
|------|------|------|
| `pinMode(pin, mode)` | 핀 모드 설정 | `pinMode(16, OUTPUT)` |
| `digitalWrite(pin, val)` | 디지털 출력 | `digitalWrite(16, HIGH)` |
| `digitalRead(pin)` | 디지털 입력 | `int val = digitalRead(13)` |

### 핀 모드 종류

| 모드 | 설명 |
|------|------|
| `INPUT` | 입력 모드 (외부 풀업/풀다운 필요) |
| `OUTPUT` | 출력 모드 (HIGH=3.3V, LOW=0V) |
| `INPUT_PULLUP` | 내부 풀업 저항 활성화 (버튼을 GND에 연결) |
| `INPUT_PULLDOWN` | 내부 풀다운 저항 활성화 (ESP32 전용) |

### 인터럽트 트리거 모드

| 모드 | 설명 |
|------|------|
| `RISING` | LOW → HIGH 전환 시 |
| `FALLING` | HIGH → LOW 전환 시 |
| `CHANGE` | 상태가 변할 때마다 |
| `LOW` | LOW 상태인 동안 |
| `HIGH` | HIGH 상태인 동안 |

### ESP32 GPIO 주의사항

```
사용 가능한 GPIO (입출력):
  GPIO 2, 4, 5, 12, 13, 14, 15, 16, 17, 18, 19, 21, 22, 23, 25, 26, 27, 32, 33

입력 전용 GPIO (출력 불가):
  GPIO 34, 35, 36(VP), 39(VN) - ADC 입력만 가능, 내부 풀업 없음

부팅 시 주의할 GPIO:
  GPIO 0  - 부팅 모드 선택 (LOW = 다운로드 모드)
  GPIO 2  - 부팅 시 LOW여야 함 (내장 LED 연결)
  GPIO 12 - 부팅 시 HIGH면 플래시 전압 오류 가능
  GPIO 15 - 부팅 시 HIGH면 시리얼 로그 출력
```

---

## 트러블슈팅 가이드

### 문제 1: LED가 켜지지 않음
```
확인 사항:
□ LED 극성이 올바른가? (긴 다리 = 양극 → GPIO 쪽)
□ 저항이 올바르게 연결되었는가?
□ GPIO 핀 번호가 코드와 일치하는가?
□ 브레드보드 접촉 불량은 없는가?
□ ESP32에 전원이 공급되고 있는가?

테스트 방법:
1. 멀티미터로 GPIO 핀 전압 측정 (HIGH = ~3.3V)
2. LED를 3.3V 핀에 직접 연결하여 LED 자체 테스트
3. 다른 GPIO 핀으로 변경하여 테스트
```

### 문제 2: 버튼이 인식되지 않음
```
확인 사항:
□ 풀다운 저항이 연결되었는가? (또는 INPUT_PULLUP 사용)
□ 버튼의 올바른 핀에 연결했는가? (대각선 핀이 연결됨)
□ 시리얼 모니터에서 값을 확인했는가?
□ 입력 전용 핀(34,35,36,39)에 풀업/풀다운 미지원 주의

테스트 방법:
1. 시리얼 모니터로 digitalRead() 값 출력
2. 버튼 없이 점퍼 와이어로 HIGH/LOW 직접 연결 테스트
3. 멀티미터로 버튼 양단 도통 확인
```

### 문제 3: 버튼 한 번 누르면 여러 번 동작
```
원인: 채터링(바운싱)
해결:
1. 소프트웨어 디바운싱 적용 (50ms 딜레이)
2. 디바운싱 시간을 늘려보기 (100ms~200ms)
3. 하드웨어 디바운싱: 버튼에 100nF 커패시터 병렬 연결
```

### 문제 4: 인터럽트가 동작하지 않음
```
확인 사항:
□ GPIO 핀이 인터럽트를 지원하는가? (대부분 가능)
□ ISR 함수에 IRAM_ATTR 속성을 붙였는가?
□ ISR 내에서 Serial.print() 등 긴 작업을 하고 있지 않은가?
□ volatile 키워드를 사용했는가?
```

### 문제 5: ESP32 업로드 실패
```
해결 방법:
1. 업로드 시 BOOT 버튼을 꾹 누르기
2. USB 케이블이 데이터 전송 가능한지 확인 (충전 전용 케이블 불가)
3. 올바른 COM 포트 선택 확인
4. 드라이버 설치: CP2102 또는 CH340 (보드에 따라)
5. 업로드 속도를 115200으로 낮추기
```

---

## 확장 아이디어

1. **PWM으로 LED 밝기 조절** - `ledcWrite()`를 사용하여 LED 밝기를 단계적으로 조절
2. **RGB LED 제어** - 3색 LED로 다양한 색상 만들기
3. **모스 부호 출력** - 버튼으로 입력받아 LED로 모스 부호 표시
4. **반응 속도 게임** - LED가 켜지면 최대한 빨리 버튼을 누르는 게임
5. **시몬 게임** - LED 패턴을 기억하고 따라하는 게임

---

## 핵심 정리

```
┌─────────────────────────────────────────────────────────┐
│                    핵심 정리                              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. LED 제어 = digitalWrite(pin, HIGH/LOW)               │
│                                                         │
│  2. 버튼 읽기 = digitalRead(pin)                          │
│     - 반드시 풀업 또는 풀다운 저항 필요                      │
│     - INPUT_PULLUP 사용 시 외부 저항 불필요                 │
│                                                         │
│  3. 디바운싱 = millis() 활용 시간 기반 필터                  │
│     - 50ms 간격으로 버튼 상태 변화 무시                      │
│     - delay() 대신 millis() 사용 권장                      │
│                                                         │
│  4. 인터럽트 = 폴링보다 효율적인 이벤트 감지                   │
│     - ISR은 짧고 빠르게                                    │
│     - volatile 변수 사용 필수                              │
│     - IRAM_ATTR 속성 필수 (ESP32)                         │
│                                                         │
│  5. 상태 머신 = 복잡한 동작을 체계적으로 관리                   │
│     - 각 상태를 명확히 정의                                 │
│     - 전환 조건을 명시                                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

*다음 프로젝트: [프로젝트 2 - 아날로그 센서 읽기 (MQ-2)](../project2-analog-sensor/README.md)*
