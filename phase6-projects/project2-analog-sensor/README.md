# 프로젝트 2: 아날로그 센서 읽기 (MQ-2 가스센서)

## 프로젝트 개요

이 프로젝트에서는 MQ-2 가스센서를 사용하여 아날로그 값을 읽고 해석하는 방법을
학습합니다. ESP32의 ADC(아날로그-디지털 변환기)를 사용하여 센서의 아날로그 출력을
디지털 값으로 변환하고, 가스 농도에 따른 경고 시스템을 구축합니다.

이동 평균 필터를 적용하여 노이즈를 제거하고, 시리얼 플로터를 활용한
실시간 그래프 모니터링 기능도 구현합니다.

**난이도:** ★★☆☆☆ (초급)
**예상 소요 시간:** 3~4시간
**선수 지식:** 프로젝트 1 완료, 옴의 법칙 기초

---

## 학습 목표

1. **ADC 사용법** - ESP32의 12비트 ADC로 아날로그 전압 읽기
2. **전압분배기 이해** - 센서 출력과 ADC 입력 범위 매칭
3. **MQ-2 센서 원리** - 가스 감지 메커니즘과 예열 과정
4. **아날로그-디지털 변환** - ADC 값 → 전압 → 의미 있는 단위 변환
5. **이동 평균 필터** - 소프트웨어로 노이즈 제거
6. **임계값 기반 경고** - 다단계 경고 시스템 구현
7. **시리얼 플로터 활용** - 실시간 데이터 시각화

---

## MQ-2 가스센서 소개

### 감지 가능 가스
- LPG (액화 석유 가스)
- 프로판 (Propane)
- 수소 (Hydrogen)
- 메탄 (Methane)
- 연기 (Smoke)
- 알코올 (Alcohol)

### 센서 모듈 구성

```
    MQ-2 센서 모듈
    ┌─────────────────────┐
    │  ┌───────────┐      │
    │  │           │      │
    │  │  [센서    │      │
    │  │   소자]   │      │   핀 설명:
    │  │           │      │   VCC  = 전원 입력 (5V)
    │  └───────────┘      │   GND  = 접지
    │                     │   AOUT = 아날로그 출력 (0~3.3V)
    │  [가변저항]  [LED]   │   DOUT = 디지털 출력 (가변저항으로 임계값 설정)
    │                     │
    │  VCC GND DOUT AOUT  │
    └──┬───┬───┬────┬────┘
       │   │   │    │
```

### 동작 원리

```
    MQ-2 센서 내부 구조:

    히터 코일 (가열 소자)
    ┌─────────────────────────┐
    │ ~~~~~~~~~~~~~~~~~~~~~~~~│  ← 히터: SnO2 표면을 200~300°C로 가열
    │                         │
    │    SnO2 (감지 물질)      │  ← 가스 흡착 시 저항값 변화
    │  ┌───────────────────┐  │
    │  │ ○ ○ ○ ○ ○ ○ ○ ○  │  │  ← 깨끗한 공기: 저항 높음
    │  │ ○ ● ○ ● ○ ○ ● ○  │  │  ← 가스 존재: 저항 낮아짐
    │  └───────────────────┘  │
    │                         │
    └─────────────────────────┘

    가스 농도 ↑ → 센서 저항 ↓ → 출력 전압 ↑
```

### 예열 과정
- MQ-2는 처음 사용 시 **24~48시간** 예열 권장
- 매 사용 시 최소 **2~3분** 예열 필요
- 예열 중에는 값이 불안정 (점차 안정화됨)

---

## ESP32 ADC 사용법

### ADC 기본 개념

```
    아날로그 입력                  디지털 출력
    (연속적인 전압)               (이산적인 값)

    3.3V ─────────────┐         4095 ─────────┐
                      │                       │
    2.5V ───────┐     │         3103 ───┐     │
                │     │                 │     │
    1.65V ──┐   │     │         2048 ─┐ │     │
            │   │     │               │ │     │
    0V ─────┴───┴─────┘         0 ───┴─┴─────┘

    ESP32 ADC: 12비트 해상도
    범위: 0V ~ 3.3V → 0 ~ 4095
    분해능: 3.3V / 4096 ≈ 0.8mV
```

### ESP32 ADC 주의사항

```
    ESP32 ADC 비선형성 문제:

    이상적인 ADC         실제 ESP32 ADC
    (직선 응답)          (비선형 응답)

    4095│      ╱         4095│        ╱──
        │    ╱               │      ╱
        │  ╱                 │    ╱
        │╱                   │  ╱
    0   └──────              │╱
        0   3.3V             └───────
                             0   3.3V

    - 0V 근처와 3.3V 근처에서 정확도가 떨어짐
    - 0.1V ~ 3.1V 범위에서 가장 정확
    - ADC2는 WiFi 사용 시 사용 불가 (ADC1 사용 권장!)
```

### ADC1 사용 가능 핀 (WiFi와 충돌 없음)
| 채널 | GPIO 핀 |
|------|---------|
| ADC1_CH0 | GPIO36 (VP) |
| ADC1_CH3 | GPIO39 (VN) |
| ADC1_CH4 | GPIO32 |
| ADC1_CH5 | GPIO33 |
| ADC1_CH6 | GPIO34 |
| ADC1_CH7 | GPIO35 |

---

## 필요 부품 목록

| 부품 | 수량 | 규격 | 비고 |
|------|------|------|------|
| ESP32 DevKit V1 | 1 | | |
| MQ-2 가스센서 모듈 | 1 | 4핀 모듈 | AOUT 핀 사용 |
| LED (빨강) | 1 | 5mm | 위험 경고용 |
| LED (노랑) | 1 | 5mm | 주의 경고용 |
| LED (초록) | 1 | 5mm | 정상 상태용 |
| 능동 부저 | 1 | 5V | 경고음용 |
| 저항 220옴 | 3 | 1/4W | LED 전류 제한 |
| 저항 1K옴 | 1 | 1/4W | 부저용 (필요 시) |
| 브레드보드 | 1 | 830홀 | |
| 점퍼 와이어 | 약 12개 | M-M, M-F | |

---

## 회로 연결도

### 전체 회로

```
                        ESP32 DevKit V1
                    ┌─────────────────────┐
                    │                     │
              3.3V ─┤ 3V3          GND   ├─── GND 공통
                    │ EN           D23   │
         MQ-2 AOUT ─┤ VP(D36)      D22   │
                    │ VN(D39)      TX0   │
                    │ D34          RX0   │
                    │ D35          D21   │
                    │ D32          D19   │──── LED_RED ──── R(220Ω) ── GND
                    │ D33          D18   │──── LED_YEL ──── R(220Ω) ── GND
                    │ D25          D5    │
                    │ D26          D17   │──── LED_GRN ──── R(220Ω) ── GND
                    │ D27          D16   │──── BUZZER ──────────────── GND
                    │ D14          D4    │
                    │ D12          D2    │
                    │ D13          D15   │
                    │ GND          GND   │
              5V ───┤ VIN          3V3   │
                    └─────────────────────┘
```

### MQ-2 센서 연결 상세

```
    MQ-2 모듈              ESP32
    ┌──────────┐
    │  VCC  ───┼──────────── VIN (5V)
    │  GND  ───┼──────────── GND
    │  AOUT ───┼──────────── GPIO36 (VP, ADC1_CH0)
    │  DOUT    │  (미사용)
    └──────────┘

    주의: MQ-2 모듈은 5V 전원이 필요하지만
          AOUT 출력은 0~3.3V 범위 (모듈 내장 회로)
          만약 AOUT 출력이 5V까지인 모듈이라면
          아래의 전압분배기를 사용하세요.
```

### 전압분배기 회로 (5V→3.3V 변환이 필요한 경우)

```
    센서 AOUT (0~5V)
         │
         │
    R1 (2KΩ)        전압분배기 공식:
         │            Vout = Vin × R2 / (R1 + R2)
         ├──────── ESP32 GPIO36 (ADC 입력)
         │            Vout = 5V × 3.3K / (2K + 3.3K)
    R2 (3.3KΩ)             = 5V × 0.623
         │                  = 3.1V (안전 범위)
         │
        GND

    ※ 대부분의 MQ-2 모듈은 내장 회로로
       3.3V 범위 출력을 제공합니다.
       모듈 스펙을 확인하세요.
```

### LED 경고 시스템 연결

```
    경고 레벨 표시:

    GPIO19 ──── R(220Ω) ──── LED(빨강) ──── GND   ← 위험 (가스 농도 높음)
    GPIO18 ──── R(220Ω) ──── LED(노랑) ──── GND   ← 주의 (가스 농도 중간)
    GPIO17 ──── R(220Ω) ──── LED(초록) ──── GND   ← 정상 (가스 농도 낮음)
    GPIO16 ──── BUZZER ──────────────── GND        ← 경고음 (위험 시)
```

---

## 센서 값 해석 방법

### ADC 값 → 전압 변환

```
    전압(V) = ADC값 × (3.3 / 4095)

    예시:
    ADC = 0    → 0.000V (가스 없음)
    ADC = 1000 → 0.806V
    ADC = 2048 → 1.650V (중간값)
    ADC = 3000 → 2.418V
    ADC = 4095 → 3.300V (최대)
```

### 가스 농도 임계값 (참고 - 환경에 따라 조정 필요)

```
    ADC 값       상태          LED        부저
    ──────────────────────────────────────────────
    0 ~ 1000     정상          초록 ON     OFF
    1001 ~ 2000  주의          노랑 ON     OFF
    2001 ~ 3000  경고          빨강 점멸    간헐적
    3001 ~ 4095  위험          빨강 ON      연속

    ※ 이 값은 참고용이며, 실제 환경과 용도에 따라
       반드시 캘리브레이션이 필요합니다.
```

---

## 단계별 구현 가이드

### 단계 1: ADC 기본 읽기
```
목표: analogRead()로 센서 값을 읽어 시리얼 모니터에 출력
핵심: analogRead(), Serial.println()
```
1. MQ-2 센서를 연결하고 2~3분 예열
2. `analogRead(36)`으로 ADC 값 읽기
3. 시리얼 모니터에 값 출력 (1초 간격)

### 단계 2: 전압 변환
```
목표: ADC 값을 전압(V)으로 변환하여 출력
핵심: 변환 공식 적용, 소수점 출력
```

### 단계 3: 이동 평균 필터 적용
```
목표: 노이즈가 제거된 안정적인 센서 값 획득
핵심: 원형 버퍼, 이동 평균 계산
```
1. 10개 샘플을 저장하는 배열 생성
2. 새 샘플이 들어오면 가장 오래된 샘플 대체
3. 배열의 평균값을 사용

### 단계 4: LED 경고 시스템
```
목표: 가스 농도에 따라 적절한 LED 켜기
핵심: 임계값 비교, 다단계 분기
```

### 단계 5: 부저 경고
```
목표: 위험 수준에서 경고음 출력
핵심: tone() 또는 디지털 출력 PWM
```

### 단계 6: 시리얼 플로터용 출력
```
목표: Arduino IDE 시리얼 플로터에서 실시간 그래프 표시
핵심: 쉼표로 구분된 값 출력 형식
```

---

## 이동 평균 필터 설명

```
    원시 데이터 (노이즈 포함):
    ┌─────────────────────────────────────────┐
    │     ╱╲    ╱╲                            │
    │    ╱  ╲  ╱  ╲   ╱╲      ╱╲             │
    │───╱────╲╱────╲─╱──╲────╱──╲──────      │
    │  ╱              ╲  ╲  ╱    ╲            │
    │ ╱                ╲  ╲╱      ╲           │
    └─────────────────────────────────────────┘

    이동 평균 필터 적용 후:
    ┌─────────────────────────────────────────┐
    │                                         │
    │      ╱─╲                                │
    │────╱────╲───────╱╲────────────────      │
    │  ╱       ╲     ╱  ╲                     │
    │ ╱         ╲───╱    ╲───                 │
    └─────────────────────────────────────────┘

    이동 평균 계산 (윈도우 크기 = 5):
    샘플: [120, 135, 118, 142, 125]
    평균: (120 + 135 + 118 + 142 + 125) / 5 = 128

    새 샘플 130 추가:
    샘플: [135, 118, 142, 125, 130]  ← 가장 오래된 120 제거
    평균: (135 + 118 + 142 + 125 + 130) / 5 = 130
```

---

## 트러블슈팅 가이드

### 문제 1: ADC 값이 항상 0
```
확인 사항:
□ MQ-2 센서에 5V 전원이 공급되고 있는가?
□ AOUT 핀이 올바른 GPIO에 연결되었는가?
□ GPIO36(VP)을 사용하고 있는가? (ADC1 권장)
□ 센서 모듈의 LED가 켜져 있는가? (전원 확인)

해결: 멀티미터로 AOUT 핀의 전압을 직접 측정
```

### 문제 2: 값이 매우 불안정 (크게 튀는 경우)
```
원인:
- 센서 예열 부족 (최소 2~3분 대기)
- 전원 노이즈
- 배선 접촉 불량

해결:
1. 센서 예열 시간 충분히 확보
2. 이동 평균 필터 윈도우 크기 늘리기 (10 → 20)
3. 센서 AOUT과 GND 사이에 100nF 커패시터 추가
4. 배선 길이 최소화
```

### 문제 3: WiFi 사용 시 ADC 값이 이상
```
원인: ADC2 채널을 사용 중 (WiFi와 충돌)
해결: ADC1 채널 핀으로 변경 (GPIO32~36, 39)
```

### 문제 4: 가스를 가까이해도 값이 변하지 않음
```
확인 사항:
□ 예열 시간이 충분한가? (첫 사용 시 24시간 권장)
□ 가변저항이 올바르게 조정되었는가?
□ DOUT 대신 AOUT을 사용하고 있는가?
□ 감지 가능한 가스 종류인가?
```

---

## 핵심 정리

```
┌─────────────────────────────────────────────────────────┐
│                    핵심 정리                              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. ESP32 ADC = 12비트 (0~4095), 0~3.3V 범위            │
│     - ADC1 사용 권장 (WiFi와 충돌 없음)                   │
│     - GPIO36, 39, 32~35 = ADC1 채널                     │
│                                                         │
│  2. 전압 변환 공식:                                       │
│     전압(V) = ADC값 × (3.3 / 4095)                       │
│                                                         │
│  3. 전압분배기:                                           │
│     Vout = Vin × R2 / (R1 + R2)                         │
│     5V → 3.3V: R1=2KΩ, R2=3.3KΩ                        │
│                                                         │
│  4. 이동 평균 필터:                                       │
│     - 최근 N개 샘플의 평균을 사용                          │
│     - N이 클수록 안정적이지만 응답이 느림                    │
│     - 원형 버퍼로 효율적 구현                              │
│                                                         │
│  5. MQ-2 센서:                                           │
│     - 예열 필수 (최소 2~3분)                              │
│     - 가스 농도 ↑ → 저항 ↓ → 출력 전압 ↑                  │
│     - 캘리브레이션 필수 (환경에 따라 다름)                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

*이전 프로젝트: [프로젝트 1 - LED + 버튼 제어](../project1-led-button/README.md)*
*다음 프로젝트: [프로젝트 3 - I2C 센서 연결](../project3-i2c-sensor/README.md)*
