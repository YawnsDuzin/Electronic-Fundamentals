# 02. ADC (Analog to Digital Converter) - 아날로그-디지털 변환기

## 개요

ADC는 **연속적인 아날로그 신호**(전압)를 **이산적인 디지털 숫자**로 변환하는 장치입니다.
현실 세계의 온도, 빛, 소리 등은 모두 아날로그 값이며, 마이크로컨트롤러가 이를 처리하려면
디지털로 변환해야 합니다.

> **소프트웨어 비유**: ADC는 `parseInt()` 또는 `Math.round()`와 비슷합니다.
> 연속적인 실수(3.14159...)를 정수(3)로 변환하는 것처럼,
> 연속적인 전압을 정수 값으로 변환합니다.

---

## 1. 아날로그 vs 디지털 신호

```
[아날로그 신호 - 연속적]           [디지털 신호 - 이산적]

전압                               전압
 │    ╭─╮                          │    ┌─┐
 │   ╱   ╲                         │    │ │
 │  ╱     ╲    ╭─                  │  ┌─┘ └─┐   ┌─
 │ ╱       ╲  ╱                    │  │     │   │
 │╱         ╲╱                     │──┘     └───┘
 └──────────────▶ 시간             └──────────────▶ 시간

 무한히 세밀한 값 가능               정해진 단계(step)만 가능
 예: 1.234V, 1.235V, ...           예: 0, 1, 2, 3, ... 4095
```

### 실제 예시

| 구분 | 아날로그 | 디지털 |
|------|---------|--------|
| 온도 | 수은 온도계 (연속적) | 디지털 온도계 (0.1도 단위) |
| 오디오 | 바이닐 레코드 | MP3 파일 |
| 시계 | 아날로그 시계 (초침 연속) | 디지털 시계 (1초 단위) |

---

## 2. ESP32 ADC 특성

### 기본 사양

| 특성 | 값 | 설명 |
|------|-----|------|
| **해상도** | 12비트 | 0 ~ 4095 (2^12 = 4096 단계) |
| **입력 전압 범위** | 0 ~ 3.3V | 기본 설정 기준 |
| **ADC 유닛** | 2개 | ADC1 (8채널), ADC2 (10채널) |
| **샘플링 속도** | ~20,000 회/초 | 소프트웨어 제어 시 |

### 해상도 시각화

```
입력 전압:  0V ─────────────────────────────── 3.3V
            │                                    │
ADC 값:     0 ─────────────────────────────── 4095
            │         │         │         │      │
           0V      0.825V    1.65V     2.475V  3.3V

1 스텝(step) = 3.3V / 4095 ≈ 0.000806V ≈ 0.8mV
```

---

## 3. ADC1 vs ADC2

```
┌─────────────────────────────────────────────────┐
│                    ESP32                         │
│                                                  │
│  ┌─────────────┐       ┌─────────────┐          │
│  │    ADC1      │       │    ADC2      │          │
│  │              │       │              │          │
│  │ GPIO 32 (CH4)│       │ GPIO 4  (CH0)│          │
│  │ GPIO 33 (CH5)│       │ GPIO 0  (CH1)│          │
│  │ GPIO 34 (CH6)│       │ GPIO 2  (CH2)│          │
│  │ GPIO 35 (CH7)│       │ GPIO 15 (CH3)│          │
│  │ GPIO 36 (CH0)│       │ GPIO 13 (CH4)│          │
│  │ GPIO 39 (CH3)│       │ GPIO 12 (CH5)│          │
│  │              │       │ GPIO 14 (CH6)│          │
│  │              │       │ GPIO 27 (CH7)│          │
│  │  항상 사용   │       │ GPIO 25 (CH8)│          │
│  │    가능!     │       │ GPIO 26 (CH9)│          │
│  │              │       │              │          │
│  │              │       │ WiFi 사용 시 │          │
│  │              │       │  사용 불가!  │          │
│  └─────────────┘       └─────────────┘          │
└─────────────────────────────────────────────────┘
```

> **중요**: WiFi를 사용하는 프로젝트에서는 **반드시 ADC1 핀**을 사용하세요!
> ADC2는 WiFi 드라이버와 내부적으로 공유되어 WiFi 활성화 시 사용할 수 없습니다.

### 추천 ADC 핀

| 우선순위 | GPIO | ADC 채널 | 비고 |
|---------|------|----------|------|
| 1순위 | GPIO 32 | ADC1_CH4 | 안전하게 사용 가능 |
| 1순위 | GPIO 33 | ADC1_CH5 | 안전하게 사용 가능 |
| 1순위 | GPIO 34 | ADC1_CH6 | 입력 전용 (내부 풀업 없음) |
| 1순위 | GPIO 35 | ADC1_CH7 | 입력 전용 (내부 풀업 없음) |
| 1순위 | GPIO 36 | ADC1_CH0 | 입력 전용 (VP) |
| 1순위 | GPIO 39 | ADC1_CH3 | 입력 전용 (VN) |

---

## 4. 아날로그 값에서 실제 전압 변환

### 변환 공식

```
전압 (V) = ADC 읽은 값 × (3.3V / 4095)
```

### 변환 예시

| ADC 값 | 계산 | 전압 |
|--------|------|------|
| 0 | 0 × (3.3 / 4095) | 0.000V |
| 1024 | 1024 × (3.3 / 4095) | 0.825V |
| 2048 | 2048 × (3.3 / 4095) | 1.650V |
| 3072 | 3072 × (3.3 / 4095) | 2.475V |
| 4095 | 4095 × (3.3 / 4095) | 3.300V |

### 코드

```cpp
const int ADC_PIN = 34;  // GPIO 34 (ADC1_CH6)

void setup() {
    Serial.begin(115200);
}

void loop() {
    int adcValue = analogRead(ADC_PIN);  // 0 ~ 4095
    float voltage = adcValue * (3.3 / 4095.0);

    Serial.print("ADC 값: ");
    Serial.print(adcValue);
    Serial.print(" → 전압: ");
    Serial.print(voltage, 3);  // 소수점 3자리
    Serial.println("V");

    delay(500);
}
```

---

## 5. 감쇠(Attenuation) 설정

ESP32 ADC의 입력 전압 범위를 조절할 수 있습니다.

| 감쇠 설정 | 최대 입력 전압 | 상수 | 정확도 최적 범위 |
|-----------|---------------|------|-----------------|
| 0dB | ~1.1V | `ADC_0db` | 100 ~ 950 mV |
| 2.5dB | ~1.5V | `ADC_2_5db` | 100 ~ 1250 mV |
| 6dB | ~2.2V | `ADC_6db` | 150 ~ 1750 mV |
| **11dB** | **~3.3V** | `ADC_11db` | **150 ~ 2450 mV** |

> **기본 설정**: Arduino 프레임워크에서는 `ADC_11db` (0~3.3V)가 기본값입니다.

### 감쇠 설정 코드

```cpp
void setup() {
    Serial.begin(115200);

    // 감쇠 설정 (선택사항 - 기본값은 11dB)
    analogSetAttenuation(ADC_11db);  // 전체 ADC 설정

    // 특정 핀만 설정할 수도 있음
    // analogSetPinAttenuation(34, ADC_11db);
}
```

---

## 6. ADC 비선형성 문제와 보정

### 문제점

ESP32의 ADC는 **완벽하게 선형적이지 않습니다**.
특히 0V 근처와 3.3V 근처에서 정확도가 떨어집니다.

```
이상적인 ADC:                    실제 ESP32 ADC:
ADC값                            ADC값
4095 ┤              ╱             4095 ┤            ╱──
     │            ╱                    │          ╱
     │          ╱                      │        ╱
     │        ╱                        │      ╱
     │      ╱                          │    ╱
     │    ╱                            │  ╱
     │  ╱                              │╱
   0 ┤╱                              0 ┤
     └──────────────                   └──────────────
     0V           3.3V                 0V           3.3V
                                       ↑             ↑
                                    비선형 구간    비선형 구간
```

### 보정 방법

#### 방법 1: 다중 샘플 평균 (간단)

```cpp
int readADC_Averaged(int pin, int samples) {
    long sum = 0;
    for (int i = 0; i < samples; i++) {
        sum += analogRead(pin);
        delayMicroseconds(100);  // 샘플 간 짧은 대기
    }
    return sum / samples;
}

// 사용: 64회 읽어서 평균
int smoothValue = readADC_Averaged(34, 64);
```

#### 방법 2: 룩업 테이블 보정 (정밀)

```cpp
// 실측 데이터로 보정 테이블 작성
// 실제 전압(mV) → 기대 ADC 값 매핑
float calibrateADC(int rawValue) {
    // 실측 기반 간단 다항식 보정 (예시)
    float voltage = -0.000000000000016 * pow(rawValue, 4)
                  + 0.000000000118171 * pow(rawValue, 3)
                  - 0.000000301211691 * pow(rawValue, 2)
                  + 0.001109019271794 * rawValue
                  + 0.034143524634089;
    return voltage;  // 볼트 단위 반환
}
```

#### 방법 3: ESP-IDF의 esp_adc_cal 라이브러리 (권장)

```cpp
#include <esp_adc_cal.h>

esp_adc_cal_characteristics_t adcChars;

void setup() {
    Serial.begin(115200);

    // ADC 보정 특성 로드
    esp_adc_cal_characterize(
        ADC_UNIT_1,           // ADC 유닛
        ADC_ATTEN_DB_11,      // 감쇠
        ADC_WIDTH_BIT_12,     // 해상도
        1100,                 // 기본 참조 전압 (mV)
        &adcChars             // 결과 저장
    );
}

void loop() {
    uint32_t voltage_mV;
    esp_adc_cal_get_voltage(ADC_CHANNEL_6, &adcChars, &voltage_mV);

    Serial.print("보정된 전압: ");
    Serial.print(voltage_mV);
    Serial.println(" mV");

    delay(500);
}
```

---

## 7. 아날로그 센서 연결법

### 가변저항 (전압 분배기)

```
  3.3V
   │
   ┤ 가변저항 (10kΩ)
   │ ↕ 회전
   ├──────── GPIO 34 (ADC 입력)
   │
   ┤
   │
  GND

회전에 따라 0V ~ 3.3V 범위의 전압이 GPIO 34에 입력됨
```

### 가스 센서 (MQ-2 등)

```
  5V (VIN) ──────── VCC
                     │
               ┌─────┤ MQ-2
               │     │ 가스센서
  GPIO 34 ─────┤     │
  (ADC 입력)   │     │
               └─────┤
                     │
  GND ───────────── GND

주의: MQ-2의 아날로그 출력은 보통 0~5V이므로
      전압 분배기(저항 2개)로 3.3V 이하로 낮춰야 함!
```

### 전압 분배기로 5V → 3.3V 변환

```
센서 출력 (0~5V) ────┤1kΩ├────┬───── GPIO 34 (ADC 입력)
                              │       (0 ~ 3.3V 범위)
                             [2kΩ]
                              │
                             GND

변환 비율: 2kΩ / (1kΩ + 2kΩ) = 2/3
최대 출력: 5V × 2/3 = 3.33V ≈ 3.3V (안전!)
```

### 조도 센서 (CdS 포토레지스터)

```
  3.3V
   │
  [CdS] ← 빛에 따라 저항값 변화
   │         밝을 때: 수kΩ, 어두울 때: 수백kΩ
   ├──────── GPIO 34 (ADC 입력)
   │
  [10kΩ]  ← 고정 저항
   │
  GND

밝을 때: CdS 저항↓ → 전압↑ → ADC 값↑
어두울 때: CdS 저항↑ → 전압↓ → ADC 값↓
```

---

## 핵심 정리

| 개념 | 설명 |
|------|------|
| **ADC** | 아날로그 전압을 디지털 숫자(0~4095)로 변환 |
| **해상도** | 12비트 = 4096 단계, 1 스텝 ≈ 0.8mV |
| **ADC1** | GPIO 32~39, WiFi와 무관하게 항상 사용 가능 |
| **ADC2** | GPIO 0~27 일부, WiFi 사용 시 사용 불가 |
| **감쇠** | 입력 전압 범위 설정 (기본 11dB = 0~3.3V) |
| **비선형성** | 0V/3.3V 근처 부정확 → 다중 샘플 평균 또는 보정 라이브러리 사용 |
| **전압 변환 공식** | `전압 = ADC값 × (3.3 / 4095)` |
| **전압 분배기** | 5V 센서 출력을 3.3V 이하로 낮추는 회로 |

---

## 실습 과제

1. 가변저항을 돌려서 ADC 값과 전압을 시리얼 모니터에 출력하기
2. 조도 센서를 연결하여 밝기 레벨을 0~100%로 표시하기
3. 64회 평균값으로 노이즈를 줄인 ADC 읽기 함수 작성하기
4. (도전) ADC 값으로 LED 밝기 제어하기 (ADC + PWM 결합)

---

## 관련 코드 예제

- [adc_read.ino](./code/adc_read.ino) - ADC 값 읽기 + 전압 변환 전체 코드
