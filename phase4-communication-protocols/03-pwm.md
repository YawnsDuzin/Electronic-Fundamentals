# 03. PWM (Pulse Width Modulation) - 펄스 폭 변조

## 개요

PWM(Pulse Width Modulation)은 **디지털 출력으로 아날로그 효과를 흉내내는 기술**입니다.
HIGH와 LOW를 매우 빠르게 전환하면서, HIGH 상태의 비율(듀티 사이클)을 조절하여
마치 중간 전압을 출력하는 것과 같은 효과를 만듭니다.

> **소프트웨어 비유**: CSS의 `opacity` 속성과 비슷합니다.
> `opacity: 0.5`는 실제로 반투명한 것이 아니라,
> 렌더링 엔진이 색상을 혼합하여 "반투명처럼 보이게" 하는 것입니다.
> PWM도 마찬가지로 빠른 on/off로 "중간 밝기처럼 보이게" 합니다.

---

## 1. PWM의 원리: 듀티 사이클 (Duty Cycle)

```
듀티 사이클 = HIGH 시간 / 전체 주기 × 100%

[듀티 사이클 0% - 완전 OFF]
 0V  ──────────────────────────────────────   평균 전압: 0V

[듀티 사이클 25% - 약한 출력]
3.3V ┌──┐          ┌──┐          ┌──┐
 0V  ┘  └──────────┘  └──────────┘  └────   평균 전압: 0.825V

[듀티 사이클 50% - 중간 출력]
3.3V ┌─────┐     ┌─────┐     ┌─────┐
 0V  ┘     └─────┘     └─────┘     └─────   평균 전압: 1.65V

[듀티 사이클 75% - 강한 출력]
3.3V ┌──────────┐  ┌──────────┐  ┌────────
 0V  ┘          └──┘          └──┘           평균 전압: 2.475V

[듀티 사이클 100% - 완전 ON]
3.3V ──────────────────────────────────────   평균 전압: 3.3V
```

### 평균 전압 계산

```
평균 전압 = 최대 전압 × (듀티 사이클 / 100)

예) 듀티 사이클 50%:
    평균 전압 = 3.3V × (50/100) = 1.65V
```

---

## 2. 주파수와 해상도

### 주파수 (Frequency)

PWM 주파수는 **1초에 몇 번 on/off를 반복하는지**를 나타냅니다.

```
주파수 낮음 (100Hz):
┌────┐    ┌────┐    ┌────┐
│    │    │    │    │    │      LED가 깜빡거림 (눈에 보임)
┘    └────┘    └────┘    └────
◀──10ms──▶

주파수 높음 (5000Hz):
┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐
│││││││││││││││││││││││││      LED가 부드럽게 보임
┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└
◀0.2ms▶
```

| 주파수 | 용도 |
|--------|------|
| 50Hz | 서보모터 제어 |
| 500~1000Hz | DC 모터 속도 제어 |
| 5000Hz | LED 밝기 조절 (권장) |
| 25kHz | 팬(fan) 속도 제어 |

### 해상도 (Resolution)

해상도는 듀티 사이클을 **몇 단계로 나눌 수 있는지**를 결정합니다.

| 비트 수 | 단계 수 | 최대값 | 예시 |
|---------|--------|--------|------|
| 8비트 | 256 | 255 | 밝기를 256단계로 조절 |
| 10비트 | 1024 | 1023 | 밝기를 1024단계로 조절 |
| **12비트** | **4096** | **4095** | **밝기를 4096단계로 조절** |
| 13비트 | 8192 | 8191 | 매우 세밀한 조절 |

> **주의**: 주파수와 해상도는 반비례 관계입니다.
> 주파수를 높이면 사용 가능한 최대 해상도가 줄어듭니다.
>
> ```
> 최대 해상도(비트) = log2(80MHz / 주파수)
> 예) 5000Hz → log2(80000000/5000) = log2(16000) ≈ 13.9비트
> ```

---

## 3. ESP32 LEDC PWM 채널

ESP32는 **LEDC(LED Control)** 주변장치를 통해 PWM을 생성합니다.
총 **16개의 독립적인 PWM 채널**이 있습니다.

```
┌──────────────────────────────────────────┐
│             ESP32 LEDC PWM               │
│                                          │
│  고속 채널 (80MHz 클럭)                  │
│  ┌────┬────┬────┬────┬────┬────┬────┬────┐
│  │CH 0│CH 1│CH 2│CH 3│CH 4│CH 5│CH 6│CH 7│
│  └──┬─┴──┬─┴──┬─┴──┬─┴──┬─┴──┬─┴──┬─┴──┬─┘
│     │    │    │    │    │    │    │    │
│     ▼    ▼    ▼    ▼    ▼    ▼    ▼    ▼
│   아무 GPIO 핀에나 연결 가능!            │
│                                          │
│  저속 채널 (8MHz 클럭)                   │
│  ┌────┬────┬────┬────┬────┬────┬────┬────┐
│  │CH 8│CH 9│CH10│CH11│CH12│CH13│CH14│CH15│
│  └──┬─┴──┬─┴──┬─┴──┬─┴──┬─┴──┬─┴──┬─┴──┬─┘
│     │    │    │    │    │    │    │    │
│     ▼    ▼    ▼    ▼    ▼    ▼    ▼    ▼
│   아무 GPIO 핀에나 연결 가능!            │
└──────────────────────────────────────────┘

* 채널 → 핀 매핑은 자유롭게 설정 가능
* 같은 채널을 여러 핀에 연결하면 같은 PWM 출력
```

### LEDC API 사용법 (Arduino)

```cpp
// ===== ESP32 Arduino 코어 v2.x (구버전 API) =====
// 1단계: 채널 설정
ledcSetup(channel, frequency, resolution);
// 예: ledcSetup(0, 5000, 8);  // 채널0, 5kHz, 8비트

// 2단계: 채널과 핀 연결
ledcAttachPin(pin, channel);
// 예: ledcAttachPin(2, 0);  // GPIO 2를 채널 0에 연결

// 3단계: 듀티 사이클 설정
ledcWrite(channel, dutyCycle);
// 예: ledcWrite(0, 128);  // 채널0에 50% 듀티 (8비트: 0~255)


// ===== ESP32 Arduino 코어 v3.x (새 API) =====
// 1단계: 핀에 직접 PWM 설정
ledcAttach(pin, frequency, resolution);
// 예: ledcAttach(2, 5000, 8);  // GPIO 2, 5kHz, 8비트

// 2단계: 듀티 사이클 설정
ledcWrite(pin, dutyCycle);
// 예: ledcWrite(2, 128);  // GPIO 2에 50% 듀티 (8비트: 0~255)
```

---

## 4. 용도별 PWM 활용

### 4.1 LED 밝기 조절

```
ESP32                        LED
GPIO 2 ──────┤220Ω├──────►|────── GND

듀티 사이클 0%   → LED 꺼짐
듀티 사이클 50%  → LED 절반 밝기
듀티 사이클 100% → LED 최대 밝기
```

```cpp
const int LED_PIN = 2;
const int PWM_CHANNEL = 0;
const int PWM_FREQ = 5000;     // 5kHz
const int PWM_RESOLUTION = 8;  // 8비트 (0~255)

void setup() {
    ledcSetup(PWM_CHANNEL, PWM_FREQ, PWM_RESOLUTION);
    ledcAttachPin(LED_PIN, PWM_CHANNEL);
}

void loop() {
    // 서서히 밝아지기
    for (int duty = 0; duty <= 255; duty++) {
        ledcWrite(PWM_CHANNEL, duty);
        delay(10);
    }
    // 서서히 어두워지기
    for (int duty = 255; duty >= 0; duty--) {
        ledcWrite(PWM_CHANNEL, duty);
        delay(10);
    }
}
```

### 4.2 서보모터 제어

서보모터는 PWM 신호의 **펄스 폭**으로 각도를 제어합니다.

```
          ┌─────────────────────────────────────┐
          │         서보모터 PWM 신호            │
          │                                     │
 0도:     │  ┌─┐                                │
          │  │1ms                               │
          │  └─────────────────────┘             │  주기: 20ms
          │  ◀────── 20ms ────────▶             │  (50Hz)
          │                                     │
 90도:    │  ┌───┐                              │
          │  │1.5ms                             │
          │  └───────────────────┘               │
          │                                     │
 180도:   │  ┌─────┐                            │
          │  │  2ms                             │
          │  └─────────────────┘                 │
          └─────────────────────────────────────┘
```

```cpp
const int SERVO_PIN = 18;
const int PWM_CHANNEL = 1;

void setup() {
    // 서보: 50Hz, 16비트 해상도
    ledcSetup(PWM_CHANNEL, 50, 16);
    ledcAttachPin(SERVO_PIN, PWM_CHANNEL);
}

// 각도 → 듀티 값 변환
void setServoAngle(int angle) {
    // 50Hz, 16비트에서:
    // 1ms = 3277,  1.5ms = 4915,  2ms = 6554
    int duty = map(angle, 0, 180, 3277, 6554);
    ledcWrite(PWM_CHANNEL, duty);
}

void loop() {
    setServoAngle(0);    // 0도
    delay(1000);
    setServoAngle(90);   // 90도
    delay(1000);
    setServoAngle(180);  // 180도
    delay(1000);
}
```

### 4.3 DC 모터 속도 제어

```
ESP32                   L298N 모터 드라이버          모터
GPIO 25 (PWM) ─────── ENA (속도)         ┌──── OUT1 ───── M+
GPIO 26 ───────────── IN1 (방향)  ───────┤
GPIO 27 ───────────── IN2 (방향)  ───────┘     OUT2 ───── M-
                                                │
                                          외부 전원 (12V 등)
```

```cpp
const int ENA_PIN = 25;  // PWM으로 속도 제어
const int IN1_PIN = 26;  // 방향 제어
const int IN2_PIN = 27;  // 방향 제어

void setup() {
    ledcSetup(0, 1000, 8);  // 1kHz, 8비트
    ledcAttachPin(ENA_PIN, 0);
    pinMode(IN1_PIN, OUTPUT);
    pinMode(IN2_PIN, OUTPUT);
}

void motorForward(int speed) {
    digitalWrite(IN1_PIN, HIGH);
    digitalWrite(IN2_PIN, LOW);
    ledcWrite(0, speed);  // 0~255
}

void motorStop() {
    ledcWrite(0, 0);
}
```

---

## 5. 아날로그 출력을 흉내내는 원리

### PWM이 아날로그처럼 느껴지는 이유

```
PWM 50% (5kHz):

3.3V ┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐
     ││││││││││││││││││││││││││││││││││││││││
 0V  ┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└

     ↓  로우패스 필터 (RC 회로) 또는 인간의 눈/관성  ↓

     ──────────────────────────────────────────
1.65V (평균)
     ──────────────────────────────────────────

사람의 눈은 약 60Hz 이상의 깜빡임을 감지하지 못합니다.
5kHz PWM은 충분히 빠르므로 LED의 밝기가 일정해 보입니다.

모터의 관성도 마찬가지로 빠른 on/off를 평활화합니다.
```

### 실제 아날로그 출력이 필요할 때

ESP32에는 **DAC(Digital to Analog Converter)** 도 있습니다:
- GPIO 25 (DAC1)
- GPIO 26 (DAC2)
- 8비트 해상도 (0~255 → 0~3.3V)

```cpp
dacWrite(25, 128);  // GPIO 25에 약 1.65V 출력 (진짜 아날로그!)
```

---

## 핵심 정리

| 개념 | 설명 |
|------|------|
| **PWM** | HIGH/LOW를 빠르게 전환하여 아날로그 효과를 내는 기술 |
| **듀티 사이클** | 한 주기에서 HIGH 비율 (0~100%) |
| **주파수** | 1초에 on/off 반복 횟수 (LED: 5kHz, 서보: 50Hz) |
| **해상도** | 듀티 사이클 단계 수 (8비트=256단계, 12비트=4096단계) |
| **LEDC** | ESP32의 PWM 생성 하드웨어 (16채널) |
| **ledcSetup()** | PWM 채널 설정 (주파수, 해상도) |
| **ledcAttachPin()** | GPIO 핀에 PWM 채널 연결 |
| **ledcWrite()** | 듀티 사이클 값 설정 |
| **DAC** | ESP32의 진짜 아날로그 출력 (GPIO 25, 26) |

---

## 실습 과제

1. LED를 부드럽게 페이드 인/아웃 (breathing effect)
2. 가변저항(ADC)으로 LED 밝기 실시간 조절
3. 서보모터를 0~180도 왕복 회전
4. RGB LED 3개의 색상을 PWM으로 혼합하여 다양한 색 만들기
5. (도전) 부저(Buzzer)로 음계 연주하기 (`ledcWriteTone()` 활용)

---

## 관련 코드 예제

- [pwm_led.ino](./code/pwm_led.ino) - LED 밝기 페이드 인/아웃 전체 코드
