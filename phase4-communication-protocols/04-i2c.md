# 04. I2C (Inter-Integrated Circuit) - 직렬 통신 버스

## 개요

I2C(아이-투-씨, 또는 아이-스퀘어드-씨)는 **2개의 선**(SDA, SCL)으로
**여러 장치와 통신**할 수 있는 직렬 통신 프로토콜입니다.
필립스(현 NXP)에서 개발했으며, 센서, 디스플레이, 메모리 등에 널리 사용됩니다.

> **소프트웨어 비유**: I2C는 **HTTP API**와 비슷합니다.
> - 마스터(ESP32) = 클라이언트 (요청을 보내는 쪽)
> - 슬레이브(센서) = 서버 (요청을 받아 응답하는 쪽)
> - I2C 주소 = URL/IP 주소 (각 장치의 고유 식별자)
> - 데이터 요청/전송 = HTTP GET/POST

---

## 1. I2C 동작 원리

### 마스터-슬레이브 구조

```
                     I2C 버스
        ┌──────────────┬──────────────┐
        │              │              │
  ┌─────┴─────┐  ┌─────┴─────┐  ┌─────┴─────┐
  │  ESP32    │  │   OLED    │  │   SHT30   │
  │ (마스터)  │  │ (슬레이브)│  │ (슬레이브)│
  │           │  │ 주소:0x3C │  │ 주소:0x44 │
  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘
        │              │              │
  SDA ──┴──────────────┴──────────────┴── (데이터)
  SCL ──┴──────────────┴──────────────┴── (클럭)
        │
      [4.7kΩ]──3.3V  (풀업 저항 × 2)
```

- **마스터 (Master)**: 통신을 시작하고 클럭을 생성하는 장치 (보통 ESP32)
- **슬레이브 (Slave)**: 마스터의 요청에 응답하는 장치 (센서, 디스플레이 등)
- **SDA (Serial Data)**: 데이터 전송 라인
- **SCL (Serial Clock)**: 클럭 신호 라인

### 통신 순서

```
     마스터(ESP32)                          슬레이브(센서 0x44)
          │                                       │
    1.    │──── START 조건 ──────────────────────▶│
          │     (통신 시작 신호)                    │
          │                                       │
    2.    │──── 주소 0x44 + 쓰기 비트 ──────────▶│
          │     "0x44 장치에게 쓸 거야"            │
          │                                       │
    3.    │◀──────────── ACK ─────────────────────│
          │     "네, 저 여기 있습니다"              │
          │                                       │
    4.    │──── 레지스터 주소 전송 ──────────────▶│
          │     "온도 데이터가 있는 주소 알려줘"    │
          │                                       │
    5.    │◀──────────── ACK ─────────────────────│
          │                                       │
    6.    │──── REPEATED START ─────────────────▶│
          │                                       │
    7.    │──── 주소 0x44 + 읽기 비트 ──────────▶│
          │     "0x44 장치에서 읽을 거야"          │
          │                                       │
    8.    │◀──────────── 데이터 전송 ─────────────│
          │     온도: 25.3°C                      │
          │                                       │
    9.    │──── STOP 조건 ──────────────────────▶│
          │     (통신 종료)                        │
```

### SDA/SCL 신호 타이밍

```
SCL  ────┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌────
         └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘

SDA  ──┐  ┌──────┐        ┌─────────┐     ┌──────────┐  ┌──
       └──┘      └────────┘         └─────┘          └──┘

     START  D7   D6   D5   D4   D3   D2   D1   D0  ACK  STOP
     조건  ◀──────── 8비트 데이터 ─────────▶        조건

START: SCL이 HIGH일 때 SDA가 HIGH→LOW
STOP:  SCL이 HIGH일 때 SDA가 LOW→HIGH
```

---

## 2. 7비트 주소 체계

I2C의 각 슬레이브 장치는 **7비트 고유 주소**를 가집니다.
이론적으로 하나의 버스에 **최대 127개 장치** (0x00~0x7F)를 연결할 수 있습니다.

### 자주 사용하는 I2C 장치 주소

| 장치 | 주소 (16진수) | 기능 |
|------|-------------|------|
| SSD1306 OLED | 0x3C 또는 0x3D | 128x64 OLED 디스플레이 |
| SHT30 | 0x44 또는 0x45 | 온습도 센서 |
| BMP280 | 0x76 또는 0x77 | 기압/온도 센서 |
| BME280 | 0x76 또는 0x77 | 온습도/기압 센서 |
| MPU6050 | 0x68 또는 0x69 | 가속도/자이로 센서 |
| PCF8574 | 0x20~0x27 | GPIO 확장기 |
| ADS1115 | 0x48~0x4B | 16비트 ADC |
| DS3231 | 0x68 | 실시간 시계 (RTC) |
| AT24C32 | 0x50~0x57 | EEPROM |

> **주소 충돌 해결**: 같은 종류의 장치 2개를 사용할 때, 장치의 주소 선택 핀(ADDR)을
> HIGH 또는 LOW로 연결하여 서로 다른 주소를 설정합니다.

---

## 3. 풀업 저항의 필요성

I2C 버스의 SDA와 SCL 라인은 **오픈 드레인(Open-Drain)** 방식으로 동작합니다.
이는 장치가 선을 LOW로만 끌어내릴 수 있고, HIGH 상태는 **풀업 저항**이 만들어줍니다.

```
        3.3V          3.3V
         │              │
       [4.7kΩ]        [4.7kΩ]    ← 풀업 저항
         │              │
SDA ─────┴──────  SCL ──┴──────
         │              │
    ┌────┴────┐    ┌────┴────┐
    │ 장치 A  │    │ 장치 A  │
    │(오픈    │    │(오픈    │
    │ 드레인) │    │ 드레인) │
    └────┬────┘    └────┬────┘
         │              │
    ┌────┴────┐    ┌────┴────┐
    │ 장치 B  │    │ 장치 B  │
    └─────────┘    └─────────┘

아무 장치도 당기지 않으면 → 풀업에 의해 HIGH
어떤 장치가 당기면       → LOW
```

### 풀업 저항 값 선택

| 저항값 | 용도 | 비고 |
|--------|------|------|
| **4.7kΩ** | **표준 (권장)** | 대부분의 상황에 적합 |
| 2.2kΩ | 고속 또는 긴 배선 | 전류 소비 증가 |
| 10kΩ | 저속, 짧은 배선 | 전류 소비 감소, 신호 품질 저하 가능 |

> **참고**: 많은 브레이크아웃 보드(OLED 모듈 등)에는 풀업 저항이 **이미 내장**되어 있습니다.
> 여러 모듈을 연결할 때 풀업 저항이 중복되면 저항값이 너무 낮아질 수 있으니 주의하세요.

---

## 4. ESP32 I2C 핀 설정

### 기본 I2C 핀

| 기능 | 기본 GPIO | 설명 |
|------|----------|------|
| SDA | **GPIO 21** | 데이터 라인 |
| SCL | **GPIO 22** | 클럭 라인 |

### 사용자 정의 I2C 핀

ESP32는 거의 모든 GPIO 핀을 I2C로 사용할 수 있습니다.

```cpp
#include <Wire.h>

// 기본 핀 사용 (GPIO 21=SDA, GPIO 22=SCL)
void setup() {
    Wire.begin();
}

// 사용자 정의 핀
void setup() {
    Wire.begin(16, 17);  // SDA=GPIO 16, SCL=GPIO 17
}

// 두 번째 I2C 버스 사용
TwoWire Wire1 = TwoWire(1);  // I2C 버스 1번
void setup() {
    Wire.begin(21, 22);     // 기본 I2C (SDA=21, SCL=22)
    Wire1.begin(16, 17);    // 두 번째 I2C (SDA=16, SCL=17)
}
```

---

## 5. 여러 장치 연결

### 같은 버스, 다른 주소

```
  3.3V    3.3V
   │       │
 [4.7kΩ] [4.7kΩ]
   │       │
   ├───────┤──────────────────────── SDA (GPIO 21)
   │       ├──────────────────────── SCL (GPIO 22)
   │       │       │       │
┌──┴───┐ ┌─┴───┐ ┌┴────┐ ┌┴────┐
│ESP32 │ │OLED │ │SHT30│ │BMP │
│마스터│ │0x3C │ │0x44 │ │0x76│
└──────┘ └─────┘ └─────┘ └─────┘

모든 장치가 같은 SDA/SCL 선에 병렬로 연결!
각 장치는 고유한 주소로 구분됨
```

### 주소가 같은 장치 2개 연결

```
방법 1: 주소 변경 (ADDR 핀 이용)
  SHT30 #1: ADDR → GND  → 주소 0x44
  SHT30 #2: ADDR → 3.3V → 주소 0x45

방법 2: I2C 멀티플렉서 (TCA9548A)
  ┌─────────────────────┐
  │   TCA9548A          │
  │   I2C 멀티플렉서    │
  │                     │
  │  채널 0 ─── SHT30 #1 (0x44)
  │  채널 1 ─── SHT30 #2 (0x44)  ← 같은 주소OK!
  │  채널 2 ─── SHT30 #3 (0x44)
  │  ...                │
  │  채널 7 ─── ...     │
  └─────────────────────┘
```

---

## 6. I2C 스캐너로 장치 찾기

I2C 장치의 주소를 모를 때, **스캐너 프로그램**으로 버스에 연결된 모든 장치를 찾을 수 있습니다.

```cpp
#include <Wire.h>

void setup() {
    Wire.begin();
    Serial.begin(115200);
    Serial.println("I2C 스캐너 시작...");
}

void loop() {
    int deviceCount = 0;

    for (byte address = 1; address < 127; address++) {
        Wire.beginTransmission(address);
        byte error = Wire.endTransmission();

        if (error == 0) {
            Serial.print("장치 발견! 주소: 0x");
            if (address < 16) Serial.print("0");
            Serial.println(address, HEX);
            deviceCount++;
        }
    }

    if (deviceCount == 0) {
        Serial.println("I2C 장치를 찾지 못했습니다.");
    }

    Serial.println("---");
    delay(5000);  // 5초마다 스캔
}
```

### 출력 예시

```
I2C 스캐너 시작...
장치 발견! 주소: 0x3C     ← SSD1306 OLED
장치 발견! 주소: 0x44     ← SHT30 온습도 센서
장치 발견! 주소: 0x76     ← BMP280 기압 센서
---
```

---

## 7. 대표 I2C 장치 연결 예시

### 7.1 SSD1306 OLED 디스플레이 (0x3C)

```
ESP32             SSD1306 OLED
─────             ───────────
3.3V ──────────── VCC
GND  ──────────── GND
GPIO 21 (SDA) ─── SDA
GPIO 22 (SCL) ─── SCL
```

```cpp
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// 128x64 해상도, I2C 연결
Adafruit_SSD1306 display(128, 64, &Wire, -1);

void setup() {
    // 0x3C 주소로 초기화
    if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
        Serial.println("OLED 초기화 실패!");
        while(1);
    }

    display.clearDisplay();
    display.setTextSize(2);
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(0, 0);
    display.println("Hello!");
    display.println("안녕하세요!");
    display.display();
}
```

### 7.2 SHT30 온습도 센서 (0x44)

```
ESP32             SHT30
─────             ─────
3.3V ──────────── VCC
GND  ──────────── GND
GPIO 21 (SDA) ─── SDA
GPIO 22 (SCL) ─── SCL
ADDR → GND (0x44) 또는 VCC (0x45)
```

```cpp
#include <Wire.h>

void readSHT30() {
    Wire.beginTransmission(0x44);
    Wire.write(0x2C);  // 고정밀 측정 명령
    Wire.write(0x06);
    Wire.endTransmission();

    delay(50);  // 측정 대기

    Wire.requestFrom(0x44, 6);  // 6바이트 요청
    if (Wire.available() == 6) {
        uint16_t rawTemp = (Wire.read() << 8) | Wire.read();
        Wire.read();  // CRC 스킵
        uint16_t rawHum = (Wire.read() << 8) | Wire.read();
        Wire.read();  // CRC 스킵

        float temperature = -45.0 + 175.0 * rawTemp / 65535.0;
        float humidity = 100.0 * rawHum / 65535.0;

        Serial.print("온도: ");
        Serial.print(temperature, 1);
        Serial.print("°C, 습도: ");
        Serial.print(humidity, 1);
        Serial.println("%");
    }
}
```

### 7.3 BMP280 기압/온도 센서 (0x76)

```
ESP32             BMP280
─────             ──────
3.3V ──────────── VCC
GND  ──────────── GND
GPIO 21 (SDA) ─── SDA (SDI)
GPIO 22 (SCL) ─── SCL (SCK)
                  CSB → 3.3V (I2C 모드)
                  SDO → GND (주소 0x76) 또는 VCC (0x77)
```

```cpp
#include <Wire.h>
#include <Adafruit_BMP280.h>

Adafruit_BMP280 bmp;

void setup() {
    Serial.begin(115200);

    if (!bmp.begin(0x76)) {
        Serial.println("BMP280 초기화 실패!");
        while(1);
    }
}

void loop() {
    Serial.print("온도: ");
    Serial.print(bmp.readTemperature());
    Serial.println(" °C");

    Serial.print("기압: ");
    Serial.print(bmp.readPressure() / 100.0);  // Pa → hPa
    Serial.println(" hPa");

    Serial.print("고도: ");
    Serial.print(bmp.readAltitude(1013.25));  // 표준 기압 기준
    Serial.println(" m");

    delay(2000);
}
```

---

## 8. I2C 통신 속도

| 모드 | 속도 | 용도 |
|------|------|------|
| 표준 모드 | 100 kHz | 대부분의 센서 |
| 고속 모드 | 400 kHz | 빠른 데이터 전송 (OLED 등) |
| 고속+ 모드 | 1 MHz | ESP32 지원 (일부 장치만) |

```cpp
// 속도 설정
Wire.begin();
Wire.setClock(400000);  // 400kHz 고속 모드
```

---

## 핵심 정리

| 개념 | 설명 |
|------|------|
| **I2C** | 2선(SDA, SCL)으로 여러 장치와 통신하는 직렬 프로토콜 |
| **마스터** | 통신을 시작하고 클럭을 제공하는 장치 (ESP32) |
| **슬레이브** | 마스터의 요청에 응답하는 장치 (센서, 디스플레이) |
| **주소** | 각 슬레이브의 7비트 고유 식별자 (0x00~0x7F) |
| **SDA/SCL** | 데이터 라인 / 클럭 라인 |
| **풀업 저항** | 4.7kΩ 필수 (많은 모듈에 내장) |
| **기본 핀** | ESP32: GPIO 21 (SDA), GPIO 22 (SCL) |
| **Wire 라이브러리** | Arduino I2C 통신 표준 라이브러리 |
| **I2C 스캐너** | 버스에 연결된 장치 주소를 자동 검색 |

---

## 실습 과제

1. I2C 스캐너로 연결된 장치 주소 확인하기
2. SSD1306 OLED에 "Hello World" 출력하기
3. BMP280으로 온도/기압 측정 후 OLED에 표시하기
4. 2개 이상의 I2C 장치를 동시에 사용하기
5. (도전) 사용자 정의 핀으로 두 번째 I2C 버스 설정하기

---

## 관련 코드 예제

- [i2c_scanner.ino](./code/i2c_scanner.ino) - I2C 버스 스캐너 전체 코드
