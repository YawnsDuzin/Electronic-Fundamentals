/*
 * ============================================================
 *  PWM LED 밝기 제어 (Fade In/Out) 예제
 * ============================================================
 *
 *  기능 설명:
 *  - ESP32 LEDC(LED Control) API를 사용하여 PWM 신호를 생성합니다
 *  - LED의 밝기를 서서히 밝아졌다가 어두워지는 효과를 만듭니다
 *  - "숨쉬기(Breathing)" 효과로 부드러운 페이드를 구현합니다
 *  - 시리얼 모니터에 현재 듀티 사이클과 밝기 %를 출력합니다
 *
 *  배선 안내 (Wiring Guide):
 *  ┌──────────────────────────────────────────────────┐
 *  │                                                  │
 *  │  ESP32                 LED                       │
 *  │  ─────                 ───                       │
 *  │  GPIO 2 ──┤220Ω├──────►|──── GND                │
 *  │                     (애노드) (캐소드)             │
 *  │                                                  │
 *  │  ※ LED의 긴 다리(+) = 애노드 → 저항 쪽           │
 *  │    LED의 짧은 다리(-) = 캐소드 → GND 쪽           │
 *  │                                                  │
 *  │  ※ 220Ω 저항은 LED 보호용 (전류 제한)            │
 *  │    저항 없이 연결하면 LED가 손상될 수 있음!        │
 *  │                                                  │
 *  └──────────────────────────────────────────────────┘
 *
 *  필요 부품:
 *  - ESP32 개발보드
 *  - LED 1개 (아무 색상)
 *  - 220Ω 저항 1개
 *  - 브레드보드 및 점퍼 와이어
 *
 *  시리얼 모니터 설정: 115200 baud
 * ============================================================
 */

// ─────────────── 핀 정의 ───────────────
const int LED_PIN = 2;            // LED가 연결된 GPIO 핀

// ─────────────── PWM 설정 ───────────────
const int PWM_CHANNEL = 0;        // LEDC 채널 번호 (0~15, 총 16채널)
const int PWM_FREQUENCY = 5000;   // PWM 주파수: 5000Hz (5kHz)
                                  // LED에는 5kHz가 적합 (깜빡임 안 보임)
const int PWM_RESOLUTION = 12;    // PWM 해상도: 12비트 (0~4095)
                                  // 12비트 = 4096단계의 밝기 조절 가능

// ─────────────── 페이드 설정 ───────────────
const int FADE_STEP = 5;          // 한 번에 변하는 듀티 사이클 양
const int FADE_DELAY = 5;         // 각 단계 사이의 지연 시간 (밀리초)
                                  // 작을수록 빠르게 변화

// 듀티 사이클 최대값 (해상도에 따라 결정)
// 12비트: 2^12 - 1 = 4095
const int MAX_DUTY = (1 << PWM_RESOLUTION) - 1;

// ─────────────── 초기 설정 ───────────────
void setup() {
    // 시리얼 통신 초기화
    Serial.begin(115200);

    // ──── LEDC PWM 채널 설정 ────
    // ledcSetup(채널, 주파수, 해상도)
    // 채널 0번에 5kHz 주파수, 12비트 해상도로 설정
    ledcSetup(PWM_CHANNEL, PWM_FREQUENCY, PWM_RESOLUTION);

    // ──── GPIO 핀에 LEDC 채널 연결 ────
    // ledcAttachPin(핀 번호, 채널 번호)
    // GPIO 2번 핀에 채널 0번의 PWM 출력을 연결
    ledcAttachPin(LED_PIN, PWM_CHANNEL);

    // 시작 메시지 출력
    Serial.println("=================================");
    Serial.println("  ESP32 PWM LED 페이드 예제");
    Serial.println("=================================");
    Serial.printf("핀: GPIO %d\n", LED_PIN);
    Serial.printf("채널: %d\n", PWM_CHANNEL);
    Serial.printf("주파수: %d Hz\n", PWM_FREQUENCY);
    Serial.printf("해상도: %d비트 (0~%d)\n", PWM_RESOLUTION, MAX_DUTY);
    Serial.println("=================================");
    Serial.println();
}

// ─────────────── 메인 루프 ───────────────
void loop() {
    // ──── 페이드 인 (Fade In): 서서히 밝아지기 ────
    Serial.println(">>> 페이드 인 (밝아지는 중...)");
    for (int duty = 0; duty <= MAX_DUTY; duty += FADE_STEP) {
        // ledcWrite(채널, 듀티사이클)
        // 듀티 사이클: 0(꺼짐) ~ 4095(최대 밝기)
        ledcWrite(PWM_CHANNEL, duty);
        delay(FADE_DELAY);
    }
    // 최대 밝기 확실히 설정 (FADE_STEP으로 인한 오차 보정)
    ledcWrite(PWM_CHANNEL, MAX_DUTY);

    Serial.printf("  최대 밝기 도달! (듀티: %d/%d = 100%%)\n", MAX_DUTY, MAX_DUTY);
    delay(500);  // 최대 밝기에서 0.5초 유지

    // ──── 페이드 아웃 (Fade Out): 서서히 어두워지기 ────
    Serial.println("<<< 페이드 아웃 (어두워지는 중...)");
    for (int duty = MAX_DUTY; duty >= 0; duty -= FADE_STEP) {
        ledcWrite(PWM_CHANNEL, duty);
        delay(FADE_DELAY);
    }
    // 완전히 끄기 (오차 보정)
    ledcWrite(PWM_CHANNEL, 0);

    Serial.printf("  최소 밝기 도달! (듀티: 0/%d = 0%%)\n", MAX_DUTY);
    delay(500);  // 꺼진 상태에서 0.5초 유지

    Serial.println();
}

/*
 * ============================================================
 *  PWM 원리 설명
 * ============================================================
 *
 *  PWM(Pulse Width Modulation)은 디지털 신호로
 *  아날로그 효과를 흉내내는 기술입니다.
 *
 *  듀티 사이클 (Duty Cycle):
 *  - 한 주기에서 HIGH 상태의 비율
 *  - 0% = 항상 꺼짐, 100% = 항상 켜짐
 *
 *  듀티 0%    (꺼짐):  ________________________
 *  듀티 25%   (어둡게): _|__|__|__|__|__|__|__|_
 *  듀티 50%   (중간):   ___|___|___|___|___|___
 *  듀티 75%   (밝게):   ______|______|______|__
 *  듀티 100%  (최대):   ________________________
 *
 *  5kHz로 깜빡이면 사람의 눈에는 깜빡임이 보이지 않고
 *  밝기만 변하는 것처럼 느껴집니다.
 *
 * ============================================================
 *  ESP32 LEDC 채널 구조
 * ============================================================
 *
 *  ESP32는 16개의 독립적인 PWM 채널을 가지고 있습니다:
 *  - 고속 채널: 0~7  (80MHz 클럭)
 *  - 저속 채널: 8~15 (8MHz 클럭)
 *
 *  각 채널은 아무 GPIO 핀에나 연결할 수 있습니다.
 *  같은 채널을 여러 핀에 연결하면 같은 PWM 출력이 나옵니다.
 *
 * ============================================================
 *  응용 예제: 감마 보정 (인간 눈의 비선형 감도)
 * ============================================================
 *
 *  인간의 눈은 밝기 변화를 선형적으로 인지하지 않습니다.
 *  어두운 영역에서의 변화가 밝은 영역보다 더 민감합니다.
 *
 *  감마 보정 공식:
 *  보정된 값 = pow(원래 값 / 최대값, 감마) × 최대값
 *
 *  보통 감마 = 2.2를 사용합니다:
 *
 *  int gammaCorrect(int value) {
 *      float normalized = (float)value / MAX_DUTY;
 *      float corrected = pow(normalized, 2.2);
 *      return (int)(corrected * MAX_DUTY);
 *  }
 *
 *  이것을 적용하면 밝기 변화가 훨씬 자연스러워집니다!
 *
 * ============================================================
 *  응용 예제: 사인파 숨쉬기 효과
 * ============================================================
 *
 *  void loop() {
 *      // 사인파로 부드러운 숨쉬기 효과
 *      for (float angle = 0; angle < 2 * PI; angle += 0.01) {
 *          // sin() 값: -1~1 → 0~1로 변환 → 0~MAX_DUTY로 변환
 *          int duty = (int)((sin(angle) + 1.0) / 2.0 * MAX_DUTY);
 *          ledcWrite(PWM_CHANNEL, duty);
 *          delay(5);
 *      }
 *  }
 *
 * ============================================================
 */
