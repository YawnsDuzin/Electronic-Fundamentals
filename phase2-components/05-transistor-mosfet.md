# 05. 트랜지스터 / MOSFET

## 목차
1. [트랜지스터란?](#1-트랜지스터란)
2. [BJT vs MOSFET 차이](#2-bjt-vs-mosfet-차이)
3. [MOSFET이 ESP32에서 더 많이 쓰이는 이유](#3-mosfet이-esp32에서-더-많이-쓰이는-이유)
4. [N-채널 MOSFET 사용법](#4-n-채널-mosfet-사용법)
5. [Gate, Drain, Source 핀 설명](#5-gate-drain-source-핀-설명)
6. [로직 레벨 MOSFET](#6-로직-레벨-mosfet)
7. [회로 연결도](#7-회로-연결도)
8. [히트싱크 필요 여부 판단](#8-히트싱크-필요-여부-판단)
9. [실습: ESP32로 12V 장치 제어](#9-실습-esp32로-12v-장치-제어)
10. [핵심 정리](#핵심-정리)

---

## 1. 트랜지스터란?

트랜지스터는 **작은 신호(전류 또는 전압)로 큰 전류를 제어하는** 반도체 소자입니다.
전자 회로의 "스위치" 또는 "증폭기" 역할을 합니다.

```
소프트웨어 비유:
트랜지스터는 "API 게이트웨이" 또는 "프록시 서버"와 같습니다.
- 작은 요청(제어 신호)으로 큰 서비스(전력)를 제어합니다.
- ESP32의 작은 GPIO 신호(3.3V, 수 mA)로
  12V 모터나 LED 스트립(수 A)을 제어할 수 있습니다.

function transistorSwitch(gateSignal) {
    if (gateSignal > threshold) {
        return ALLOW_HIGH_POWER;   // 대전류 흐름
    } else {
        return BLOCK;              // 전류 차단
    }
}
```

### 왜 트랜지스터가 필요한가?

```
ESP32 GPIO의 한계:
┌─────────────────────────────────────────┐
│ 출력 전압:  3.3V (고정)                  │
│ 최대 전류:  ~40mA (핀당)                 │
│ 권장 전류:  ~20mA                        │
│                                         │
│ → 12V LED 스트립(2A)을 직접 구동? 불가!  │
│ → 12V 모터(500mA)를 직접 구동? 불가!     │
│ → 5V 릴레이(70mA)를 직접 구동? 위험!     │
└─────────────────────────────────────────┘

해결: 트랜지스터/MOSFET을 "중간 스위치"로 사용!

    ESP32 GPIO ──[신호]──▶ 트랜지스터 ──[전력]──▶ 부하(모터, LED 등)
    (3.3V, 수 mA)          (스위치)        (12V, 수 A)
```

---

## 2. BJT vs MOSFET 차이

### BJT (Bipolar Junction Transistor)

```
NPN 트랜지스터 (2N2222 등):

    Collector (C) ← 전류가 들어오는 곳
        │
       ╱│
  Base ──┤    ← 제어 핀 (전류로 제어)
       ╲│
        │
    Emitter (E) ← 전류가 나가는 곳

    특징: Base에 "전류"를 흘려야 ON
    (전류 구동 방식)
```

### MOSFET (Metal-Oxide-Semiconductor FET)

```
N-채널 MOSFET (IRLZ44N 등):

    Drain (D) ← 전류가 들어오는 곳
        │
       ╱│
  Gate ──┤    ← 제어 핀 (전압으로 제어)
       ╲│
        │
    Source (S) ← 전류가 나가는 곳

    특징: Gate에 "전압"만 걸면 ON
    (전압 구동 방식)
```

### 비교표

| 특성 | BJT (NPN) | MOSFET (N-채널) |
|------|:---------:|:---------------:|
| 제어 방식 | **전류** 구동 | **전압** 구동 |
| 입력 임피던스 | 낮음 (전류 소비) | **매우 높음** (전류 거의 안 씀) |
| 스위칭 속도 | 보통 | **빠름** |
| ON 저항 | 포화 전압 ~0.2V | **매우 낮음** (수 mΩ) |
| 구동 핀 | Base | Gate |
| 구동 조건 | Base 전류 필요 | Gate 전압만 필요 |
| 발열 | 전류가 크면 발열 | ON 저항이 낮아 **발열 적음** |
| ESP32 적합성 | 보통 | **매우 좋음** |
| 가격 | 저렴 | 약간 비쌈 |
| 대표 부품 | 2N2222, BC547 | IRLZ44N, IRF540 |

---

## 3. MOSFET이 ESP32에서 더 많이 쓰이는 이유

### 이유 1: 전압으로 제어 (GPIO 전류 소모 없음)

```
BJT:
    ESP32 GPIO ──[1kΩ]── Base
                          │
    Base 전류 = (3.3V - 0.7V) / 1kΩ = 2.6mA
    → GPIO가 2.6mA를 소비함!
    → 여러 개 사용하면 합산 전류 증가

MOSFET:
    ESP32 GPIO ──[1kΩ]── Gate
                          │
    Gate 전류 ≈ 0mA (정상 상태)
    → GPIO 부담 거의 없음!
    → 많은 MOSFET을 동시에 제어 가능
```

### 이유 2: 낮은 ON 저항 = 낮은 발열

```
BJT (2N2222, 1A 흐를 때):
    포화 전압: Vce(sat) ≈ 0.3V
    소비 전력: P = 0.3V × 1A = 0.3W → 발열!

MOSFET (IRLZ44N, 1A 흐를 때):
    ON 저항: Rds(on) ≈ 0.022Ω
    소비 전력: P = I² × R = 1² × 0.022 = 0.022W → 거의 발열 없음!
```

### 이유 3: ESP32는 3.3V 출력

```
일반 MOSFET: Vgs(th) = 2~4V → 3.3V로 "어중간"하게 켜질 수 있음
로직 레벨 MOSFET: Vgs(th) = 1~2V → 3.3V로 "확실하게" 켜짐!

→ 로직 레벨 MOSFET을 사용하면 ESP32 3.3V로 직접 제어 가능!
```

---

## 4. N-채널 MOSFET 사용법

### N-채널 MOSFET의 동작 원리

```
    VCC (12V)                    VCC (12V)
     │                            │
    [부하]                       [부하]
     │                            │
     D (Drain)                    D (Drain)
   ┌─┴──┐                      ┌─┴──┐
   │ OFF │ Gate = 0V            │ ON  │ Gate = 3.3V
   └─┬──┘                      └─┬──┘
     S (Source)                   S (Source)
     │                            │
    GND                          GND

    Gate = LOW (0V): MOSFET OFF → 전류 차단
    Gate = HIGH (3.3V): MOSFET ON → 전류 흐름
```

### 핵심 규칙

```
N-채널 MOSFET 사용 시:
┌─────────────────────────────────────────────────┐
│                                                 │
│  1. 부하는 MOSFET 위쪽 (Drain과 VCC 사이)        │
│  2. Source는 GND에 연결                          │
│  3. Gate 전압 > Vgs(th) → ON                    │
│  4. Gate 전압 < Vgs(th) → OFF                   │
│                                                 │
│  ※ "Low-side switching"이라고 부릅니다            │
│  ※ 부하의 GND 쪽을 제어하는 방식                   │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 5. Gate, Drain, Source 핀 설명

### 각 핀의 역할

```
    ┌───────────────────────────────────────────┐
    │                                           │
    │  Gate (G) - 게이트                         │
    │  ├── "제어 핀" (스위치의 버튼)               │
    │  ├── 전압을 걸면 MOSFET ON/OFF             │
    │  ├── 전류는 거의 흐르지 않음                 │
    │  └── ESP32 GPIO에 연결                     │
    │                                           │
    │  Drain (D) - 드레인                        │
    │  ├── "전류가 들어오는 핀" (수도꼭지의 입구)   │
    │  ├── 부하(모터, LED 등)에 연결               │
    │  └── 높은 전압/전류가 흐르는 곳              │
    │                                           │
    │  Source (S) - 소스                          │
    │  ├── "전류가 나가는 핀" (수도꼭지의 출구)     │
    │  ├── N-채널: GND에 연결                     │
    │  └── 기준 전위 (Gate 전압의 기준점)           │
    │                                           │
    └───────────────────────────────────────────┘
```

### 수도꼭지 비유

```
    수도관 (VCC) ──→ [밸브(Gate로 제어)] ──→ 물 나옴(부하)
                           │
                      수도꼭지 손잡이
                       = Gate 전압

    Gate 열기 = 밸브 열림 = 전류 흐름 (ON)
    Gate 닫기 = 밸브 닫힘 = 전류 차단 (OFF)
```

### MOSFET 패키지와 핀 배치

```
TO-220 패키지 (IRLZ44N 등):

    정면에서 바라본 모습:

    ┌──────────────────┐
    │                  │
    │    IRLZ44N       │ ← 방열판(히트싱크 장착 가능)
    │                  │    = Drain에 연결되어 있음!
    │                  │
    └──┬────┬────┬─────┘
       │    │    │
       G    D    S

    왼쪽부터: Gate, Drain, Source
    (데이터시트로 반드시 확인!)

    ※ 방열판(금속 탭)은 Drain과 내부 연결!
    ※ 히트싱크 장착 시 절연에 주의!
```

---

## 6. 로직 레벨 MOSFET

### 로직 레벨이란?

일반 MOSFET은 Gate에 10V 이상을 걸어야 완전히 ON됩니다.
하지만 ESP32는 3.3V만 출력합니다!

**로직 레벨 MOSFET**은 3.3V~5V의 낮은 Gate 전압으로도
완전히 ON되는 MOSFET입니다.

### 일반 MOSFET vs 로직 레벨 MOSFET

```
Gate 전압에 따른 ON 저항:

    일반 MOSFET (IRF540N):              로직 레벨 MOSFET (IRLZ44N):

    Vgs  │ Rds(on)  │ 상태              Vgs  │ Rds(on)  │ 상태
    ─────┼──────────┼──────             ─────┼──────────┼──────
    0V   │ 무한대   │ OFF               0V   │ 무한대   │ OFF
    3.3V │ 매우 높음│ 반 ON (위험!)     3.3V │ ~0.05Ω  │ 완전 ON!
    5V   │ 높음     │ 거의 ON          5V   │ ~0.022Ω │ 완전 ON!
    10V  │ 0.044Ω  │ 완전 ON           10V  │ ~0.022Ω │ 완전 ON!

    ※ 일반 MOSFET은 3.3V로 제어하면 "반쯤 켜진" 상태
    → ON 저항 높음 → 발열 심함 → 효율 나쁨 → 파손 위험!
```

### ESP32에서 추천하는 로직 레벨 MOSFET

| MOSFET | Vgs(th) | Rds(on) @Vgs=2.5V | Id (max) | Vds (max) | 패키지 |
|--------|:-------:|:-----------------:|:--------:|:---------:|:------:|
| **IRLZ44N** | 1~2V | ~0.05Ω | 47A | 55V | TO-220 |
| IRL540N | 1~2V | ~0.077Ω | 36A | 100V | TO-220 |
| IRLZ34N | 1~2V | ~0.05Ω | 30A | 55V | TO-220 |
| AOD4184A | 1~2V | ~0.004Ω | 50A | 40V | TO-252 |
| Si2302 | 0.65~1V | ~0.06Ω | 2.6A | 20V | SOT-23 |

> **가장 추천:** `IRLZ44N` - 구하기 쉽고, 3.3V Gate에서 잘 동작하며, 대전류 가능!

### Vgs(th)와 완전 ON의 차이

```
    Vgs(th) = "문턱 전압" = MOSFET이 켜지기 시작하는 전압
    완전 ON = Rds(on)이 최소가 되는 전압

    ┌──────────────────────────────────────────┐
    │                                          │
    │  IRLZ44N 예시:                            │
    │                                          │
    │  Vgs = 0V      → OFF (전류 안 흐름)       │
    │  Vgs = 1V      → Vgs(th) 근처, 살짝 ON    │
    │  Vgs = 2.5V    → 거의 완전 ON             │
    │  Vgs = 3.3V    → 완전 ON! (ESP32 출력)     │
    │  Vgs = 5V      → 확실히 완전 ON            │
    │                                          │
    │  ※ 데이터시트의 Rds(on)은 보통             │
    │    Vgs = 10V 기준이므로 주의!              │
    │    3.3V에서의 Rds(on)을 확인해야 함         │
    │                                          │
    └──────────────────────────────────────────┘
```

---

## 7. 회로 연결도

### 기본 회로: ESP32로 12V LED 스트립 제어

```
    12V 전원 (+)
        │
        │
    ┌───┴───────────────┐
    │   12V LED 스트립    │ ← 부하 (12V, 2A)
    │   (또는 모터 등)     │
    └───┬───────────────┘
        │
        │ ← Drain (D)
      ┌─┴──┐
      │    │
  G ──┤ N  │ ← IRLZ44N (N-채널 MOSFET)
      │ CH │
      └─┬──┘
        │ ← Source (S)
        │
       GND (ESP32와 공통 GND)


    ESP32 GPIO ──[1kΩ]── Gate
                   │
                [10kΩ]── GND   ← Gate 풀다운 저항
```

### 상세 연결도 (브레드보드용)

```
    12V 전원(+)                              12V 전원(-)
        │                                        │
        └───── LED 스트립 (+) ─── LED 스트립 (-) ──┤
                                      │           │
                                      │           │
                              IRLZ44N │           │
                              ┌───────┤           │
                              │  D    │           │
                              │       │           │
    ESP32 GPIO 25 ──[1kΩ]──── G       │           │
                       │      │       │           │
                    [10kΩ]    │  S    │           │
                       │      └───┬───┘           │
                       │          │               │
    ESP32 GND ─────────┴──────────┴───────────────┘
                           (공통 GND - 매우 중요!)
```

### 왜 Gate에 저항을 달까?

```
Gate 직렬 저항 (1kΩ):
┌─────────────────────────────────────────────┐
│ 역할:                                       │
│ - Gate 충전 전류를 제한                       │
│ - ESP32 GPIO를 보호                          │
│ - 고주파 발진(ringing) 방지                   │
│                                             │
│ 없어도 동작하지만, 있으면 더 안전!              │
└─────────────────────────────────────────────┘

Gate 풀다운 저항 (10kΩ):
┌─────────────────────────────────────────────┐
│ 역할:                                       │
│ - ESP32 부팅 중 GPIO가 불안정할 때             │
│   Gate를 확실히 LOW(OFF)로 유지                │
│ - ESP32가 리셋되어도 MOSFET이 켜지지 않음       │
│                                             │
│ 매우 중요! 없으면 부팅 시 부하가 잠깐 켜질 수 있음!│
└─────────────────────────────────────────────┘
```

### PWM으로 밝기/속도 제어

```cpp
// ESP32로 12V LED 스트립 밝기 제어 (PWM)
const int MOSFET_PIN = 25;
const int FREQ = 25000;      // 25kHz (LED 깜빡임 안 보이게)
const int RESOLUTION = 8;     // 8비트 (0~255)

void setup() {
    ledcAttach(MOSFET_PIN, FREQ, RESOLUTION);
}

void loop() {
    // 점점 밝아짐
    for (int duty = 0; duty <= 255; duty++) {
        ledcWrite(MOSFET_PIN, duty);
        delay(10);
    }

    // 점점 어두워짐
    for (int duty = 255; duty >= 0; duty--) {
        ledcWrite(MOSFET_PIN, duty);
        delay(10);
    }
}
```

---

## 8. 히트싱크 필요 여부 판단

### MOSFET의 발열 원인

```
MOSFET에서 열이 발생하는 두 가지 경우:

1. 전도 손실 (Conduction Loss):
   P_cond = I² × Rds(on)
   → ON 상태에서 전류가 흐를 때

2. 스위칭 손실 (Switching Loss):
   P_sw = 0.5 × V × I × (t_rise + t_fall) × f_sw
   → ON/OFF 전환 시 (PWM 사용 시)

총 손실 = 전도 손실 + 스위칭 손실
```

### 계산 예제

```
예제 1: IRLZ44N으로 12V LED 스트립 2A 제어 (DC, PWM 아님)

    Rds(on) @ Vgs=3.3V ≈ 0.05Ω
    I = 2A

    P = I² × Rds(on) = 4 × 0.05 = 0.2W

    → TO-220 패키지는 히트싱크 없이 약 1W까지 가능
    → 0.2W → 히트싱크 불필요! ✓

예제 2: IRLZ44N으로 12V 모터 10A 제어

    P = I² × Rds(on) = 100 × 0.05 = 5W

    → 5W → 히트싱크 반드시 필요! ✗
    → 적절한 히트싱크 + 방열 그리스 사용
```

### 히트싱크 판단 기준

```
┌────────────────────────────────────────────┐
│          히트싱크 필요 여부 판단             │
├────────────────────────────────────────────┤
│                                            │
│  소비 전력 < 0.5W  → 히트싱크 불필요        │
│  소비 전력 0.5~1W  → 없어도 되지만 권장      │
│  소비 전력 1~3W    → 작은 히트싱크 필요       │
│  소비 전력 3W+     → 큰 히트싱크 + 팬 고려   │
│                                            │
│  ※ TO-220 패키지 기준                       │
│  ※ 주변 온도, 통풍에 따라 달라질 수 있음      │
│                                            │
└────────────────────────────────────────────┘
```

### 히트싱크 장착 시 주의

```
    ┌───────────────────┐
    │  MOSFET (TO-220)  │
    │                   │◄── 방열판(금속 탭) = Drain에 연결!
    │                   │
    └──┬────┬────┬──────┘
       G    D    S

    히트싱크 장착 시:
    ┌───────────────────────────────────┐
    │  방열판이 Drain과 연결되어 있으므로  │
    │  히트싱크가 다른 금속과 접촉하면     │
    │  쇼트(합선)가 발생할 수 있음!        │
    │                                   │
    │  해결: 절연 와셔 + 절연 실리콘 패드  │
    │  사용하여 전기적으로 절연             │
    └───────────────────────────────────┘
```

---

## 9. 실습: ESP32로 12V 장치 제어

### 실습 1: 12V LED 스트립 ON/OFF

#### 부품 목록
- ESP32 개발보드
- IRLZ44N N-채널 MOSFET
- 1kΩ 저항 (Gate 직렬)
- 10kΩ 저항 (Gate 풀다운)
- 12V LED 스트립
- 12V DC 전원 어댑터
- 브레드보드, 점퍼 와이어

#### 회로

```
    12V 어댑터 (+)
        │
    [12V LED 스트립]
        │
        D
      ┌─┴──┐
  G ──┤IRLZ│
      │44N │
      └─┬──┘
        S
        │
    ────┴──── GND (공통)

    ESP32:
    GPIO 25 ──[1kΩ]── G
                │
             [10kΩ]
                │
               GND
```

#### 코드

```cpp
const int MOSFET_PIN = 25;

void setup() {
    pinMode(MOSFET_PIN, OUTPUT);
    digitalWrite(MOSFET_PIN, LOW);  // 초기: OFF
    Serial.begin(115200);
}

void loop() {
    Serial.println("LED 스트립 ON");
    digitalWrite(MOSFET_PIN, HIGH);
    delay(3000);

    Serial.println("LED 스트립 OFF");
    digitalWrite(MOSFET_PIN, LOW);
    delay(2000);
}
```

### 실습 2: 12V DC 모터 속도 제어 (PWM)

#### 회로 (플라이백 다이오드 필수!)

```
    12V (+)
     │
     ├────────────────┐
     │                │
   ┌─┴──────┐       ▶|  ← 1N5819 (플라이백 다이오드!)
   │ DC 모터 │        │
   └─┬──────┘        │
     │                │
     ├────────────────┘
     │
     D
   ┌─┴──┐
   │IRLZ│
   │44N │
   └─┬──┘
     S
     │
    GND (공통)

    ESP32 GPIO 25 ──[1kΩ]── G
                      │
                   [10kΩ]
                      │
                     GND

    ※ 모터에는 반드시 플라이백 다이오드 연결!
    ※ 안 달면 MOSFET이 역기전력으로 파손됩니다!
```

#### 코드

```cpp
const int MOSFET_PIN = 25;
const int POT_PIN = 34;       // 가변저항으로 속도 조절
const int FREQ = 25000;       // 25kHz
const int RESOLUTION = 8;

void setup() {
    ledcAttach(MOSFET_PIN, FREQ, RESOLUTION);
    Serial.begin(115200);
}

void loop() {
    // 가변저항 읽기 (0~4095)
    int potValue = analogRead(POT_PIN);

    // 0~4095를 0~255로 변환
    int dutyCycle = map(potValue, 0, 4095, 0, 255);

    // MOSFET PWM 출력
    ledcWrite(MOSFET_PIN, dutyCycle);

    Serial.print("속도: ");
    Serial.print(map(dutyCycle, 0, 255, 0, 100));
    Serial.println("%");

    delay(50);
}
```

### 실습 3: 여러 장치 독립 제어

```
    12V (+)
     │
     ├─[LED스트립]─┬─[모터]──┬─[팬]───┐
     │             │         │        │
     D1            D2        D3       │
   ┌─┴──┐      ┌─┴──┐    ┌─┴──┐     │
   │ Q1 │      │ Q2 │    │ Q3 │     │
   └─┬──┘      └─┬──┘    └─┬──┘     │
     S1            S2        S3       │
     │             │         │        │
    GND ───────────┴─────────┴────────┘

    ESP32:
    GPIO 25 → Q1 Gate (LED)
    GPIO 26 → Q2 Gate (모터)
    GPIO 27 → Q3 Gate (팬)

    ※ 각 MOSFET마다 Gate 풀다운 저항(10kΩ) 필요!
    ※ 모터/팬에는 플라이백 다이오드 필요!
```

---

## 핵심 정리

```
┌─────────────────────────────────────────────────────────┐
│              트랜지스터/MOSFET 핵심 정리                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. 트랜지스터 = 작은 신호로 큰 전류를 제어하는 스위치      │
│                                                         │
│  2. BJT vs MOSFET:                                      │
│     - BJT: 전류로 제어, 구식                              │
│     - MOSFET: 전압으로 제어, ESP32에 적합!                 │
│                                                         │
│  3. ESP32에서는 로직 레벨 MOSFET 사용!                     │
│     - 추천: IRLZ44N (3.3V Gate로 완전 ON)                 │
│     - 일반 MOSFET(IRF540)은 3.3V로 제어 불가              │
│                                                         │
│  4. N-채널 MOSFET 연결:                                   │
│     - 부하는 Drain 위 (VCC ~ Drain)                       │
│     - Source는 GND                                       │
│     - Gate에 ESP32 GPIO 연결                              │
│                                                         │
│  5. 필수 저항:                                            │
│     - Gate 직렬 1kΩ (보호)                                │
│     - Gate 풀다운 10kΩ (부팅 시 안전)                      │
│                                                         │
│  6. 모터/릴레이에는 플라이백 다이오드 필수!                  │
│                                                         │
│  7. 히트싱크: P = I² × Rds(on) 계산 후 판단               │
│     - 0.5W 이하: 불필요                                   │
│     - 1W 이상: 필요                                       │
│                                                         │
│  8. 12V와 ESP32의 GND는 반드시 공통 연결!                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

> **다음 학습:** [06. 릴레이](06-relay.md)에서 고전압(AC 220V) 장치를 안전하게 제어하는 방법을 배워봅시다!
