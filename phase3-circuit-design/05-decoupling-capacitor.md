# 05. 디커플링 커패시터 (Decoupling Capacitor)

## 목차
1. [디커플링 커패시터란?](#1-디커플링-커패시터란)
2. [전원 노이즈의 개념](#2-전원-노이즈의-개념)
3. [왜 IC 전원 핀에 커패시터를 붙이는가](#3-왜-ic-전원-핀에-커패시터를-붙이는가)
4. [100nF + 10uF 조합이 흔한 이유](#4-100nf--10uf-조합이-흔한-이유)
5. [배치 규칙](#5-배치-규칙)
6. [디커플링 없을 때 발생하는 문제](#6-디커플링-없을-때-발생하는-문제)
7. [실전 배치 예시](#7-실전-배치-예시)
8. [핵심 정리](#8-핵심-정리)

---

## 1. 디커플링 커패시터란?

### 정의

디커플링 커패시터(Decoupling Capacitor)는 IC(집적회로)의 전원 핀(VCC)과 접지 핀(GND) 사이에 배치하여 **전원 노이즈를 흡수하고 순간적인 전류 수요를 충족**시키는 커패시터입니다.

"디커플링(Decoupling)"이란 "분리한다"는 뜻으로, IC를 전원의 노이즈로부터 **분리(격리)** 시킨다는 의미입니다.

### 소프트웨어 비유

> 디커플링 커패시터는 프로그래밍의 여러 개념과 비슷합니다:
>
> **1. 에러 핸들링 / try-catch:**
> 전원 노이즈(에러)가 IC(코드)에 영향을 주지 않도록 잡아냅니다.
>
> **2. 버퍼(Buffer) / 캐시(Cache):**
> IC가 순간적으로 많은 전류를 필요로 할 때, 커패시터가 미리 저장해둔 전하를 빠르게 공급합니다. 마치 캐시가 디스크 접근 없이 빠르게 데이터를 제공하는 것처럼.
>
> ```python
> # 디커플링 커패시터 = 로컬 캐시
> class PowerSupply:
>     def get_current(self):
>         return self._fetch_from_source()  # 느림, 노이즈 있음
>
> class DecouplingCapacitor:
>     def __init__(self):
>         self.cache = precharge()  # 미리 전하 충전
>
>     def get_current(self):
>         return self.cache  # 빠르고 깨끗한 전원 공급!
> ```

---

## 2. 전원 노이즈의 개념

### 이상적인 전원 vs 실제 전원

```
  이상적인 3.3V 전원:

  전압
  3.3V ────────────────────────────────  ← 완벽하게 일정
       ────────────────────────────────
                    시간


  실제 3.3V 전원:

  전압
  3.5V ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─
       ╱╲  ╱╲     ╱╲╱╲    ╱╲
  3.3V ──╲╱──╲╱─────╲╱──╲╱──╲╱────────  ← 노이즈로 출렁임
  3.1V ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─
                    시간

  이 출렁임이 "전원 노이즈"입니다.
```

### 전원 노이즈의 원인

**원인 1: IC의 순간적 전류 소비 변화**

```
  IC가 동작할 때:

  시간: ──────┬──────┬──────┬──────
              │클럭  │클럭  │클럭
              │상승  │상승  │상승

  전류: ──────╱╲─────╱╲─────╱╲─────
              │      │      │
          순간적으로 많은 전류를 소비
          → 전원선의 저항(기생 저항)에 의해 전압 강하 발생
          → 전원 전압이 순간적으로 떨어짐
```

**원인 2: 전원선의 인덕턴스와 저항**

```
  전원 공급 장치 ────── 긴 전선 ──────── IC
                    ↑                  ↑
              기생 저항(R)         여기서 전원을 사용
              기생 인덕턴스(L)
              → 빠른 전류 변화에 반응이 느림
              → IC가 필요할 때 즉시 전류를 공급하지 못함
```

**원인 3: 다른 부품의 동작**

```
  같은 전원을 공유하는 부품들:

  전원 ──┬── IC1 (MCU)           ← 정밀한 전원 필요
         │
         ├── IC2 (모터 드라이버)   ← 큰 전류 소비, 노이즈 발생원
         │
         └── IC3 (센서)           ← 정밀한 전원 필요

  모터 드라이버가 동작할 때 전원에 노이즈를 일으키면
  MCU와 센서에도 영향 → 오동작 가능
```

---

## 3. 왜 IC 전원 핀에 커패시터를 붙이는가

### 커패시터의 역할: 에너지 저장소 (로컬 캐시)

```
  디커플링 커패시터의 동작:

  [평소 (충전)]

  전원 ──→ 커패시터에 전하 저장 ──→ IC에 안정적 전원 공급
           (캐시 채우기)

           ┌──────┐
  3.3V ──→│ C = Q │──→ IC (VCC)
           └──┬───┘
              │
             GND


  [IC가 순간적으로 많은 전류를 요구할 때]

  전원선은 즉시 대응 못함 (느림, 멀리 있음)
  → 커패시터가 저장해둔 전하를 즉시 방출!
  → IC에 필요한 전류를 빠르게 공급

           ┌──────┐
  3.3V ──→│ C ──→│──→ IC (VCC)  ← 커패시터에서 빠르게 공급!
           └──┬───┘
              │
             GND


  [IC의 전류 요구가 줄어든 후]

  커패시터가 다시 충전 → 다음 순간에 대비

  소프트웨어 비유:
  캐시 히트(Cache Hit) = 커패시터에서 즉시 전류 공급
  캐시 미스(Cache Miss) = 먼 전원에서 전류를 가져와야 함 (느림)
```

### 노이즈 흡수 역할

```
  전원에 노이즈가 있을 때:

  노이즈 있는 전원:    3.3V ~~╱╲~~╲╱~~╱╲~~

       ↓ 커패시터 통과

  깨끗한 전원:         3.3V ──────────────

  커패시터는 고주파 노이즈를 GND로 흘려보내는 필터 역할
  (고주파에서 커패시터의 임피던스가 낮아지는 성질 이용)
```

### 왜 100nF (0.1uF)인가?

```
  커패시터의 임피던스: Xc = 1 / (2π × f × C)

  100nF 커패시터의 주파수별 임피던스:

  주파수        임피던스
  1kHz         1.6kΩ      ← 저주파에는 효과 적음
  10kHz        160Ω
  100kHz       16Ω        ← 효과 있음
  1MHz         1.6Ω       ← 매우 효과적!
  10MHz        0.16Ω      ← 거의 쇼트

  → 100nF은 100kHz ~ 수십 MHz 범위의 노이즈를 효과적으로 제거
  → 이 범위가 대부분의 디지털 IC에서 발생하는 노이즈 주파수
  → 그래서 "일단 100nF을 붙여라"가 기본 규칙이 된 것!
```

---

## 4. 100nF + 10uF 조합이 흔한 이유

### 커패시터 크기별 역할

```
  주파수 범위와 커패시터 크기:

  고주파 노이즈 (MHz)  ────→  작은 커패시터 (100nF, 세라믹)
  중주파 노이즈 (kHz)  ────→  중간 커패시터 (1~10uF)
  저주파 변동 (Hz~kHz) ────→  큰 커패시터 (10~100uF, 전해)

  하나의 커패시터로 모든 주파수를 커버하기 어려움
  → 여러 크기를 조합하여 넓은 범위를 커버!
```

### 100nF + 10uF 조합

```
  IC의 전원 핀 근처 배치:

        VCC
         │
    ┌────┤────┐
    │    │    │
   [C1] [C2]  │
  100nF 10uF  │
    │    │    │
    └────┤────┘
         │
        GND


  C1 (100nF 세라믹):
  - 고주파 노이즈 제거 (100kHz ~ 수십 MHz)
  - IC 바로 옆에 배치 (리드 최소화)
  - 빠른 응답 (순간적 전류 공급)

  C2 (10uF 전해 또는 세라믹):
  - 저주파 변동 흡수 (Hz ~ 수십 kHz)
  - 더 많은 에너지 저장 (큰 전류 변화에 대응)
  - C1보다 약간 멀어도 괜찮음
```

### 주파수 응답 비교

```
  노이즈 제거 효과 (높을수록 좋음):

  효과
   ▲
   │    100nF        10uF         100nF + 10uF (조합)
   │                                ╱──────╲
   │      ╱╲          ╱╲          ╱          ╲
   │    ╱    ╲      ╱    ╲      ╱              ╲
   │  ╱        ╲  ╱        ╲  ╱                  ╲
   │╱            ╲            ╲                    ╲
   └──────────────────────────────────────────────→ 주파수
       10Hz   1kHz   100kHz   10MHz

  → 조합하면 넓은 주파수 범위를 커버할 수 있음!
```

### 실제 부품 선택

| 역할 | 용량 | 타입 | 특징 |
|------|------|------|------|
| 고주파 디커플링 | 100nF (0.1uF) | 세라믹 (MLCC) | 소형, 저렴, 고주파 특성 우수 |
| 벌크(Bulk) 디커플링 | 10uF | 전해 또는 세라믹 | 에너지 저장 크기, 저주파 보상 |
| 추가 (선택) | 1nF | 세라믹 | 매우 고주파 노이즈 (100MHz+) |

> **팁:** 세라믹 커패시터 표기 "104" = 10 x 10^4 pF = 100,000 pF = 100nF = 0.1uF

---

## 5. 배치 규칙

### 규칙 1: IC 전원 핀에 최대한 가까이!

```
  좋은 배치:                         나쁜 배치:

  ┌────────────┐                    ┌────────────┐
  │    IC      │                    │    IC      │
  │  VCC  GND  │                    │  VCC  GND  │
  └──┬────┬───┘                    └──┬────┬───┘
     │    │                           │    │
    [C]   │     ← IC 바로 옆!        │    │
     │    │                           │    │
     └────┘                           │    │
                                     (긴 배선)
                                      │    │
                                     [C]   │   ← IC에서 멀리!
                                      │    │
                                      └────┘

  왜 가까이?
  - 배선이 길면 배선 자체의 인덕턴스(L)가 증가
  - 인덕턴스가 크면 빠른 전류 변화에 대응 못함
  - 디커플링 효과가 크게 감소

  비유: 캐시(L1)가 CPU에 가까이 있어야 빠른 것과 같음
  - 가까운 커패시터 = L1 캐시 (빠름)
  - 먼 커패시터 = 메인 메모리 (느림)
```

### 규칙 2: GND 연결을 짧게

```
  올바른 GND 연결:

  IC [VCC]──[C]──[GND]  IC [GND]
       │              │       │
       └──────────────┴───────┘
              짧은 GND 경로

  커패시터의 GND는 IC의 GND 핀에 최대한 가까이 연결
  → 전류 루프를 최소화
```

### 규칙 3: 전원 핀이 여러 개인 IC

```
  IC에 VCC/GND 핀이 여러 개인 경우:

  ┌──────────────────────┐
  │        IC             │
  │ VCC1  VCC2  VCC3     │
  │ GND1  GND2  GND3     │
  └──┬─────┬─────┬───────┘
     │     │     │
    [C1]  [C2]  [C3]    ← 각 전원 핀마다 100nF
     │     │     │
    GND   GND   GND

  모든 VCC-GND 쌍에 각각 100nF 세라믹 커패시터를 배치!
```

### 규칙 4: 벌크 커패시터는 전원 입구 근처

```
  전체 보드 배치:

  전원 입력 ──[10uF]──┬──[100nF]── IC1
                       │
                       ├──[100nF]── IC2
                       │
                       └──[100nF]── IC3

  10uF (벌크): 전원 입력 근처에 1~2개
  100nF: 각 IC마다 1개씩
```

---

## 6. 디커플링 없을 때 발생하는 문제

### 문제 1: IC의 오동작

```
  증상:
  - 프로그램이 가끔 이상하게 동작
  - 같은 코드인데 때때로 다른 결과
  - 특정 동작(모터, LED 등)을 할 때 MCU가 이상해짐

  원인:
  전원 노이즈 → IC 내부 로직 오판 → 잘못된 연산 결과

  VCC가 순간적으로 2.8V로 떨어지면:
  - 내부 레지스터 값이 변할 수 있음
  - 비트 하나가 뒤집힐 수 있음 (bit flip)
  - 프로그램 카운터가 엉뚱한 주소로 점프할 수 있음
```

### 문제 2: 예기치 않은 리셋

```
  증상:
  - ESP32가 갑자기 재부팅됨
  - "Brownout detector was triggered" 에러 메시지
  - 서보 모터나 릴레이를 동작시킬 때 리셋

  원인:
  큰 전류를 소비하는 부품(모터, 릴레이)이 동작하면
  → 전원 전압이 순간적으로 떨어짐
  → ESP32의 최소 동작 전압(약 2.3V) 아래로 떨어짐
  → 브라운아웃(Brownout) 감지 → 자동 리셋

  전압
  3.3V ──────╲         ╱──────────
              ╲       ╱
  2.3V ─ ─ ─ ─╲─ ─ ╱─ ─ ─ ─ ─ ─  최소 동작 전압
               ╲   ╱
               ╲ ╱  ← 이 순간 리셋 발생!
               시간
         모터 시작
```

### 문제 3: 통신 오류

```
  증상:
  - I2C 통신이 간헐적으로 실패
  - SPI 데이터가 가끔 깨짐
  - UART에서 쓰레기 문자가 섞임

  원인:
  통신 중 전원 노이즈가 발생하면
  → 디지털 신호의 HIGH/LOW 판정이 불안정
  → 비트 오류 발생
  → 통신 프로토콜 에러
```

### 문제 4: ADC 측정값 불안정

```
  증상:
  - analogRead() 값이 계속 흔들림
  - 센서를 연결하지 않아도 값이 변동
  - 노이즈가 많아서 정확한 측정 불가

  원인:
  ADC의 기준 전압(VREF)이 노이즈에 의해 변동
  → 같은 입력이어도 측정값이 달라짐

  해결: ADC 전원 핀에 디커플링 커패시터 추가
```

---

## 7. 실전 배치 예시

### ESP32 디커플링 배치

```
  ESP32 DevKitC 주변 디커플링:

  ┌─────────────────────────────────┐
  │          ESP32 DevKitC          │
  │                                 │
  │  3V3 ●                   GND ● │
  │      │                     │   │
  │     [C1]  100nF           │   │
  │      │                     │   │
  │      └─────────────────────┘   │
  │                                 │
  │  VIN ●                   GND ● │
  │      │                     │   │
  │     [C2]  10uF            │   │
  │      │                     │   │
  │      └─────────────────────┘   │
  └─────────────────────────────────┘

  C1 (100nF): 3.3V 핀과 GND 사이 (고주파 디커플링)
  C2 (10uF):  VIN 핀과 GND 사이 (벌크 디커플링)
```

### 브레드보드에서의 배치

```
  브레드보드 배치 예시:

  (+3.3V) ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  (GND)   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

       열1   열2   열3   열4   열5
  a     │     │     │     │     │
  b    3V3   │     │     │    GND    ← ESP32의 3V3과 GND
  c     │    [C1 100nF]  │     │     ← 세라믹 커패시터
  d     │     │     │    [C2 10uF]   ← 전해 커패시터 (+극성 주의!)
  e     │     │     │     │     │
  ══════════════════════════════════
  f
  g    ● ────점퍼선───→ (+) 레일     ← 3V3을 전원 레일에 연결
  h                  ● ─→ (-) 레일   ← GND를 전원 레일에 연결

  핵심: C1, C2를 ESP32의 전원 핀에 최대한 가까이 배치!
```

### IC 모듈에 디커플링 추가

```
  I2C 센서 모듈 (예: BME280) 디커플링:

  ESP32                      BME280 모듈
  ┌──────┐                  ┌──────────┐
  │ 3V3  ├──────────────────┤ VCC      │
  │      │           ┌──[C]──┤          │
  │ GND  ├───────────┤──────┤ GND      │
  │      │           │      │          │
  │ D21  ├──────────────────┤ SDA      │
  │ D22  ├──────────────────┤ SCL      │
  └──────┘                  └──────────┘

  [C] = 100nF 세라믹 커패시터
  BME280의 VCC-GND 사이, 모듈 가까이 배치
```

### 여러 IC가 있을 때

```
  전원 공급 → 벌크 커패시터 → 각 IC에 로컬 커패시터

  전원 ──[10uF]──┬──[100nF]── ESP32 (VCC─GND)
    입력          │
                  ├──[100nF]── OLED 모듈 (VCC─GND)
                  │
                  ├──[100nF]── BME280 센서 (VCC─GND)
                  │
                  └──[100nF]── SD 카드 모듈 (VCC─GND)

  규칙: IC 하나 = 100nF 하나
```

---

## ESP32 프로젝트에서의 실전 팁

### 1. "일단 붙여라" 원칙

```
  디커플링 커패시터를 빼먹으면:
  → 지금 동작해도 나중에 문제 발생 가능
  → 디버깅이 매우 어려움 (소프트웨어 문제처럼 보임)

  디커플링 커패시터를 붙이면:
  → 100nF 세라믹은 매우 저렴 (개당 수 원)
  → 공간도 거의 차지하지 않음
  → "보험"과 같은 역할

  결론: 의심되면 일단 붙여라!
```

### 2. ESP32 브라운아웃 방지

```cpp
// ESP32에서 자주 보는 에러:
// "Brownout detector was triggered"

// 원인: 전원 전압 순간 강하
// 해결:
// 1. 디커플링 커패시터 추가 (100nF + 10uF)
// 2. 전원 공급 능력이 충분한 USB 포트 사용
// 3. 큰 전류를 쓰는 부품에 별도 전원 공급

// 임시 해결 (브라운아웃 감지 비활성화 - 권장하지 않음):
#include "soc/soc.h"
#include "soc/rtc_cntl_reg.h"

void setup() {
    WRITE_PERI_REG(RTC_CNTL_BROWN_OUT_REG, 0);  // 비활성화
    // 주의: 근본적 해결이 아닌 임시 조치!
    // 하드웨어적으로 디커플링을 추가하는 것이 올바른 해결
}
```

### 3. 전해 커패시터 극성 주의

```
  전해 커패시터에는 극성이 있습니다!

  ┌──────────┐
  │  +  ─    │   ← + 극이 VCC 쪽
  │  │  │    │   ← - 극이 GND 쪽
  │ 10uF    │
  │  16V    │   ← 내압 (정격 전압 이하로 사용)
  └──────────┘

  잘못 연결하면 (역극성):
  → 커패시터 손상
  → 심하면 폭발/팽창 위험!

  세라믹 커패시터 (100nF)는 극성이 없으므로 방향 상관 없음
```

---

## 8. 핵심 정리

```
┌──────────────────────────────────────────────────────────┐
│                디커플링 커패시터 핵심 정리                   │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  1. 디커플링 = IC를 전원 노이즈로부터 격리                  │
│     → 안정적인 동작 보장                                   │
│                                                          │
│  2. 기본 규칙: IC 전원 핀에 100nF 세라믹 커패시터          │
│     IC 하나 = 100nF 하나 (최소)                           │
│                                                          │
│  3. 100nF + 10uF 조합:                                   │
│     100nF = 고주파 노이즈 제거 (세라믹, IC 바로 옆)        │
│     10uF  = 저주파 변동 흡수 (전해, 전원 입구 근처)        │
│                                                          │
│  4. 배치 규칙:                                            │
│     - IC 전원 핀에 최대한 가까이!                          │
│     - GND 연결도 짧게!                                    │
│     - 전원 핀이 여러 개면 각각에 배치                      │
│                                                          │
│  5. 없으면 생기는 문제:                                    │
│     - 오동작, 예기치 않은 리셋 (Brownout)                  │
│     - 통신 오류 (I2C, SPI, UART)                         │
│     - ADC 측정값 불안정                                   │
│                                                          │
│  6. 전해 커패시터는 극성 주의! (+를 VCC에)                  │
│     세라믹 커패시터는 극성 없음                             │
│                                                          │
│  7. 의심되면 일단 붙여라! (100nF은 매우 저렴)              │
│                                                          │
│  소프트웨어 비유:                                         │
│  디커플링 커패시터 = 로컬 캐시 + 에러 핸들링               │
│  - 캐시처럼 빠르게 전류(데이터) 공급                       │
│  - try-catch처럼 노이즈(에러) 흡수                        │
│  - "일단 붙여라" = "일단 에러 핸들링 넣어라"               │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

**다음 장:** [06. 멀티미터 사용법](./06-multimeter.md)에서 멀티미터로 전압, 저항, 통전을 측정하여 회로를 디버깅하는 방법을 학습합니다.
