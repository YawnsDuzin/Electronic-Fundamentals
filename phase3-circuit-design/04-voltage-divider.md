# 04. 전압 분배기 (Voltage Divider)

## 목차
1. [전압 분배기란?](#1-전압-분배기란)
2. [전압 분배기 공식](#2-전압-분배기-공식)
3. [왜 필요한가: 레벨 변환](#3-왜-필요한가-레벨-변환)
4. [실제 계산 예제](#4-실제-계산-예제)
5. [저항값 선택 가이드](#5-저항값-선택-가이드)
6. [전압 분배기의 한계](#6-전압-분배기의-한계)
7. [레벨 시프터와의 비교](#7-레벨-시프터와의-비교)
8. [핵심 정리](#8-핵심-정리)

---

## 1. 전압 분배기란?

### 정의

전압 분배기(Voltage Divider)는 **두 개의 직렬 저항을 사용하여 입력 전압보다 낮은 출력 전압을 만드는 회로**입니다. 가장 기본적이면서도 가장 자주 사용되는 회로 패턴 중 하나입니다.

### 소프트웨어 비유

> 전압 분배기는 프로그래밍의 **타입 캐스팅(type casting)** 또는 **데이터 스케일링**과 같습니다.
>
> ```python
> # 0~255 범위의 값을 0~100 범위로 변환 (스케일링)
> original_value = 200    # 입력 (큰 범위)
> scaled_value = original_value * (100 / 255)  # 출력 (작은 범위)
> # 결과: 78.4
> ```
>
> 전압 분배기도 마찬가지입니다:
> - 입력: 5V (큰 전압)
> - 출력: 3.3V (작은 전압, ESP32에 안전한 범위)

### 기본 회로

```
        Vin (입력 전압)
         │
         │
        [R1]  ← 위쪽 저항
         │
         ●────── Vout (출력 전압)  ← 여기서 전압을 뽑아냄
         │
        [R2]  ← 아래쪽 저항
         │
         │
        GND (0V)
```

---

## 2. 전압 분배기 공식

### 핵심 공식

```
                    R2
  Vout = Vin x ─────────
                 R1 + R2

  Vout : 출력 전압 (R1과 R2 사이에서 측정)
  Vin  : 입력 전압 (전체 회로에 인가되는 전압)
  R1   : 위쪽 저항 (Vin 쪽)
  R2   : 아래쪽 저항 (GND 쪽)
```

### 공식 유도 (옴의 법칙으로)

```
  R1과 R2는 직렬 연결이므로:

  전체 전류:  I = Vin / (R1 + R2)     ← 옴의 법칙

  R2에 걸리는 전압:
  Vout = I × R2
       = (Vin / (R1 + R2)) × R2
       = Vin × R2 / (R1 + R2)         ← 전압 분배기 공식!
```

### 직관적 이해

```
  Vin이 두 저항에 "비례하여" 나눠진다:

  Vin = 10V,  R1 = 7kΩ,  R2 = 3kΩ

       10V
        │
       [R1]  7kΩ  → 전압의 7/10 = 7V가 R1에 걸림
        │
        ● ─── Vout = 3V  (R2가 전체의 3/10이므로)
        │
       [R2]  3kΩ  → 전압의 3/10 = 3V가 R2에 걸림
        │
       GND

  확인: R1 전압(7V) + R2 전압(3V) = Vin(10V) ✓
  Vout = 10V × 3kΩ / (7kΩ + 3kΩ) = 10V × 0.3 = 3V ✓
```

### 특수한 경우들

```
  R1 = R2 일 때:
  Vout = Vin × R / (R + R) = Vin × 1/2 = Vin / 2
  → 입력 전압의 정확히 절반!

  예시: Vin = 5V, R1 = R2 = 10kΩ
  Vout = 5V / 2 = 2.5V


  R1 >> R2 일 때 (R1이 R2보다 훨씬 클 때):
  Vout ≈ 0V  (거의 모든 전압이 R1에 걸림)

  R1 << R2 일 때 (R1이 R2보다 훨씬 작을 때):
  Vout ≈ Vin  (거의 모든 전압이 R2에 걸림)
```

---

## 3. 왜 필요한가: 레벨 변환

### ESP32의 GPIO 전압 제한

```
  ESP32 GPIO 핀의 최대 입력 전압: 3.3V

  ┌──────────────┐
  │              │
  │   ESP32      │ ← 3.3V 로직
  │              │
  │  GPIO 핀 ────│─── 최대 3.3V까지만 안전!
  │              │
  └──────────────┘

  만약 5V를 직접 연결하면?
  → GPIO 핀 손상 가능!
  → ESP32 자체가 고장날 수 있음!
```

### 5V 장치와 ESP32 연결 문제

```
  5V 센서 출력 → ESP32 3.3V 입력

  문제 상황:
  ┌──────────┐              ┌──────────┐
  │  5V 센서  │── 5V 출력 ──│ ESP32    │
  │          │    위험!!     │ GPIO 핀  │ ← 3.3V까지만 안전
  └──────────┘              └──────────┘

  해결: 전압 분배기로 5V → 3.3V 변환
  ┌──────────┐    전압     ┌──────────┐
  │  5V 센서  │── 분배기 ──│ ESP32    │
  │          │  5V→3.3V   │ GPIO 핀  │ ← 안전!
  └──────────┘              └──────────┘
```

### 실제 사용 예

| 상황 | 입력 | 필요 출력 | 설명 |
|------|------|----------|------|
| 5V 센서 → ESP32 | 5V | 3.3V | 센서 출력을 ESP32 입력으로 |
| 배터리 전압 모니터링 | 4.2V (리튬) | ~2.1V | ADC로 배터리 잔량 측정 |
| 12V 신호 → ESP32 | 12V | 3.3V | 자동차 전자장치 신호 읽기 |
| 가변저항 (볼륨) | - | 0~3.3V | 아날로그 입력으로 위치 감지 |

---

## 4. 실제 계산 예제

### 예제 1: 5V → 3.3V 변환

**목표:** 5V 센서 출력을 ESP32(3.3V)에 안전하게 연결

```
  Vin = 5V,  원하는 Vout = 3.3V

  공식: Vout = Vin × R2 / (R1 + R2)
  3.3 = 5 × R2 / (R1 + R2)

  R2 / (R1 + R2) = 3.3 / 5 = 0.66

  R1과 R2의 비율: R2는 전체의 66%, R1은 34%
  → R2/R1 = 0.66/0.34 ≈ 1.94

  실용적 저항 선택:
  R1 = 10kΩ,  R2 = 20kΩ

  검증:
  Vout = 5V × 20kΩ / (10kΩ + 20kΩ)
       = 5V × 20/30
       = 5V × 0.667
       = 3.33V ✓ (3.3V에 매우 근접!)
```

```
  회로도:

     5V (센서 출력)
      │
     [R1]  10kΩ
      │
      ●────── ESP32 GPIO (입력)
      │
     [R2]  20kΩ
      │
     GND

  Vout = 5 × 20k/(10k+20k) = 3.33V ✓
```

### 예제 2: 12V → 3.3V 변환

**목표:** 12V 신호를 ESP32에 안전하게 연결 (예: 차량 전장)

```
  Vin = 12V,  원하는 Vout ≤ 3.3V

  공식: 3.3 = 12 × R2 / (R1 + R2)
  R2 / (R1 + R2) = 3.3 / 12 = 0.275

  실용적 저항 선택:
  R1 = 27kΩ,  R2 = 10kΩ

  검증:
  Vout = 12V × 10kΩ / (27kΩ + 10kΩ)
       = 12V × 10/37
       = 12V × 0.27
       = 3.24V ✓ (3.3V 이하, 안전!)
```

```
  회로도:

     12V (신호)
      │
     [R1]  27kΩ
      │
      ●────── ESP32 GPIO (입력)
      │
     [R2]  10kΩ
      │
     GND

  Vout = 12 × 10k/(27k+10k) = 3.24V ✓
```

### 예제 3: 배터리 전압 모니터링 (4.2V 리튬 배터리)

**목표:** 리튬 배터리(3.0V~4.2V)를 ESP32 ADC로 측정

```
  Vin = 4.2V (만충전),  ESP32 ADC 입력 범위 = 0~3.3V

  R1 = 10kΩ,  R2 = 10kΩ (1:1 분배 = 절반)

  만충전(4.2V): Vout = 4.2V × 10k/(10k+10k) = 2.1V ✓
  방전(3.0V):   Vout = 3.0V × 10k/(10k+10k) = 1.5V ✓

  → 둘 다 3.3V 이하이므로 안전!
  → ADC 값으로 배터리 잔량을 계산할 수 있음
```

```
  회로도:

     배터리(+)  (3.0V ~ 4.2V)
      │
     [R1]  10kΩ
      │
      ●────── ESP32 GPIO36 (ADC 입력)
      │
     [R2]  10kΩ
      │
     GND

  코드에서 실제 전압 계산:
```

```cpp
const int BATTERY_PIN = 36;  // ADC1 채널

void setup() {
    Serial.begin(115200);
    analogReadResolution(12);  // 12비트 ADC (0~4095)
}

void loop() {
    int adcValue = analogRead(BATTERY_PIN);

    // ADC 값 → 전압 변환 (ESP32 ADC: 0~3.3V → 0~4095)
    float voltage_at_pin = (adcValue / 4095.0) * 3.3;

    // 전압 분배기 역산: 실제 배터리 전압 = 핀 전압 × (R1+R2)/R2
    float battery_voltage = voltage_at_pin * (10.0 + 10.0) / 10.0;
    // = voltage_at_pin × 2.0

    Serial.print("ADC: ");
    Serial.print(adcValue);
    Serial.print("  핀 전압: ");
    Serial.print(voltage_at_pin, 2);
    Serial.print("V  배터리 전압: ");
    Serial.print(battery_voltage, 2);
    Serial.println("V");

    delay(1000);
}
```

---

## 5. 저항값 선택 가이드

### 기본 원칙

**전체 저항(R1+R2)은 1kΩ ~ 100kΩ 범위가 적합합니다.**

| R1 + R2 | 장점 | 단점 | 적합한 경우 |
|---------|------|------|-----------|
| 작음 (< 1kΩ) | 노이즈에 강함 | 전류 많이 소비 | - |
| 1kΩ ~ 10kΩ | 균형 잡힌 선택 | - | 대부분의 상황 |
| 10kΩ ~ 100kΩ | 전류 적게 소비 | 고임피던스 장치에 영향 | 저전력 설계 |
| 큼 (> 100kΩ) | 매우 저전력 | 노이즈에 약함, 부정확 | 권장하지 않음 |

### 자주 사용되는 저항 조합

| 목적 | R1 | R2 | Vout (Vin=5V) | 비고 |
|------|-----|-----|-------------|------|
| 5V → 3.3V | 10kΩ | 20kΩ | 3.33V | 가장 일반적 |
| 5V → 3.3V | 1.8kΩ | 3.3kΩ | 3.24V | 저임피던스 |
| 5V → 2.5V | 10kΩ | 10kΩ | 2.5V | 절반 분배 |
| 12V → 3.3V | 27kΩ | 10kΩ | 3.24V | - |
| 12V → 3.3V | 8.2kΩ | 3.3kΩ | 3.43V | 약간 높음 주의 |

### 전류 소비 계산

```
  전압 분배기를 통해 항상 흐르는 전류:

  I = Vin / (R1 + R2)

  예시: Vin = 5V, R1 = 10kΩ, R2 = 20kΩ
  I = 5V / (10kΩ + 20kΩ) = 5V / 30kΩ = 0.167mA

  → 이 전류는 신호가 있든 없든 항상 흐름
  → 배터리 구동 시 고려해야 함
```

---

## 6. 전압 분배기의 한계

### 한계 1: 부하(Load)에 의한 전압 변화

전압 분배기의 출력에 부하(전류를 소비하는 장치)를 연결하면 출력 전압이 떨어집니다.

```
  이상적인 경우 (부하 없음):       부하가 있는 경우:

     5V                              5V
      │                               │
     [R1] 10kΩ                       [R1] 10kΩ
      │                               │
      ●── Vout = 3.33V               ●── Vout = ??? (3.33V보다 낮아짐!)
      │                               │
     [R2] 20kΩ                       [R2] 20kΩ ──┤부하├── GND
      │                               │          (전류 소비)
     GND                             GND

  부하가 R2와 병렬로 연결되면 합성 저항이 작아짐
  → R2 비율이 줄어듬 → Vout이 떨어짐
```

**구체적 예시:**

```
  부하 저항 = 10kΩ일 때:

  R2와 부하의 병렬 합성: R2' = (20k × 10k) / (20k + 10k) = 6.67kΩ
  Vout = 5V × 6.67k / (10k + 6.67k) = 5V × 0.4 = 2.0V

  원래 기대값 3.33V → 실제 2.0V  ← 크게 차이남!
```

> **교훈:** 전압 분배기는 전류를 거의 소비하지 않는 입력(높은 임피던스)에만 적합합니다.
> ESP32 GPIO 입력은 임피던스가 매우 높아서 괜찮지만, 다른 부품의 전원으로 사용하면 안 됩니다.

### 한계 2: 양방향 통신에 사용 불가

```
  전압 분배기는 단방향입니다:

  5V 장치 ──→ [전압 분배기] ──→ 3.3V 장치    ✓ 가능 (입력만)
  5V 장치 ←── [전압 분배기] ←── 3.3V 장치    ✗ 불가 (출력은 안 됨)

  양방향 통신(I2C, SPI 등)에는 전압 분배기를 사용할 수 없습니다.
  → 레벨 시프터를 사용해야 합니다.
```

### 한계 3: 고속 신호에 부적합

```
  저항 + 기생 커패시턴스 = RC 필터 효과

  고속 신호 (예: SPI 클럭 1MHz 이상)에서는:
  - 저항이 신호의 전이(transition) 속도를 늦춤
  - 빠른 HIGH↔LOW 전환이 둔해짐
  - 통신 오류 발생 가능

  권장: 10kHz 이하의 느린 신호에만 사용
```

### 한계 4: 전력 손실

```
  전압 분배기는 항상 전류를 소비합니다:

  P = Vin² / (R1 + R2)
    = 5² / 30kΩ
    = 0.83mW

  작은 양이지만, 배터리 구동 시 쌓일 수 있음
  → 저전력 설계에서는 R1+R2를 크게 (100kΩ 이상) 하거나
  → MOSFET 스위치로 측정할 때만 전원을 넣는 방식 사용
```

---

## 7. 레벨 시프터와의 비교

### 레벨 시프터란?

레벨 시프터(Level Shifter)는 서로 다른 전압 레벨 간의 신호를 **양방향으로** 변환하는 전용 모듈/IC입니다.

### 비교표

| 항목 | 전압 분배기 | 레벨 시프터 |
|------|-----------|-----------|
| 방향 | 단방향 (높은→낮은) | **양방향** |
| 속도 | 느림 (~10kHz) | 빠름 (~10MHz+) |
| 부품 수 | 저항 2개 | IC 1개 + 커패시터 |
| 비용 | 매우 저렴 | 약간 비쌈 |
| 전원 공급 | 불필요 | VCC 양쪽 필요 |
| 정확도 | R 허용오차에 의존 | 정확함 |
| 적합한 용도 | 단순 디지털 입력, ADC | I2C, SPI, UART 양방향 |

### 언제 무엇을 사용할까?

```
  판단 흐름도:

  5V 신호를 3.3V 장치에 연결해야 한다
         │
         ▼
  양방향 통신인가? ──예──→ 레벨 시프터 사용
         │                (I2C, SPI 등)
        아니오
         │
         ▼
  고속 신호인가? ──예──→ 레벨 시프터 사용
  (>10kHz)              (UART 고속 등)
         │
        아니오
         │
         ▼
  단순 디지털 입력 / ADC ──→ 전압 분배기로 충분!
  (버튼, 센서 출력 읽기)
```

### 레벨 시프터 모듈 예시 (참고)

```
  양방향 레벨 시프터 모듈 (BSS138 기반):

  ┌─────────────────────────────┐
  │         Level Shifter       │
  │                             │
  │  LV    LV1 ←→ HV1    HV   │
  │ (3.3V) LV2 ←→ HV2  (5V)  │
  │        LV3 ←→ HV3         │
  │        LV4 ←→ HV4         │
  │  GND               GND     │
  └─────────────────────────────┘

  LV = Low Voltage 쪽 (3.3V, ESP32)
  HV = High Voltage 쪽 (5V, Arduino/센서)
  ←→ = 양방향 자동 변환!
```

---

## 브레드보드 배선 예시

### 5V→3.3V 전압 분배기 배선

```
  (+5V) ━━━━━━━━━━━━━━━━━━━━━━━  ← 5V 전원
  (GND) ━━━━━━━━━━━━━━━━━━━━━━━  ← GND

       열5   열10   열15
  a     ●─R1──●              ← R1(10kΩ): 열5~열10
  b     │     │     │
  c     │     ●─R2──●        ← R2(20kΩ): 열10~열15
  d     │     │     │
  e    점퍼↗  점퍼↗  점퍼↗
  ════════════════════════════
  f     │     │     │
  g    (+5V) GPIO  (GND)
  h    레일  연결   레일

  열5  → (+5V) 전원 레일에서 점퍼선으로 연결
  열10 → ESP32 GPIO 핀에 점퍼선으로 연결 (Vout)
  열15 → GND 레일에 점퍼선으로 연결

  전류 경로: 5V → R1(10kΩ) → R2(20kΩ) → GND
  측정점 (열10): Vout = 5V × 20k/(10k+20k) = 3.33V
```

---

## 8. 핵심 정리

```
┌──────────────────────────────────────────────────────────┐
│                  전압 분배기 핵심 정리                      │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  1. 공식: Vout = Vin × R2 / (R1 + R2)                   │
│                                                          │
│     Vin ──[R1]──●──[R2]── GND                           │
│                 │                                        │
│                Vout                                      │
│                                                          │
│  2. 대표 용도: 5V 센서 출력 → ESP32(3.3V) 입력            │
│     R1 = 10kΩ, R2 = 20kΩ → Vout = 3.33V                │
│                                                          │
│  3. 저항 합계는 1kΩ ~ 100kΩ 범위가 적합                   │
│     작으면: 전류 소비 증가                                 │
│     크면: 노이즈에 약하고 부정확                           │
│                                                          │
│  4. 한계:                                                │
│     - 부하에 의해 출력 전압 변동 (고임피던스 입력에만 사용)  │
│     - 단방향만 가능 (높은→낮은)                            │
│     - 고속 신호에 부적합 (>10kHz)                         │
│     - 항상 전류 소비 (배터리 고려)                         │
│                                                          │
│  5. 양방향 / 고속 필요 → 레벨 시프터 사용                  │
│                                                          │
│  6. 배터리 모니터링: R1=R2=10kΩ로 절반 분배                │
│     → ADC 값에서 역산하여 실제 전압 계산                   │
│                                                          │
│  소프트웨어 비유:                                         │
│  전압 분배기 = 데이터 타입 캐스팅 / 스케일링               │
│  5V(int) → 3.3V(byte) 범위 변환                          │
│  한계: 단방향 변환만 가능 (양방향 = 레벨 시프터)           │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

**다음 장:** [05. 디커플링 커패시터](./05-decoupling-capacitor.md)에서 IC 전원 핀에 커패시터를 붙이는 이유와 올바른 배치 방법을 학습합니다.
