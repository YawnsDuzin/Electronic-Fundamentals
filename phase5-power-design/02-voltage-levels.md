# 02. 3.3V vs 5V 전압 레벨 (Voltage Level Translation)

## 개요

전자 부품들은 서로 다른 전압 레벨에서 동작합니다. ESP32는 **3.3V 로직**을 사용하고,
아두이노 Uno나 많은 센서/모듈은 **5V 로직**을 사용합니다. 이 두 세계를 안전하게
연결하는 방법을 배워봅시다.

```
    ⚠️  가장 흔한 실수 ⚠️
    ─────────────────────────────────────────────
    5V 출력을 ESP32의 3.3V GPIO 핀에 직접 연결
    → ESP32 GPIO 손상 또는 칩 파괴!
    ─────────────────────────────────────────────
```

---

## 1. 로직 레벨이란?

### 1.1 디지털 신호의 HIGH와 LOW

디지털 회로에서 신호는 **HIGH(1)** 또는 **LOW(0)**로 표현됩니다.
이 HIGH와 LOW의 전압 범위가 바로 **로직 레벨(Logic Level)**입니다.

```
    3.3V 로직 시스템              5V 로직 시스템

    3.3V ─── ┬── HIGH(1)         5.0V ─── ┬── HIGH(1)
             │                            │
    2.0V ─── ┤   (HIGH 인식)     3.5V ─── ┤   (HIGH 인식)
             │                            │
             │   불확실 영역              │   불확실 영역
             │                            │
    0.8V ─── ┤   (LOW 인식)      1.5V ─── ┤   (LOW 인식)
             │                            │
    0.0V ─── ┴── LOW(0)          0.0V ─── ┴── LOW(0)
```

### 1.2 로직 레벨 상세 비교

| 파라미터 | 3.3V 로직 (CMOS) | 5V 로직 (TTL) | 의미 |
|----------|-------------------|---------------|------|
| VCC (전원) | 3.3V | 5.0V | 동작 전압 |
| V_OH (출력 HIGH) | ≥ 2.4V | ≥ 2.4V | HIGH 출력 최소값 |
| V_OL (출력 LOW) | ≤ 0.4V | ≤ 0.5V | LOW 출력 최대값 |
| V_IH (입력 HIGH 인식) | ≥ 2.0V | ≥ 2.0V | HIGH로 인식하는 최소 전압 |
| V_IL (입력 LOW 인식) | ≤ 0.8V | ≤ 0.8V | LOW로 인식하는 최대 전압 |

---

## 2. ESP32는 3.3V, 아두이노는 5V

### 2.1 대표적인 3.3V 보드와 5V 보드

| 3.3V 로직 보드 | 5V 로직 보드 |
|----------------|-------------|
| ESP32 | Arduino Uno |
| ESP8266 | Arduino Mega |
| Raspberry Pi (GPIO) | Arduino Nano |
| STM32 (대부분) | Arduino Leonardo |
| nRF52840 | ATmega328P 보드 |

### 2.2 3.3V → 5V: 문제 없는 경우도 있다

3.3V 장치의 HIGH 출력(약 3.3V)은 5V TTL 장치의 HIGH 인식 임계값(2.0V)보다 높습니다.
따라서 **3.3V 출력 → 5V 입력**은 대부분 문제없이 동작합니다.

```
    3.3V 장치 (ESP32)          5V 장치 (아두이노 센서)
    ┌───────────┐              ┌───────────┐
    │           │   3.3V       │           │
    │    GPIO   ├──────────────▶  INPUT    │  ← 3.3V > 2.0V 이므로
    │  (출력)   │   HIGH       │           │     HIGH로 인식됨!
    │           │              │           │
    └───────────┘              └───────────┘

    ✅ 대부분 동작함 (단, CMOS 5V 입력은 안 될 수 있음)
```

### 2.3 5V → 3.3V: 위험!

5V 장치의 HIGH 출력(약 5V)은 3.3V 장치의 최대 허용 전압을 초과합니다.
**ESP32의 GPIO 핀 최대 허용 전압은 3.6V입니다!**

```
    5V 장치                    3.3V 장치 (ESP32)
    ┌───────────┐              ┌───────────┐
    │           │   5.0V       │           │
    │  OUTPUT   ├───── ✖ ──────▶  GPIO     │  ← 5.0V > 3.6V!
    │           │   HIGH       │  (입력)   │     GPIO 손상!
    │           │              │           │
    └───────────┘              └───────────┘

    ❌ 절대 직접 연결하지 마세요!
```

```
    ┌─────────────────────────────────────────────────────┐
    │  ESP32 GPIO 절대 최대 정격 (Absolute Maximum)        │
    │                                                     │
    │  최대 입력 전압: 3.6V                                │
    │  (이를 초과하면 내부 보호 다이오드 파괴 → 칩 손상)    │
    │                                                     │
    │  ※ "잠깐만 연결했는데 괜찮았다"고 해서               │
    │     안전한 것이 아닙니다!                             │
    │     누적 손상으로 나중에 고장날 수 있습니다.          │
    └─────────────────────────────────────────────────────┘
```

---

## 3. 5V 톨러런트 핀(5V Tolerant Pin)이란?

### 3.1 정의

일부 마이크로컨트롤러는 특정 핀이 **5V 톨러런트(5V Tolerant)**로 설계되어 있습니다.
이 핀은 5V 신호를 직접 받아도 손상되지 않습니다.

### 3.2 ESP32의 5V 톨러런트 여부

```
    ┌─────────────────────────────────────────────────────┐
    │                                                     │
    │  ESP32는 5V 톨러런트가 아닙니다!                     │
    │  ──────────────────────────────                      │
    │                                                     │
    │  ESP32의 모든 GPIO 핀은 최대 3.6V까지만 허용합니다.  │
    │  5V 신호를 직접 연결하면 안 됩니다!                  │
    │                                                     │
    │  참고: STM32의 일부 핀은 5V 톨러런트입니다.          │
    │        (데이터시트에 "FT" 표시로 확인)               │
    │                                                     │
    └─────────────────────────────────────────────────────┘
```

### 3.3 5V 톨러런트인 마이크로컨트롤러 예시

| MCU | 5V 톨러런트 | 비고 |
|-----|------------|------|
| ESP32 | **아니오** | 모든 GPIO 3.6V 최대 |
| ESP8266 | **아니오** | 모든 GPIO 3.6V 최대 |
| STM32F103 | 대부분의 핀 | 데이터시트 "FT" 확인 |
| ATmega328P | **예** (5V 구동 시) | 아두이노 Uno의 MCU |
| Raspberry Pi Pico | **아니오** | 3.3V 로직 |

---

## 4. 레벨 시프터 (Level Shifter)

### 4.1 레벨 시프터란?

레벨 시프터는 **한 전압 레벨의 신호를 다른 전압 레벨로 변환**해주는 회로입니다.
3.3V ↔ 5V 변환에 가장 많이 사용됩니다.

### 4.2 단방향 레벨 시프터 vs 양방향 레벨 시프터

| 종류 | 신호 방향 | 사용 사례 | 대표 부품 |
|------|-----------|-----------|-----------|
| **단방향** | 한 방향만 | SPI (MOSI, SCK, CS), 단순 출력 | 74HC4050, 저항 분배기 |
| **양방향** | 양쪽 모두 | I2C (SDA, SCL), UART | BSS138 기반 모듈, TXS0108E |

### 4.3 BSS138 기반 양방향 레벨 시프터 (가장 추천)

가장 널리 사용되는 양방향 레벨 시프터입니다. 저렴하고, I2C/SPI/UART 모두에 사용할 수 있습니다.

```
    BSS138 양방향 레벨 시프터 회로도:

    3.3V (LV)                           5V (HV)
      │                                   │
      ├── 10kΩ ──┬────── 10kΩ ────────────┤
      │          │                        │
      │       ┌──┴──┐                     │
    LV1 ──────┤ BSS138 ├────────────── HV1
              │(N-ch) │
              └──┬──┘
                 │
                GND

    동작 원리:
    ─────────────────────────────────────────
    LV→HV: LV측 HIGH(3.3V) → MOSFET OFF
            → HV측 풀업으로 5V HIGH
    HV→LV: HV측 LOW → MOSFET 바디다이오드
            → LV측도 LOW
    ─────────────────────────────────────────
```

#### 실제 레벨 시프터 모듈 연결

```
    ESP32 (3.3V)          레벨 시프터 모듈          5V 센서
    ┌─────────┐          ┌───────────────┐        ┌─────────┐
    │         │          │ LV    HV      │        │         │
    │ 3.3V ───┼──────────┤ LV    HV  ────┼────────┤ VCC     │
    │         │          │               │        │         │
    │ GPIO 21 ┼──────────┤ LV1   HV1 ────┼────────┤ SDA     │
    │ (SDA)   │          │               │        │         │
    │ GPIO 22 ┼──────────┤ LV2   HV2 ────┼────────┤ SCL     │
    │ (SCL)   │          │               │        │         │
    │ GND ────┼──────────┤ GND   GND ────┼────────┤ GND     │
    │         │          │               │        │         │
    └─────────┘          └───────────────┘        └─────────┘

    ※ LV = Low Voltage (3.3V 측)
       HV = High Voltage (5V 측)
```

### 4.4 TXS0108E 양방향 레벨 시프터

8채널 양방향 레벨 시프터로, 많은 신호를 한 번에 변환할 때 유용합니다.

```
    특징:
    ─────────────────────────
    - 8채널 양방향
    - 자동 방향 감지
    - 최대 110MHz
    - Push-pull 출력
    - I2C에 적합하지 않음!
      (오픈 드레인 아님)

    ⚠️ 주의: I2C에는 BSS138 기반
       레벨 시프터를 사용하세요.
       TXS0108E는 SPI나 패러렐
       인터페이스에 적합합니다.
```

---

## 5. 전압 분배기로 간단히 해결하는 방법

### 5.1 전압 분배기 원리

**전압 분배기(Voltage Divider)**는 두 개의 저항으로 전압을 낮추는 가장 간단한 방법입니다.
단, **입력 신호(5V → 3.3V)에만 사용**할 수 있습니다.

```
    전압 분배기 공식:

    V_out = V_in × R₂ / (R₁ + R₂)
```

### 5.2 5V → 3.3V 전압 분배기 설계

5V를 3.3V로 낮추려면:

```
    V_out = V_in × R₂ / (R₁ + R₂)
    3.3 = 5.0 × R₂ / (R₁ + R₂)

    R₂ / (R₁ + R₂) = 3.3 / 5.0 = 0.66

    → R₁ : R₂ = 1 : 2 (비율)
```

#### 추천 저항값 조합

| R1 | R2 | 출력 전압 | 오차 |
|----|----|-----------|------|
| **1kΩ** | **2kΩ** | **3.33V** | **+0.03V** |
| 1kΩ | 2.2kΩ | 3.44V | +0.14V |
| **10kΩ** | **20kΩ** | **3.33V** | **+0.03V** |
| 4.7kΩ | 10kΩ | 3.40V | +0.10V |
| 1.8kΩ | 3.3kΩ | 3.24V | -0.06V |

> **팁**: R1=1kΩ, R2=2kΩ 조합이 가장 정확하고 구하기 쉽습니다.

### 5.3 전압 분배기 회로도

```
    5V 출력 장치                         ESP32 (3.3V)
    ┌───────────┐                       ┌───────────┐
    │           │         R1 (1kΩ)      │           │
    │  OUTPUT   ├─────┤├───────┬────────▶  GPIO     │
    │           │               │        │  (입력)   │
    └───────────┘         R2 (2kΩ)      │           │
                                ┤├       │           │
                                │        │           │
                               GND      └───────────┘

    상세 회로:

     5V ──── [R1: 1kΩ] ──┬── 3.33V ──── ESP32 GPIO (입력)
                          │
                     [R2: 2kΩ]
                          │
                         GND
```

### 5.4 전압 분배기의 한계

```
    ┌─────────────────────────────────────────────────────┐
    │            전압 분배기 사용 시 주의사항               │
    ├─────────────────────────────────────────────────────┤
    │                                                     │
    │  ✅ 사용 가능한 경우:                                │
    │     - 5V → 3.3V 단방향 입력 신호                    │
    │     - 저속 신호 (수 kHz 이하)                        │
    │     - 단순 디지털 입력                               │
    │     - ADC 입력 전압 조정                             │
    │                                                     │
    │  ❌ 사용하면 안 되는 경우:                            │
    │     - 양방향 통신 (I2C 등)                           │
    │     - 고속 신호 (수 MHz 이상)                        │
    │     - 3.3V → 5V 승압이 필요한 경우                   │
    │     - 전류가 많이 필요한 경우                         │
    │     - SPI의 MISO 라인 등 (출력이 약할 수 있음)       │
    │                                                     │
    │  이유: 저항이 신호를 약화시키고, 기생 커패시턴스와    │
    │        결합하여 고속 신호를 왜곡시킬 수 있음          │
    └─────────────────────────────────────────────────────┘
```

---

## 6. 대표적인 5V/3.3V 혼용 상황과 해결법

### 6.1 상황별 해결법 종합 표

| 상황 | 방향 | 해결 방법 | 난이도 | 비고 |
|------|------|-----------|--------|------|
| 5V UART TX → ESP32 RX | 5V→3.3V 단방향 | 전압 분배기 (R1=1k, R2=2k) | 쉬움 | 가장 흔한 경우 |
| ESP32 TX → 5V UART RX | 3.3V→5V 단방향 | 직접 연결 가능 (대부분) | 매우 쉬움 | TTL 5V는 3.3V를 HIGH로 인식 |
| I2C (SDA, SCL) | 양방향 | BSS138 레벨 시프터 | 보통 | 양방향 필수 |
| SPI MOSI, SCK, CS | 3.3V→5V 단방향 | 직접 연결 또는 74HC4050 | 쉬움 | 마스터가 ESP32인 경우 |
| SPI MISO | 5V→3.3V 단방향 | 전압 분배기 또는 레벨 시프터 | 보통 | 슬레이브의 출력 |
| 5V 센서 디지털 출력 → ESP32 | 5V→3.3V 단방향 | 전압 분배기 | 쉬움 | PIR, 초음파 Echo 등 |
| ESP32 → 5V 릴레이 모듈 | 3.3V→5V 단방향 | 대부분 직접 연결 가능 | 매우 쉬움 | 릴레이 모듈에 트랜지스터 내장 |
| WS2812B LED 데이터 | 3.3V→5V 단방향 | 74HCT125 또는 레벨 시프터 | 보통 | 고속 데이터 라인 |
| ADC 입력 (5V 센서) | 5V→3.3V 단방향 | 전압 분배기 | 쉬움 | ESP32 ADC 최대 3.3V |
| 5V 엔코더 출력 → ESP32 | 5V→3.3V 단방향 | 전압 분배기 | 쉬움 | 로터리 엔코더 |

### 6.2 상황별 상세 해결법

#### 상황 1: UART 통신 (ESP32 ↔ 5V 장치)

```
    ESP32 (3.3V)                    5V 장치 (예: GPS 모듈)
    ┌───────────┐                   ┌───────────┐
    │           │                   │           │
    │  TX ──────┼───────────────────┼──── RX    │  ← 직접 연결 OK
    │           │                   │           │    (3.3V > 2.0V)
    │           │    R1(1kΩ)        │           │
    │  RX ──────┼────┤├────┬────────┼──── TX    │  ← 전압 분배기 필요
    │           │         ┤├ R2     │           │    (5V → 3.3V)
    │           │         (2kΩ)     │           │
    │  GND ─────┼─────────┴─────────┼──── GND   │
    │           │                   │           │
    └───────────┘                   └───────────┘
```

#### 상황 2: I2C 통신 (ESP32 ↔ 5V 센서)

```
    ESP32 (3.3V)     레벨 시프터      5V I2C 센서
    ┌─────────┐    ┌────────────┐    ┌─────────┐
    │ 3.3V ───┼────┤ LV     HV  ├────┼── VCC   │
    │         │    │            │    │         │
    │ SDA ────┼────┤ LV1    HV1 ├────┼── SDA   │
    │         │    │            │    │         │
    │ SCL ────┼────┤ LV2    HV2 ├────┼── SCL   │
    │         │    │            │    │         │
    │ GND ────┼────┤ GND    GND ├────┼── GND   │
    │         │    │            │    │         │
    └─────────┘    └────────────┘    └─────────┘

    ※ I2C는 양방향이므로 반드시 양방향 레벨 시프터 사용!
```

#### 상황 3: HC-SR04 초음파 센서

```
    ESP32 (3.3V)                     HC-SR04 (5V)
    ┌───────────┐                    ┌───────────┐
    │           │                    │           │
    │  VIN(5V) ─┼────────────────────┼── VCC     │
    │           │                    │           │
    │  GPIO ────┼────────────────────┼── TRIG    │  ← 직접 연결 OK
    │  (출력)   │                    │           │    (3.3V로 트리거 가능)
    │           │    R1(1kΩ)         │           │
    │  GPIO ────┼────┤├────┬─────────┼── ECHO    │  ← 전압 분배기 필요!
    │  (입력)   │         ┤├ R2      │           │    (ECHO 출력이 5V)
    │           │         (2kΩ)      │           │
    │  GND ─────┼─────────┴──────────┼── GND     │
    │           │                    │           │
    └───────────┘                    └───────────┘
```

#### 상황 4: WS2812B NeoPixel LED

```
    ESP32 (3.3V)         74HCT125          WS2812B (5V)
    ┌───────────┐       ┌──────────┐       ┌──────────┐
    │           │       │          │       │          │
    │  GPIO ────┼───────┤ IN   OUT ├───────┼── DIN    │
    │  (데이터)  │       │          │       │          │
    │           │       │ VCC(5V)  │       │ VCC(5V)  │
    │           │       │ GND      │       │ GND      │
    └───────────┘       └──────────┘       └──────────┘

    ※ 74HCT125: 3.3V 입력을 5V 출력으로 변환
       WS2812B는 데이터 신호가 VCC×0.7 이상이어야 HIGH 인식
       3.3V < 5V×0.7 = 3.5V 이므로, 레벨 시프터가 필요할 수 있음

    ★ 간단한 대안: 첫 번째 LED의 VCC를 3.3V로 → 3.3V 레벨로 동작
                   두 번째 LED부터는 첫 번째의 출력(3.3V)이 레벨 시프트됨
```

---

## 7. 실전 팁

### 7.1 레벨 변환 방법 선택 가이드

```
    시작
     │
     ▼
    신호 방향이 양방향인가?
     │          │
     예         아니오
     │          │
     ▼          ▼
    BSS138     5V → 3.3V 인가?
    레벨 시프터  │          │
    사용        예         아니오 (3.3V → 5V)
                │          │
                ▼          ▼
              고속 신호?   대부분 직접 연결 가능
               │     │     (5V TTL은 3.3V를
              예     아니오  HIGH로 인식)
               │     │
               ▼     ▼     ※ 단, CMOS 5V 장치는
            레벨   전압      레벨 시프터 필요
            시프터  분배기
            사용   (R1=1k,
                   R2=2k)
```

### 7.2 자주 하는 실수와 주의사항

| 실수 | 결과 | 올바른 방법 |
|------|------|------------|
| 5V ECHO를 ESP32에 직접 연결 | GPIO 손상 | 전압 분배기 사용 |
| I2C에 전압 분배기 사용 | 통신 불안정/실패 | 양방향 레벨 시프터 사용 |
| 전압 분배기 R1, R2 위치 바꿈 | 더 높은 전압 출력 | R1(위), R2(아래) 확인 |
| 풀업 저항 없이 I2C 연결 | 통신 실패 | SDA/SCL에 풀업 저항 추가 |
| GND 연결 안 함 | 신호 왜곡/불통 | 반드시 GND 공유 |

### 7.3 I2C 풀업 저항 참고

```
    I2C 연결에서 풀업 저항의 위치:

    VCC (3.3V 또는 5V)
     │        │
     ├─ 4.7kΩ─┤
     │        │
    SDA      SCL
     │        │
    ┌┴────────┴┐
    │  I2C     │
    │  장치    │
    └──────────┘

    ※ 레벨 시프터 모듈에는 보통 풀업 저항이 내장되어 있음
       별도 풀업이 필요한지 모듈의 스펙을 확인하세요.
```

---

## 8. 전압 레벨 관련 자주 묻는 질문 (FAQ)

### Q1: ESP32의 VIN 핀에 5V를 넣어도 되나요?
**A**: 네, ESP32 개발 보드의 VIN(또는 5V) 핀은 온보드 레귤레이터에 연결되므로 5V를 넣어도
됩니다. 하지만 **GPIO 핀에는 절대 5V를 넣으면 안 됩니다!**

### Q2: 3.3V 센서를 5V 아두이노에 연결해도 되나요?
**A**: 3.3V 센서의 출력은 대부분 5V 아두이노의 HIGH로 인식됩니다. 하지만 5V 아두이노의
출력을 3.3V 센서에 넣으면 센서가 손상될 수 있으므로 주의하세요.

### Q3: 전압 분배기의 저항값은 클수록 좋은가요?
**A**: 저항값이 너무 크면 (예: 100kΩ 이상) 신호가 약해지고 노이즈에 민감해집니다.
저항값이 너무 작으면 전류가 많이 흘러 전력을 낭비합니다. **1kΩ~10kΩ 범위**가 적당합니다.

### Q4: 모든 5V 센서에 레벨 시프터가 필요한가요?
**A**: 아닙니다. 센서의 **출력 신호만 3.3V로 낮추면** 됩니다. ESP32에서 센서로 가는
신호(예: I2C SCL)는 양방향 레벨 시프터가 필요하지만, 단순 디지털 출력(예: PIR 센서)은
전압 분배기로 충분합니다.

---

## 핵심 정리

```
┌─────────────────────────────────────────────────────────┐
│                      핵심 정리                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. ESP32는 3.3V 로직. 최대 GPIO 허용 전압 3.6V         │
│                                                         │
│  2. 5V → ESP32 GPIO 직접 연결 = GPIO 손상!              │
│                                                         │
│  3. 3.3V → 5V (TTL): 대부분 직접 연결 가능              │
│                                                         │
│  4. 5V → 3.3V 단방향: 전압 분배기                       │
│     (R1=1kΩ, R2=2kΩ → 출력 3.33V)                      │
│                                                         │
│  5. 양방향 (I2C 등): BSS138 레벨 시프터 필수             │
│                                                         │
│  6. ESP32는 5V 톨러런트가 아님!                         │
│                                                         │
│  7. GND는 반드시 공유해야 함                             │
│                                                         │
│  8. 의심스러우면 레벨 시프터를 사용하는 것이 안전        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 연습 문제

### 문제 1: 전압 분배기 계산
R1=2.2kΩ, R2=3.3kΩ일 때, 5V 입력에 대한 출력 전압은?

<details>
<summary>정답 보기</summary>

```
V_out = 5.0 × 3.3 / (2.2 + 3.3)
      = 5.0 × 3.3 / 5.5
      = 5.0 × 0.6
      = 3.0V

→ 3.3V보다 약간 낮지만, ESP32가 HIGH로 인식하기에 충분 (>2.0V)
```
</details>

### 문제 2: 어떤 레벨 변환 방법을 사용해야 할까요?
ESP32와 5V LCD1602 (I2C 인터페이스)를 연결하려고 합니다.
전압 분배기로 연결해도 될까요?

<details>
<summary>정답 보기</summary>

```
I2C는 양방향 통신이므로 전압 분배기를 사용하면 안 됩니다!

전압 분배기는 단방향(5V→3.3V)만 가능합니다.
I2C의 SDA 라인은 마스터와 슬레이브 양쪽에서 데이터를
주고받으므로 양방향 레벨 시프터(BSS138 기반)를
사용해야 합니다.

또는, 3.3V용 I2C LCD 모듈을 사용하는 것이 더 간단합니다.
```
</details>

---

> **다음 학습**: [03-regulator-vs-dcdc.md](./03-regulator-vs-dcdc.md) - 레귤레이터와 DC-DC 컨버터의 차이를 알아봅시다.
